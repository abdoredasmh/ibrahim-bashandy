{"version":3,"file":"BookAddModal.vue2.mjs","sources":["../../../../../components/admin/BookAddModal.vue"],"sourcesContent":["<template>\r\n  <!-- Backdrop -->\r\n  <div class=\"fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4\" @click.self=\"closeModal\">\r\n    <!-- Modal Content -->\r\n    <div class=\"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n      <div class=\"p-6\">\r\n        <!-- Header -->\r\n        <div class=\"flex justify-between items-center pb-3 border-b border-gray-200 dark:border-gray-700\">\r\n          <h3 class=\"text-xl font-semibold text-gray-900 dark:text-white\">إضافة كتاب/بحث جديد</h3>\r\n          <button @click=\"closeModal\" class=\"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300\">\r\n            <svg class=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"></path></svg>\r\n          </button>\r\n        </div>\r\n\r\n        <!-- Form -->\r\n        <form @submit.prevent=\"handleSubmit\" class=\"mt-6 space-y-4\">\r\n          <!-- Title -->\r\n          <div>\r\n            <label for=\"book-title\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">العنوان *</label>\r\n            <input type=\"text\" id=\"book-title\" v-model=\"formData.title\" required\r\n                   class=\"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm\">\r\n          </div>\r\n\r\n          <!-- Description -->\r\n          <div>\r\n            <label for=\"book-description\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">الوصف</label>\r\n            <textarea id=\"book-description\" v-model=\"formData.description\" rows=\"3\"\r\n                      class=\"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm\"></textarea>\r\n          </div>\r\n\r\n          <!-- Type (Research/Transcript) -->\r\n          <div class=\"flex space-x-4 rtl:space-x-reverse\">\r\n            <div class=\"flex items-center\">\r\n              <input id=\"is_research\" v-model=\"formData.is_research\" type=\"checkbox\" class=\"h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600\">\r\n              <label for=\"is_research\" class=\"ms-2 block text-sm text-gray-900 dark:text-gray-300\">هل هو بحث؟</label>\r\n            </div>\r\n            <div class=\"flex items-center\">\r\n              <input id=\"is_transcript\" v-model=\"formData.is_transcript\" type=\"checkbox\" class=\"h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600\">\r\n              <label for=\"is_transcript\" class=\"ms-2 block text-sm text-gray-900 dark:text-gray-300\">هل هو تفريغ؟</label>\r\n            </div>\r\n          </div>\r\n\r\n           <!-- Linked Lesson -->\r\n          <div>\r\n            <label for=\"linked-lesson\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">ربط بدرس (اختياري)</label>\r\n            <select id=\"linked-lesson\" v-model=\"formData.linked_lesson_id\"\r\n                    class=\"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm\">\r\n              <option :value=\"null\">-- لا يوجد ربط --</option>\r\n              <option v-for=\"lesson in lessons\" :key=\"lesson.id\" :value=\"lesson.id\">\r\n                {{ lesson.title }}\r\n              </option>\r\n            </select>\r\n             <p v-if=\"!lessons || lessons.length === 0\" class=\"mt-1 text-xs text-yellow-600 dark:text-yellow-400\">\r\n               لا توجد دروس متاحة للربط حاليًا.\r\n             </p>\r\n          </div>\r\n\r\n          <!-- PDF File Upload -->\r\n          <div>\r\n            <label for=\"book-file\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">ملف الكتاب (PDF) *</label>\r\n            <input type=\"file\" id=\"book-file\" @change=\"handleFileChange\" accept=\".pdf\" required\r\n                   class=\"mt-1 block w-full text-sm text-gray-500 dark:text-gray-400\r\n                          file:mr-4 file:py-2 file:px-4\r\n                          file:rounded-full file:border-0\r\n                          file:text-sm file:font-semibold\r\n                          file:bg-indigo-50 file:text-indigo-700\r\n                          hover:file:bg-indigo-100\r\n                          dark:file:bg-gray-600 dark:file:text-gray-200 dark:hover:file:bg-gray-500\">\r\n            <p v-if=\"bookFile\" class=\"mt-1 text-xs text-gray-500 dark:text-gray-400\">الملف المختار: {{ bookFile.name }}</p>\r\n          </div>\r\n\r\n           <!-- Cover Image Upload (Optional - Add if needed) -->\r\n           <!-- يمكنك إضافة حقل رفع صورة الغلاف هنا بنفس طريقة ملف PDF -->\r\n\r\n\r\n          <!-- Error Message -->\r\n          <div v-if=\"errorMessage\" class=\"text-red-600 dark:text-red-400 text-sm\">\r\n            {{ errorMessage }}\r\n          </div>\r\n\r\n          <!-- Actions -->\r\n          <div class=\"pt-4 flex justify-end space-x-2 rtl:space-x-reverse border-t border-gray-200 dark:border-gray-700\">\r\n            <button\r\n              type=\"button\"\r\n              @click=\"closeModal\"\r\n              :disabled=\"formLoading\"\r\n              class=\"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500\"\r\n            >\r\n              إلغاء\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              :disabled=\"formLoading || !bookFile\"\r\n              class=\"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50\"\r\n            >\r\n              <span v-if=\"formLoading\">جاري الحفظ...</span>\r\n              <span v-else>حفظ الكتاب</span>\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, reactive } from 'vue';\r\nimport type { Database } from '~/types/database.types'; // تأكد من صحة المسار\r\n\r\n// تعريف الأنواع\r\ntype Lesson = Database['public']['Tables']['lessons']['Row'];\r\ntype BookInsert = Database['public']['Tables']['books']['Insert'];\r\n\r\n// تعريف Props القادمة من الصفحة الرئيسية\r\nconst props = defineProps<{\r\n  lessons: Lesson[];\r\n}>();\r\n\r\n// تعريف Events التي سيصدرها المكون\r\nconst emit = defineEmits<{\r\n  (e: 'close'): void;\r\n  (e: 'book-added'): void;\r\n}>();\r\n\r\nconst supabase = useSupabaseClient<Database>();\r\n\r\n// حالة تحميل النموذج\r\nconst formLoading = ref(false);\r\n// رسالة الخطأ\r\nconst errorMessage = ref('');\r\n// ملف PDF المختار\r\nconst bookFile = ref<File | null>(null);\r\n\r\n// بيانات النموذج\r\nconst formData = reactive<Omit<BookInsert, 'storage_path'>>({ // Omit storage_path as it comes from upload\r\n  title: '',\r\n  description: '',\r\n  is_research: false,\r\n  is_transcript: false,\r\n  linked_lesson_id: null,\r\n  cover_image_url: null, // يجب إضافة حقل رفع صورة الغلاف إذا أردت استخدامه\r\n});\r\n\r\n// دالة التعامل مع تغيير ملف PDF\r\nfunction handleFileChange(event: Event) {\r\n  const target = event.target as HTMLInputElement;\r\n  if (target.files && target.files[0]) {\r\n    // التحقق من نوع الملف (اختياري ولكن جيد)\r\n    if (target.files[0].type === 'application/pdf') {\r\n      bookFile.value = target.files[0];\r\n      errorMessage.value = ''; // مسح أي خطأ سابق للملف\r\n    } else {\r\n      bookFile.value = null;\r\n      target.value = ''; // مسح اختيار الملف\r\n      errorMessage.value = 'الرجاء اختيار ملف PDF فقط.';\r\n    }\r\n  } else {\r\n    bookFile.value = null;\r\n  }\r\n}\r\n\r\n// دالة إرسال النموذج\r\nasync function handleSubmit() {\r\n  // التحقق من وجود ملف\r\n  if (!bookFile.value) {\r\n    errorMessage.value = 'الرجاء اختيار ملف PDF للكتاب.';\r\n    return;\r\n  }\r\n\r\n  formLoading.value = true;\r\n  errorMessage.value = '';\r\n\r\n  try {\r\n    // 1. رفع ملف PDF إلى Supabase Storage\r\n    const file = bookFile.value;\r\n    const fileExt = file.name.split('.').pop();\r\n    // استخدام اسم فريد للملف (مثال: timestamp + original name)\r\n    const uniqueFileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`; // إزالة الحروف غير الصالحة للمسار\r\n    const filePath = `${uniqueFileName}`; // أو pdfs/${uniqueFileName} - تأكد من أن المجلد يتوافق مع سياسات RLS\r\n\r\n    const { data: uploadData, error: uploadError } = await supabase.storage\r\n      .from('book-files') // <-- تأكد من اسم الـ bucket الصحيح في Supabase\r\n      .upload(filePath, file);\r\n\r\n    if (uploadError) {\r\n      // حاول تقديم رسالة خطأ أكثر وضوحًا\r\n      if (uploadError.message.includes('Duplicate')) {\r\n           throw new Error('حدث خطأ: اسم الملف موجود مسبقًا. حاول إعادة تسمية الملف أو المحاولة مرة أخرى.');\r\n      } else if (uploadError.message.includes('policy')) {\r\n           throw new Error('حدث خطأ في الأذونات عند رفع الملف. تحقق من سياسات التخزين.');\r\n      }\r\n      throw new Error(`خطأ في رفع ملف PDF: ${uploadError.message}`);\r\n    }\r\n\r\n    const uploadedFilePath = uploadData.path; // المسار الفعلي للملف بعد الرفع\r\n\r\n    // (اختياري) رفع صورة الغلاف هنا إذا أضفت الحقل\r\n\r\n\r\n    // 2. تجهيز بيانات الكتاب لإدخالها في قاعدة البيانات\r\n    const bookDataToInsert: BookInsert = {\r\n      ...formData,\r\n      storage_path: uploadedFilePath, // إضافة مسار الملف المرفوع\r\n       // cover_image_url: // أضف مسار أو رابط صورة الغلاف هنا إذا تم رفعها\r\n    };\r\n\r\n     // تحويل القيمة الفارغة في linked_lesson_id إلى null صراحةً\r\n    if (bookDataToInsert.linked_lesson_id === '') {\r\n       bookDataToInsert.linked_lesson_id = null;\r\n    }\r\n\r\n\r\n    // 3. إدخال بيانات الكتاب في جدول 'books'\r\n    const { error: insertError } = await supabase\r\n      .from('books')\r\n      .insert(bookDataToInsert);\r\n\r\n    if (insertError) {\r\n      // حاول حذف الملف الذي تم رفعه إذا فشل الإدخال في قاعدة البيانات (Rollback بسيط)\r\n      try {\r\n          await supabase.storage.from('book-files').remove([uploadedFilePath]);\r\n          console.warn(\"Uploaded file removed due to DB insertion failure.\");\r\n      } catch (removeError: any) {\r\n          console.error(\"Failed to remove uploaded file after DB error:\", removeError.message);\r\n      }\r\n      throw new Error(`خطأ في حفظ بيانات الكتاب: ${insertError.message}`);\r\n    }\r\n\r\n    // 4. نجاح!\r\n    console.log('Book added successfully!');\r\n    // يمكنك إظهار رسالة نجاح (toast)\r\n    emit('book-added'); // إعلام الصفحة الرئيسية بإعادة تحميل القائمة\r\n    emit('close'); // إغلاق المودال\r\n\r\n  } catch (err: any) {\r\n    console.error('Error submitting book form:', err.message);\r\n    errorMessage.value = err.message || 'حدث خطأ غير متوقع.';\r\n  } finally {\r\n    formLoading.value = false;\r\n  }\r\n}\r\n\r\n// دالة إغلاق المودال\r\nfunction closeModal() {\r\n  // لا تقم بإغلاق المودال إذا كان النموذج قيد التحميل\r\n  if (!formLoading.value) {\r\n    emit('close');\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n/* يمكنك إضافة تنسيقات للمودال هنا */\r\n</style>"],"names":[],"mappings":";;;;;;;;;;;AA4HiB,sBAA4B;AAGvC,UAAA,cAAc,IAAI,KAAK;AAEvB,UAAA,eAAe,IAAI,EAAE;AAErB,UAAA,WAAW,IAAiB,IAAI;AAGtC,UAAM,WAAW,SAA2C;AAAA;AAAA,MAC1D,OAAO;AAAA,MACP,aAAa;AAAA,MACb,aAAa;AAAA,MACb,eAAe;AAAA,MACf,kBAAkB;AAAA,MAClB,iBAAiB;AAAA;AAAA,IAAA,CAClB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}