{"version":3,"file":"SendMessageModal.vue2.mjs","sources":["../../../../../components/admin/SendMessageModal.vue"],"sourcesContent":["<template>\r\n  <TransitionRoot appear :show=\"isOpen\" as=\"template\">\r\n    <Dialog as=\"div\" @close=\"closeModal\" class=\"relative z-40\">\r\n       <!-- ... (Backdrop similar to ConfirmationModal) ... -->\r\n       <TransitionChild as=\"template\" enter=\"duration-300 ease-out\" enter-from=\"opacity-0\" enter-to=\"opacity-100\" leave=\"duration-200 ease-in\" leave-from=\"opacity-100\" leave-to=\"opacity-0\">\r\n         <div class=\"fixed inset-0 bg-black/30 backdrop-blur-sm\" />\r\n       </TransitionChild>\r\n\r\n      <div class=\"fixed inset-0 overflow-y-auto\">\r\n        <div class=\"flex min-h-full items-center justify-center p-4 text-center\">\r\n           <TransitionChild as=\"template\" enter=\"duration-300 ease-out\" enter-from=\"opacity-0 scale-95\" enter-to=\"opacity-100 scale-100\" leave=\"duration-200 ease-in\" leave-from=\"opacity-100 scale-100\" leave-to=\"opacity-0 scale-95\">\r\n            <DialogPanel class=\"w-full max-w-lg transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 p-6 text-right shadow-xl transition-all\">\r\n              <DialogTitle as=\"h3\" class=\"text-lg font-medium leading-6 text-gray-900 dark:text-gray-100 mb-4 border-b dark:border-gray-700 pb-3\">\r\n                إرسال رسالة خاصة إلى {{ user?.full_name || user?.auth_email }}\r\n              </DialogTitle>\r\n\r\n              <form @submit.prevent=\"sendMessage\">\r\n                 <div class=\"mt-4 space-y-4\">\r\n                   <div>\r\n                     <label for=\"message-title\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">عنوان الرسالة *</label>\r\n                     <input type=\"text\" id=\"message-title\" v-model=\"messageTitle\" required class=\"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white\" />\r\n                   </div>\r\n                   <div>\r\n                     <label for=\"message-content\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">محتوى الرسالة *</label>\r\n                     <textarea id=\"message-content\" v-model=\"messageContent\" rows=\"6\" required placeholder=\"اكتب رسالتك هنا...\" class=\"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white\"></textarea>\r\n                   </div>\r\n                   <p v-if=\"errorMessage\" class=\"text-sm text-red-600 dark:text-red-400\">{{ errorMessage }}</p>\r\n                 </div>\r\n\r\n                 <div class=\"mt-6 flex justify-start gap-3\">\r\n                    <button\r\n                      type=\"submit\"\r\n                      :disabled=\"isLoading || !messageTitle.trim() || !messageContent.trim()\"\r\n                      class=\"inline-flex justify-center rounded-md border border-transparent bg-indigo-600 px-6 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50\"\r\n                    >\r\n                       <LoadingSpinner v-if=\"isLoading\" class=\"w-5 h-5 text-white -ml-1 mr-2\" />\r\n                      {{ isLoading ? 'جارٍ الإرسال...' : 'إرسال الرسالة' }}\r\n                    </button>\r\n                    <button\r\n                      type=\"button\"\r\n                      class=\"inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800\"\r\n                      @click=\"closeModal\"\r\n                      :disabled=\"isLoading\"\r\n                    >\r\n                      إلغاء\r\n                    </button>\r\n                 </div>\r\n              </form>\r\n            </DialogPanel>\r\n          </TransitionChild>\r\n        </div>\r\n      </div>\r\n    </Dialog>\r\n  </TransitionRoot>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, watch, type PropType } from 'vue';\r\nimport {\r\n  Dialog, DialogPanel, DialogTitle, TransitionRoot, TransitionChild\r\n} from '@headlessui/vue';\r\nimport type { Database, Tables } from '~/types/database.types';\r\nimport { useSupabaseClient } from '#imports';\r\nimport LoadingSpinner from '~/components/LoadingSpinner.vue';\r\n\r\n// Define the user type expected by the modal\r\ntype UserProp = {\r\n    id: string;\r\n    full_name: string | null;\r\n    auth_email?: string | null; // Optional email from auth\r\n} | null;\r\n\r\nconst props = defineProps({\r\n  user: {\r\n    type: Object as PropType<UserProp>,\r\n    required: true,\r\n  },\r\n  modelValue: { // For v-model support\r\n    type: Boolean,\r\n    default: false,\r\n  }\r\n});\r\n\r\nconst emit = defineEmits(['close', 'sent', 'update:modelValue']);\r\n\r\nconst supabase = useSupabaseClient<Database>();\r\nconst isOpen = ref(props.modelValue);\r\nconst messageTitle = ref('');\r\nconst messageContent = ref('');\r\nconst isLoading = ref(false);\r\nconst errorMessage = ref<string | null>(null);\r\n\r\nwatch(() => props.modelValue, (newVal) => {\r\n  isOpen.value = newVal;\r\n  if (newVal) {\r\n    // Reset form when modal opens\r\n    messageTitle.value = '';\r\n    messageContent.value = '';\r\n    errorMessage.value = null;\r\n    isLoading.value = false;\r\n  }\r\n});\r\n\r\nfunction closeModal() {\r\n  if (isLoading.value) return; // Prevent closing while submitting\r\n  isOpen.value = false;\r\n  emit('update:modelValue', false);\r\n  emit('close');\r\n}\r\n\r\nasync function sendMessage() {\r\n  if (!props.user || !messageTitle.value.trim() || !messageContent.value.trim() || isLoading.value) {\r\n      errorMessage.value = \"الرجاء ملء العنوان والمحتوى.\";\r\n      return;\r\n  }\r\n\r\n  isLoading.value = true;\r\n  errorMessage.value = null;\r\n\r\n  try {\r\n      const payload: Omit<Tables<'user_private_messages'>, 'id' | 'created_at' | 'is_read' | 'related_question_id' | 'user_reply_text' | 'user_replied_at' | 'admin_read_reply'> = {\r\n          user_id: props.user.id,\r\n          title: messageTitle.value.trim(),\r\n          content: messageContent.value.trim(),\r\n          source: 'admin_direct_message' // Indicate it's a direct message\r\n      };\r\n\r\n      const { error } = await supabase\r\n          .from('user_private_messages')\r\n          .insert(payload);\r\n\r\n      if (error) throw error;\r\n\r\n      emit('sent', true); // Emit success\r\n      closeModal();\r\n\r\n  } catch (err: any) {\r\n      console.error(\"Error sending private message:\", err);\r\n      errorMessage.value = err.message || \"فشل إرسال الرسالة.\";\r\n      emit('sent', false, errorMessage.value); // Emit failure with message\r\n  } finally {\r\n      isLoading.value = false;\r\n  }\r\n}\r\n</script>"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;AAwEA,UAAM,QAAQ;AAWd,UAAM,OAAO;AAEb,UAAM,WAAW,kBAA4B;AACvC,UAAA,SAAS,IAAI,MAAM,UAAU;AAC7B,UAAA,eAAe,IAAI,EAAE;AACrB,UAAA,iBAAiB,IAAI,EAAE;AACvB,UAAA,YAAY,IAAI,KAAK;AACrB,UAAA,eAAe,IAAmB,IAAI;AAE5C,UAAM,MAAM,MAAM,YAAY,CAAC,WAAW;AACxC,aAAO,QAAQ;AACf,UAAI,QAAQ;AAEV,qBAAa,QAAQ;AACrB,uBAAe,QAAQ;AACvB,qBAAa,QAAQ;AACrB,kBAAU,QAAQ;AAAA,MAAA;AAAA,IACpB,CACD;AAED,aAAS,aAAa;AACpB,UAAI,UAAU,MAAO;AACrB,aAAO,QAAQ;AACf,WAAK,qBAAqB,KAAK;AAC/B,WAAK,OAAO;AAAA,IAAA;AAGd,mBAAe,cAAc;AAC3B,UAAI,CAAC,MAAM,QAAQ,CAAC,aAAa,MAAM,UAAU,CAAC,eAAe,MAAM,KAAK,KAAK,UAAU,OAAO;AAC9F,qBAAa,QAAQ;AACrB;AAAA,MAAA;AAGJ,gBAAU,QAAQ;AAClB,mBAAa,QAAQ;AAEjB,UAAA;AACA,cAAM,UAAuK;AAAA,UACzK,SAAS,MAAM,KAAK;AAAA,UACpB,OAAO,aAAa,MAAM,KAAK;AAAA,UAC/B,SAAS,eAAe,MAAM,KAAK;AAAA,UACnC,QAAQ;AAAA;AAAA,QACZ;AAEM,cAAA,EAAE,MAAU,IAAA,MAAM,SACnB,KAAK,uBAAuB,EAC5B,OAAO,OAAO;AAEnB,YAAI,MAAa,OAAA;AAEjB,aAAK,QAAQ,IAAI;AACN,mBAAA;AAAA,eAEN,KAAU;AACP,gBAAA,MAAM,kCAAkC,GAAG;AACtC,qBAAA,QAAQ,IAAI,WAAW;AAC/B,aAAA,QAAQ,OAAO,aAAa,KAAK;AAAA,MAAA,UACxC;AACE,kBAAU,QAAQ;AAAA,MAAA;AAAA,IACtB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}