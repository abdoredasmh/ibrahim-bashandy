{"version":3,"file":"PdfViewerModal.vue2.mjs","sources":["../../../../components/PdfViewerModal.vue"],"sourcesContent":["<template>\r\n  <ClientOnly>\r\n    <TransitionRoot appear :show=\"show\" as=\"div\">\r\n      <Dialog as=\"div\" @close=\"closeModal\" class=\"relative z-50\">\r\n        <!-- Backdrop -->\r\n        <TransitionChild\r\n          as=\"div\"\r\n          enter=\"duration-300 ease-out\"\r\n          enter-from=\"opacity-0\"\r\n          enter-to=\"opacity-100\"\r\n          leave=\"duration-200 ease-in\"\r\n          leave-from=\"opacity-100\"\r\n          leave-to=\"opacity-0\"\r\n        >\r\n          <div class=\"fixed inset-0 bg-black bg-opacity-60 dark:bg-gray-900 dark:bg-opacity-75\" />\r\n        </TransitionChild>\r\n\r\n        <!-- Modal Container -->\r\n        <div class=\"fixed inset-0 overflow-y-auto\">\r\n          <div class=\"flex min-h-full items-center justify-center p-4 text-center\">\r\n            <TransitionChild\r\n              as=\"div\"\r\n              enter=\"duration-300 ease-out\"\r\n              enter-from=\"opacity-0 scale-95\"\r\n              enter-to=\"opacity-100 scale-100\"\r\n              leave=\"duration-200 ease-in\"\r\n              leave-from=\"opacity-100 scale-100\"\r\n              leave-to=\"opacity-0 scale-95\"\r\n            >\r\n              <!-- Modal Panel -->\r\n              <DialogPanel class=\"w-full max-w-4xl transform overflow-hidden rounded-2xl bg-beige-light dark:bg-cream-gray p-6 text-end shadow-xl transition-all flex flex-col max-h-[90vh]\">\r\n                <!-- Header: Title & Close Button -->\r\n                <DialogTitle as=\"h3\" class=\"text-lg font-medium leading-6 text-brown-dark dark:text-brown-dark mb-4 flex justify-between items-center flex-shrink-0\">\r\n                  <!-- Close Button -->\r\n                  <button\r\n                    type=\"button\"\r\n                    class=\"button-close\"\r\n                    @click=\"closeModal\"\r\n                    aria-label=\"إغلاق العارض\"\r\n                  >\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n                      <title>إغلاق</title>\r\n                      <path fill-rule=\"evenodd\" d=\"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z\" clip-rule=\"evenodd\" />\r\n                    </svg>\r\n                    <span class=\"hidden sm:inline ms-1\">إغلاق</span>\r\n                  </button>\r\n                  <!-- Title -->\r\n                  <span class=\"truncate\">{{ bookTitle || 'عرض المستند' }}</span>\r\n                </DialogTitle>\r\n\r\n                <!-- PDF Viewer Area -->\r\n                <div class=\"mt-2 flex-grow border border-cream-gray dark:border-gray-700 rounded overflow-hidden flex flex-col min-h-[400px]\">\r\n                  <!-- Loading State -->\r\n                  <div v-if=\"loading\" class=\"flex items-center justify-center h-full p-8\" aria-live=\"polite\">\r\n                    <LoadingSpinner />\r\n                    <p class=\"ms-3 text-gray-600 dark:text-gray-400\">جارٍ تحميل الملف...</p>\r\n                  </div>\r\n\r\n                  <!-- Error State -->\r\n                  <div v-else-if=\"pdfUrlError\" class=\"flex flex-col items-center justify-center h-full p-8 text-red-600 dark:text-red-400 text-center\" aria-live=\"assertive\">\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-12 h-12 mb-3 text-red-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n                      <title>خطأ</title>\r\n                      <path fill-rule=\"evenodd\" d=\"M8.257 3.099c.763-1.36 2.683-1.36 3.446 0l6.518 11.636c.75 1.34-.213 3.01-1.723 3.01H3.462c-1.51 0-2.473-1.67-1.723-3.01L8.257 3.1zM11 13a1 1 0 10-2 0 1 1 0 002 0zm-1-6a1 1 0 00-.993.883L9 8v3a1 1 0 001.993.117L11 11V8a1 1 0 00-1-1z\" clip-rule=\"evenodd\" />\r\n                    </svg>\r\n                    <p class=\"font-semibold\">حدث خطأ أثناء تحميل الملف.</p>\r\n                    <p class=\"text-sm text-gray-500 dark:text-gray-400 mt-1\">{{ pdfUrlError }}</p> {/* Display user-friendly error */}\r\n                    <button @click=\"fetchPublicUrl\" class=\"mt-4 button-secondary text-sm\">\r\n                      إعادة المحاولة\r\n                    </button>\r\n                  </div>\r\n\r\n                  <!-- PDF Iframe -->\r\n                  <iframe\r\n                    v-else-if=\"pdfPublicUrl\"\r\n                    :src=\"pdfPublicUrl\"\r\n                    class=\"w-full h-full border-none flex-grow\"\r\n                    frameborder=\"0\"\r\n                    :title=\"`عارض PDF لـ ${bookTitle || 'المستند'}`\"\r\n                    allow=\"fullscreen\"\r\n                    sandbox=\"allow-scripts allow-same-origin allow-popups\"\r\n                  >\r\n                    <p class=\"p-4 text-center text-gray-600 dark:text-gray-400\">متصفحك لا يدعم عرض PDF في إطار. حاول استخدام زر التنزيل.</p>\r\n                  </iframe>\r\n\r\n                  <!-- No File State -->\r\n                  <div v-else class=\"flex items-center justify-center h-full p-8 text-gray-500 dark:text-gray-400\">\r\n                    <p>لم يتم تحديد ملف لعرضه.</p>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- Footer: Download Button -->\r\n                <div class=\"mt-4 text-start flex-shrink-0\">\r\n                  <a\r\n                    v-if=\"pdfPublicUrl && !pdfUrlError\"\r\n                    :href=\"pdfPublicUrl\"\r\n                    target=\"_blank\"\r\n                    download\r\n                    class=\"button-primary\"\r\n                    rel=\"noopener noreferrer\"\r\n                  >\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-5 h-5 me-2\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n                      <title>تنزيل</title>\r\n                      <path fill-rule=\"evenodd\" d=\"M3 14.25A2.25 2.25 0 015.25 12h9.5A2.25 2.25 0 0117 14.25v1.5A2.25 2.25 0 0114.75 18h-9.5A2.25 2.25 0 013 15.75v-1.5zM10 3a.75.75 0 01.75.75v6.19l2.22-2.22a.75.75 0 111.06 1.06l-3.5 3.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 111.06-1.06l2.22 2.22V3.75A.75.75 0 0110 3z\" clip-rule=\"evenodd\" />\r\n                    </svg>\r\n                    <span>تنزيل الملف</span>\r\n                  </a>\r\n                </div>\r\n              </DialogPanel>\r\n            </TransitionChild>\r\n          </div>\r\n        </div>\r\n      </Dialog>\r\n    </TransitionRoot>\r\n  </ClientOnly>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, watch } from 'vue';\r\nimport {\r\n  TransitionRoot,\r\n  TransitionChild,\r\n  Dialog,\r\n  DialogPanel,\r\n  DialogTitle,\r\n} from '@headlessui/vue';\r\nimport type { Database } from '~/types/database.types';\r\nimport type { StorageError } from '@supabase/storage-js'; // Import StorageError type\r\nimport LoadingSpinner from '~/components/LoadingSpinner.vue';\r\n\r\nconst props = defineProps({\r\n  show: Boolean,\r\n  storagePath: String,\r\n  bookTitle: String\r\n});\r\n\r\nconst emit = defineEmits(['close']);\r\n\r\nconst supabase = useSupabaseClient<Database>();\r\nconst pdfPublicUrl = ref<string | null>(null);\r\nconst loading = ref(false);\r\nconst pdfUrlError = ref<string | null>(null); // Will store user-friendly message\r\n\r\nconst BUCKET_NAME = 'book-files';\r\n\r\n// Function to translate storage errors to user-friendly messages\r\nfunction getUserFriendlyErrorMessage(error: StorageError | Error): string {\r\n  console.error('Storage Error:', error); // Log the original error for debugging\r\n\r\n  if ('statusCode' in error) { // Check if it's a StorageError\r\n    switch (error.statusCode) {\r\n      case '404':\r\n        return 'الملف المطلوب غير موجود. قد يكون تم حذفه أو تغيير مساره.';\r\n      case '403':\r\n        return 'ليس لديك الصلاحية للوصول إلى هذا الملف.';\r\n      case '400': // Example for potentially bad path or similar\r\n        return 'حدث خطأ في طلب الملف. يرجى التحقق من صحة الرابط.';\r\n      // Add other common Supabase Storage error codes as needed\r\n      default:\r\n        return `حدث خطأ غير متوقع (${error.statusCode}). يرجى المحاولة مرة أخرى.`;\r\n    }\r\n  }\r\n  // Generic fallback\r\n  return error.message || 'حدث خطأ غير معروف أثناء محاولة الوصول للملف.';\r\n}\r\n\r\nasync function fetchPublicUrl() {\r\n  if (!process.client) return;\r\n\r\n  // Improved check for invalid storagePath\r\n  if (!props.storagePath || props.storagePath.trim() === '') {\r\n    pdfPublicUrl.value = null;\r\n    pdfUrlError.value = 'لم يتم توفير مسار صالح للملف.';\r\n    loading.value = false;\r\n    return;\r\n  }\r\n\r\n  loading.value = true;\r\n  pdfUrlError.value = null;\r\n  pdfPublicUrl.value = null;\r\n\r\n  try {\r\n    const { data, error } = await supabase.storage\r\n      .from(BUCKET_NAME)\r\n      .getPublicUrl(props.storagePath);\r\n\r\n    // Handle Supabase storage error specifically\r\n    if (error) throw error; // Throw the specific StorageError\r\n\r\n    if (!data?.publicUrl) {\r\n      // This case might indicate an issue even without a direct 'error' object\r\n      throw new Error('لم يتم استلام رابط عام صالح للملف من الخادم.');\r\n    }\r\n\r\n    pdfPublicUrl.value = data.publicUrl;\r\n\r\n  } catch (err: any) {\r\n    // Use the helper function to get a user-friendly message\r\n    pdfUrlError.value = getUserFriendlyErrorMessage(err);\r\n    pdfPublicUrl.value = null;\r\n\r\n  } finally {\r\n    loading.value = false;\r\n  }\r\n}\r\n\r\nwatch(() => props.show, (isVisible) => {\r\n  if (isVisible) fetchPublicUrl();\r\n  else {\r\n    // Reset state when modal closes\r\n    pdfPublicUrl.value = null;\r\n    pdfUrlError.value = null;\r\n    loading.value = false;\r\n  }\r\n});\r\n\r\n// Re-fetch if the path changes while the modal is open\r\nwatch(() => props.storagePath, (newPath, oldPath) => {\r\n  if (props.show && newPath !== oldPath && newPath) {\r\n     fetchPublicUrl();\r\n  } else if (props.show && !newPath) {\r\n      // Handle case where path becomes invalid while modal is open\r\n      pdfPublicUrl.value = null;\r\n      pdfUrlError.value = 'تمت إزالة مسار الملف.';\r\n      loading.value = false;\r\n  }\r\n});\r\n\r\nfunction closeModal() {\r\n  emit('close');\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.button-base {\r\n  @apply inline-flex items-center justify-center px-4 py-2 border text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-cream-gray transition-colors duration-200 shadow-sm;\r\n}\r\n\r\n.button-primary {\r\n  @apply button-base border-transparent text-white bg-primary hover:bg-primary-700 focus:ring-primary-500 dark:text-beige-light dark:bg-primary dark:hover:bg-opacity-80;\r\n}\r\n\r\n.button-secondary {\r\n  @apply button-base border-gray-300 dark:border-gray-600 text-brown-dark dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:ring-primary-500;\r\n}\r\n\r\n.button-close {\r\n  @apply inline-flex items-center justify-center rounded-md border border-transparent bg-red-100 dark:bg-red-800 px-3 py-1.5 text-sm font-medium text-red-900 dark:text-red-100 hover:bg-red-200 dark:hover:bg-red-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-cream-gray;\r\n}\r\n\r\niframe {\r\n  display: block;\r\n}\r\n</style>"],"names":[],"mappings":";;;;;;;;;;;;;;AAiIA,UAAM,QAAQ;AAQG,sBAA4B;AACvC,UAAA,eAAe,IAAmB,IAAI;AACtC,UAAA,UAAU,IAAI,KAAK;AACnB,UAAA,cAAc,IAAmB,IAAI;AAyB3C,mBAAe,iBAAiB;AACT;AAAA,IAoCrB;AAGF,UAAM,MAAM,MAAM,MAAM,CAAC,cAAc;AACrC,UAAI,UAA0B,gBAAA;AAAA,WACzB;AAEH,qBAAa,QAAQ;AACrB,oBAAY,QAAQ;AACpB,gBAAQ,QAAQ;AAAA,MAAA;AAAA,IAClB,CACD;AAGD,UAAM,MAAM,MAAM,aAAa,CAAC,SAAS,YAAY;AACnD,UAAI,MAAM,QAAQ,YAAY,WAAW,SAAS;AAChC,uBAAA;AAAA,MACP,WAAA,MAAM,QAAQ,CAAC,SAAS;AAE/B,qBAAa,QAAQ;AACrB,oBAAY,QAAQ;AACpB,gBAAQ,QAAQ;AAAA,MAAA;AAAA,IACpB,CACD;;;;;;;"}