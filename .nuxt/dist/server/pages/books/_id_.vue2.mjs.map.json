{"file":"_id_.vue2.mjs","mappings":";;;;;;;;;;;;;;;;;AAyKA,UAAM,WAAW,kBAA4B;AAC7C,UAAM,QAAQ,SAAS;AAGjB,UAAA,SAAS,SAAS,MAAM;AACpB,YAAA,KAAK,CAAC,MAAM,OAAO;AACzB,aAAO,MAAM,EAAE,KAAK,MAAM,IAAI,KAAK;AAAA,IAAA,CACtC;AAGD,UAAM,gBAAgB,SAAS,MAAM,OAAO,QAAQ,CAAC;AAE/C,UAAA,aAAa,IAAI,KAAK;AACtB,UAAA,YAAY,IAAI,KAAK;AACrB,UAAA,eAAe,IAAmB,IAAI;AAY5C,aAAS,gBAAgB;AACvB,gBAAU,QAAQ;AAAA,IAAA;AAIpB,UAAM,EAAE,MAAM,MAAM,SAAS,OAAO,aAAkB,CAAA,QAAA,SAAA,IAAAA,iBAAA,YAAA;AAAA,MACpD,QAAQ,OAAO,KAAK;AAAA;AAAA,MACpB,YAAY;AACN,YAAA,CAAC,cAAc,OAAO;AACtB,kBAAQ,MAAM,+BAA+B,MAAM,OAAO,EAAE;AAC5D,gBAAM,YAAY,EAAE,YAAY,KAAK,eAAe,yBAAyB;AAAA,QAAA;AAGjF,cAAM,EAAE,MAAM,OAAO,WAAe,IAAA,MAAM,SACvC,KAAK,OAAO,EACZ,OAAO,GAAG,EACV,GAAG,MAAM,OAAO,KAAK,EACrB,YAAY;AAEf,YAAI,YAAY;AACd,kBAAQ,MAAM,0BAA0B,OAAO,KAAK,KAAK,UAAU;AAC7D,gBAAA,YAAY,EAAE,YAAY,KAAK,eAAe,qBAAqB,WAAW,OAAO,IAAI;AAAA,QAAA;AAEjG,YAAI,CAAC,MAAM;AACP,gBAAM,YAAY,EAAE,YAAY,KAAK,eAAe,6BAA6B;AAAA,QAAA;AAIrF,qBAAa,QAAQ;AAGrB,YAAI,KAAK,cAAc;AACf,cAAA;AAEA,kBAAM,aAAa;AACnB,kBAAM,EAAE,MAAM,SAAS,OAAO,SAAa,IAAA,MAAM,SAAS,QACrD,KAAK,UAAU,EACf,aAAa,KAAK,YAAY;AAEnC,gBAAI,SAAgB,OAAA;AACpB,yBAAa,QAAQ,QAAQ;AAAA,mBAExB,QAAa;AAElB,oBAAQ,MAAM,yCAAyC,KAAK,YAAY,KAAK,OAAO,WAAW,MAAM;AAAA,UAAA;AAAA,QAEzG;AAGG,eAAA;AAAA,MACT;AAAA,MACA;AAAA;AAAA,QAEE,OAAO,CAAC,MAAM;AAAA;AAAA;AAAA,MAAA;AAAA,IAIlB,CAAA;AAGM,UAAA,MAAM,CAAC,YAAY;AACrB,iBAAW,QAAQ;AAAA,IAAA,CAEtB;AAID,YAAQ,SAAS,MAAO;;AAAA;AAAA,QACtB,SAAO,UAAK,UAAL,mBAAY,WAAU,QAAQ,QAAQ,aAAc,MAAM,QAAQ,QAAQ;AAAA,QACjF,MAAM;AAAA,UACJ;AAAA,YACE,MAAM;AAAA,YACN,WAAS,gBAAK,UAAL,mBAAY,gBAAZ,mBAAyB,UAAU,GAAG,SAAQ,wBAAsB,UAAK,UAAL,mBAAY,UAAS,gBAAgB;AAAA,UAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QACpH;AAAA;KAMF,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","names":["_withAsyncContext"],"sources":["../../../../../pages/books/[id].vue"],"sourcesContent":["<template>\r\n  <div class=\"container mx-auto px-4 py-8\">\r\n\r\n    <!-- Loading State -->\r\n    <div v-if=\"pending\" class=\"text-center py-20\">\r\n      <LoadingSpinner />\r\n      <p class=\"mt-4 text-gray-600 dark:text-gray-400\">جارٍ تحميل بيانات الكتاب...</p>\r\n    </div>\r\n\r\n    <!-- Error State -->\r\n    <div v-else-if=\"error || !book\" class=\"text-center py-20\">\r\n       <h2 v-if=\"error?.statusCode === 404\" class=\"text-2xl font-semibold text-red-600 dark:text-red-400 mb-4\">\r\n         الكتاب غير موجود\r\n       </h2>\r\n       <h2 v-else class=\"text-2xl font-semibold text-red-600 dark:text-red-400 mb-4\">\r\n         حدث خطأ\r\n       </h2>\r\n       <p class=\"text-gray-600 dark:text-gray-400 mb-6\">\r\n         {{ error?.statusMessage || 'لم نتمكن من العثور على الكتاب المطلوب أو حدث خطأ أثناء تحميله.' }}\r\n       </p>\r\n      <NuxtLink\r\n        to=\"/books\"\r\n        class=\"button-primary\" \r\n      >\r\n        <!-- SVG with Title -->\r\n        <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5 ms-2\" aria-hidden=\"true\">\r\n           <title>العودة</title>\r\n           <path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm-.75-4.75a.75.75 0 0 0 0 1.5h4.59l-2.1 1.95a.75.75 0 1 0 1.02 1.1l3.5-3.25a.75.75 0 0 0 0-1.1l-3.5-3.25a.75.75 0 1 0-1.02 1.1l2.1 1.95H9.25a.75.75 0 0 0 0 1.5Z\" clip-rule=\"evenodd\" />\r\n        </svg>\r\n        <span>العودة إلى المكتبة</span>\r\n      </NuxtLink>\r\n    </div>\r\n\r\n    <!-- Book Details Display -->\r\n    <div v-else class=\"book-details\">\r\n      <div class=\"grid grid-cols-1 md:grid-cols-3 gap-8 mb-8\">\r\n        <!-- Book Cover -->\r\n        <div class=\"md:col-span-1\">\r\n           <div class=\"relative aspect-[3/4] bg-cream-gray dark:bg-gray-700 flex items-center justify-center rounded-lg shadow-md overflow-hidden\"> {/* Added aspect ratio */}\r\n             <img\r\n               v-if=\"book.cover_image_url && !imageError\"\r\n               :src=\"book.cover_image_url\"\r\n               :alt=\"`غلاف ${book.title}`\"\r\n               class=\"w-full h-full object-contain\"\r\n               loading=\"lazy\"\r\n               decoding=\"async\"\r\n               @error=\"handleImageError\"\r\n             />\r\n             <!-- Placeholder SVG with Title -->\r\n             <svg v-else xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"currentColor\" class=\"text-8xl text-gray-400 dark:text-gray-500 w-24 h-24\" aria-hidden=\"true\">\r\n                <title>غلاف كتاب بديل</title>\r\n                <path d=\"M11.25 4.533A9.707 9.707 0 0 0 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.25a.75.75 0 0 0 .5.707A9.735 9.735 0 0 0 6 21a9.707 9.707 0 0 0 5.25-1.533v-1.27a.75.75 0 0 0-.624-.744A8.25 8.25 0 0 1 6 18.75a8.25 8.25 0 0 1-5.25-2.268v-2.156a.75.75 0 0 0 .51-.698A8.217 8.217 0 0 1 6 13.5a8.182 8.182 0 0 1 5.25 1.406v-1.406a8.182 8.182 0 0 1-5.25 1.406 8.217 8.217 0 0 1-4.74-.954.75.75 0 0 0-.51-.698V9.732a8.25 8.25 0 0 1 5.25-2.268 8.25 8.25 0 0 1 5.25 2.268V9.376a.75.75 0 0 0 .624.744v1.27ZM12.75 4.533A9.707 9.707 0 0 1 18 3a9.735 9.735 0 0 1 3.25.555.75.75 0 0 1 .5.707v14.25a.75.75 0 0 1-.5.707A9.735 9.735 0 0 1 18 21a9.707 9.707 0 0 1-5.25-1.533v-1.27a.75.75 0 0 1 .624-.744A8.25 8.25 0 0 0 18 18.75a8.25 8.25 0 0 0 5.25-2.268v-2.156a.75.75 0 0 1-.51-.698A8.217 8.217 0 0 0 18 13.5a8.182 8.182 0 0 0-5.25 1.406v-1.406a8.182 8.182 0 0 0 5.25 1.406 8.217 8.217 0 0 0 4.74-.954.75.75 0 0 1 .51-.698V9.732a8.25 8.25 0 0 0-5.25-2.268 8.25 8.25 0 0 0-5.25 2.268V9.376a.75.75 0 0 1-.624.744v1.27Z\" />\r\n             </svg>\r\n              <!-- Badges -->\r\n              <div class=\"absolute top-3 start-3 flex gap-2\">\r\n                <span v-if=\"book.is_research\" class=\"badge bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 shadow\">\r\n                  بحث\r\n                </span>\r\n                <span v-if=\"book.is_transcript\" class=\"badge bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 shadow\">\r\n                  تفريغ\r\n                </span>\r\n              </div>\r\n           </div>\r\n            <!-- Open/Download Buttons -->\r\n           <div class=\"mt-4 flex flex-col space-y-2\">\r\n               <button\r\n                 v-if=\"book.storage_path\"\r\n                 type=\"button\"\r\n                 @click=\"openPdfModal\"\r\n                 class=\"button-primary w-full\"\r\n               >\r\n                 <!-- SVG with Title -->\r\n                 <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5 me-2\" aria-hidden=\"true\">\r\n                   <title>عرض بالموقع</title>\r\n                   <path d=\"M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z\" />\r\n                   <path fill-rule=\"evenodd\" d=\"M.664 10.59a1.651 1.651 0 0 1 0-1.18l.879-.879a.75.75 0 0 1 1.06 0l.879.879A1.651 1.651 0 0 1 3.482 10c0 .311.102.613.284.879l-.879.879a.75.75 0 0 1-1.06 0l-.879-.879A1.651 1.651 0 0 1 .664 10.59ZM19.336 9.41a1.651 1.651 0 0 1 0 1.18l-.879.879a.75.75 0 0 1-1.06 0l-.879-.879A1.651 1.651 0 0 1 16.518 10c0-.311-.102-.613-.284-.879l.879-.879a.75.75 0 0 1 1.06 0l.879.879A1.651 1.651 0 0 1 19.336 9.41Z\" clip-rule=\"evenodd\" />\r\n                   <path fill-rule=\"evenodd\" d=\"M10 17a7 7 0 1 0 0-14 7 7 0 0 0 0 14Zm-5.017-9.836a.75.75 0 0 1 1.06 0l.879.879a4.652 4.652 0 0 1 6.156 0l.879-.879a.75.75 0 1 1 1.06 1.06l-.879.879a4.652 4.652 0 0 1-6.156 0l-.879-.879a.75.75 0 0 1 0-1.06Z\" clip-rule=\"evenodd\" />\r\n                 </svg>\r\n                 <span>عرض الكتاب بالموقع</span>\r\n               </button>\r\n                <a\r\n                   v-if=\"pdfPublicUrl\"\r\n                   :href=\"pdfPublicUrl\"\r\n                   target=\"_blank\"\r\n                   download\r\n                   class=\"button-secondary w-full\" \r\n                   rel=\"noopener noreferrer\" \r\n                 >\r\n                   <!-- SVG with Title -->\r\n                   <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5 me-2\" aria-hidden=\"true\">\r\n                      <title>تنزيل</title>\r\n                      <path d=\"M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z\" />\r\n                      <path d=\"M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z\" />\r\n                   </svg>\r\n                   <span>تنزيل الملف</span>\r\n                 </a>\r\n                 <p v-if=\"!book.storage_path\" class=\"text-center text-sm text-red-500 dark:text-red-400 mt-2\">\r\n                   ملف الكتاب غير متاح حاليًا للعرض أو التنزيل.\r\n                 </p>\r\n           </div>\r\n        </div>\r\n\r\n        <!-- Book Info -->\r\n        <div class=\"md:col-span-2\">\r\n          <h1 class=\"text-3xl font-bold text-brown-dark dark:text-brown-dark mb-4\">\r\n            {{ book.title }}\r\n          </h1>\r\n           <!-- Link to Original Lesson (for Transcripts) -->\r\n           <div v-if=\"book.is_transcript && book.linked_lesson_id\" class=\"mb-4\">\r\n             <NuxtLink\r\n               :to=\"`/lessons/${book.linked_lesson_id}`\"\r\n               class=\"inline-flex items-center text-sm font-medium text-golden-calm hover:underline focus:outline-none focus:ring-2 focus:ring-golden-calm focus:ring-offset-2 dark:focus:ring-offset-gray-900 rounded\"\r\n             >\r\n               <!-- SVG with Title -->\r\n               <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-4 h-4 me-1\" aria-hidden=\"true\">\r\n                  <title>رابط</title>\r\n                  <path d=\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.665l3-3Z\" />\r\n                  <path d=\"M8.603 17.007a4 4 0 0 0 5.656-5.656l-3-3a4 4 0 0 0-5.865-.225.75.75 0 0 0 1.138.977 2.5 2.5 0 0 1 3.665.142l3 3a2.5 2.5 0 0 1-3.536 3.536l-1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 0 0 5.656 5.656Z\" />\r\n               </svg>\r\n               <span>هذا تفريغ للدرس - اضغط هنا لعرض الدرس الأصلي</span>\r\n             </NuxtLink>\r\n           </div>\r\n\r\n          <div v-if=\"book.description\" class=\"prose prose-lg dark:prose-invert max-w-none text-gray-700 dark:text-gray-300\">\r\n            <!-- Use v-html if description might contain HTML, otherwise keep whitespace-pre-wrap -->\r\n             <p class=\"whitespace-pre-wrap\">{{ book.description }}</p>\r\n             <!-- Or for HTML: <div v-html=\"book.description\"></div> -->\r\n          </div>\r\n           <p v-else class=\"text-gray-500 dark:text-gray-400 italic\">\r\n             لا يوجد وصف متاح لهذا الكتاب.\r\n           </p>\r\n           <!-- TODO: Add more fields here if needed, e.g., author, publisher, date -->\r\n           <!-- Example: -->\r\n           <!-- <div class=\"mt-4 text-sm text-gray-600 dark:text-gray-400\">\r\n                <p v-if=\"book.author\"><strong>المؤلف:</strong> {{ book.author }}</p>\r\n                <p v-if=\"book.publication_year\"><strong>سنة النشر:</strong> {{ book.publication_year }}</p>\r\n           </div> -->\r\n        </div>\r\n      </div>\r\n\r\n      <!-- Comments Section -->\r\n      <CommentSection\r\n        v-if=\"isValidBookId && book\"\r\n        :book-id=\"bookId\"\r\n      />\r\n\r\n    </div>\r\n\r\n    <!-- PDF Viewer Modal -->\r\n    <LazyPdfViewerModal\r\n      :show=\"showModal\"\r\n      :storage-path=\"book?.storage_path || null\"\r\n      :book-title=\"book?.title || 'عرض الكتاب'\"\r\n      @close=\"closePdfModal\"\r\n    />\r\n\r\n  </div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, computed, watch } from 'vue';\r\nimport { useRoute } from 'vue-router';\r\nimport type { Database, Tables } from '~/types/database.types';\r\nimport LoadingSpinner from '~/components/LoadingSpinner.vue';\r\nimport CommentSection from '~/components/CommentSection.vue';\r\nimport LazyPdfViewerModal from '~/components/PdfViewerModal.vue'; // Lazy load modal\r\n\r\ntype Book = Tables<'books'>;\r\n\r\nconst supabase = useSupabaseClient<Database>();\r\nconst route = useRoute();\r\n\r\n// More concise way to get and validate the ID\r\nconst bookId = computed(() => {\r\n    const id = +route.params.id; // Unary plus converts to number, returns NaN if fails\r\n    return isNaN(id) || id <= 0 ? -1 : id; // Return -1 if NaN or not positive\r\n});\r\n\r\n// Helper computed for validity check\r\nconst isValidBookId = computed(() => bookId.value > 0);\r\n\r\nconst imageError = ref(false);\r\nconst showModal = ref(false);\r\nconst pdfPublicUrl = ref<string | null>(null); // To store public URL for download button\r\n\r\nfunction handleImageError() {\r\n  // Optional: Log error\r\n  console.warn(`Failed to load cover image for book ID ${bookId.value}`);\r\n  imageError.value = true;\r\n}\r\n\r\nfunction openPdfModal() {\r\n  showModal.value = true;\r\n}\r\n\r\nfunction closePdfModal() {\r\n  showModal.value = false;\r\n}\r\n\r\n// --- Fetch Book Data ---\r\nconst { data: book, pending, error, refresh } = await useAsyncData<Book | null>(\r\n  `book-${bookId.value}`, // Unique key including the book ID\r\n  async () => {\r\n    if (!isValidBookId.value) {\r\n        console.error('Invalid Book ID from route:', route.params.id);\r\n        throw createError({ statusCode: 400, statusMessage: 'معرف الكتاب غير صالح.' });\r\n    }\r\n\r\n    const { data, error: queryError } = await supabase\r\n      .from('books')\r\n      .select('*')\r\n      .eq('id', bookId.value)\r\n      .maybeSingle();\r\n\r\n    if (queryError) {\r\n      console.error(`Error fetching book ID ${bookId.value}:`, queryError);\r\n      throw createError({ statusCode: 500, statusMessage: `فشل تحميل الكتاب: ${queryError.message}` });\r\n    }\r\n    if (!data) {\r\n        throw createError({ statusCode: 404, statusMessage: 'الكتاب المطلوب غير موجود.' });\r\n    }\r\n\r\n    // Reset public URL before attempting to fetch new one\r\n    pdfPublicUrl.value = null;\r\n\r\n    // --- Pre-fetch public URL for download button ---\r\n    if (data.storage_path) {\r\n        try {\r\n            // Use environment variable for bucket name if possible\r\n            const bucketName = 'book-files'; // Or process.env.SUPABASE_STORAGE_BUCKET\r\n            const { data: urlData, error: urlError } = await supabase.storage\r\n                .from(bucketName)\r\n                .getPublicUrl(data.storage_path);\r\n\r\n            if (urlError) throw urlError;\r\n            pdfPublicUrl.value = urlData.publicUrl;\r\n\r\n        } catch (urlErr: any) {\r\n            // Log this error, but don't block the page load\r\n            console.error(`Failed to get public download URL for ${data.storage_path}:`, urlErr.message || urlErr);\r\n            // pdfPublicUrl remains null, the download button won't render\r\n        }\r\n    }\r\n\r\n    return data;\r\n  },\r\n  {\r\n    // Watch the computed property directly\r\n    watch: [bookId],\r\n    // Use immediate: false if you want to avoid fetching on server if id is invalid initially?\r\n    // Though the check inside the async function handles it.\r\n  }\r\n);\r\n\r\n// Reset dependent state if the book data changes (e.g., navigating between book pages)\r\nwatch(book, (newBook) => {\r\n    imageError.value = false; // Reset image error on book change\r\n    // pdfPublicUrl is already reset within useAsyncData\r\n});\r\n\r\n\r\n// --- SEO Meta ---\r\nuseHead(computed(() => ({\r\n  title: book.value?.title ?? (pending.value ? 'تحميل...' : (error.value ? 'خطأ' : 'تفاصيل الكتاب')),\r\n  meta: [\r\n    {\r\n      name: 'description',\r\n      content: book.value?.description?.substring(0, 150) || `تفاصيل ومعلومات عن ${book.value?.title || 'الكتاب المطلوب'}`\r\n    },\r\n    // Consider adding OpenGraph tags\r\n    // { property: 'og:title', content: book.value?.title },\r\n    // { property: 'og:description', content: book.value?.description?.substring(0, 150) },\r\n    // { property: 'og:image', content: book.value?.cover_image_url },\r\n  ]\r\n})));\r\n\r\n</script>\r\n\r\n<style scoped>\r\n/* Define reusable component classes using @apply */\r\n.badge {\r\n  @apply text-sm font-medium px-3 py-1 rounded-full shadow;\r\n   /* Example: text-xs font-medium px-2.5 py-0.5 rounded; */\r\n}\r\n\r\n.button-base {\r\n @apply inline-flex items-center justify-center px-4 py-2 border text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-900 transition-colors duration-200 shadow-sm;\r\n}\r\n\r\n/* Primary button using the CSS variable defined in tailwind.config.js */\r\n.button-primary {\r\n  @apply button-base border-transparent text-white bg-primary hover:bg-primary-700 focus:ring-primary-500 dark:text-beige-light dark:bg-primary dark:hover:bg-opacity-80;\r\n  /* Adjust hover/focus as needed based on exact color values if primary-700 isn't defined */\r\n}\r\n\r\n/* Secondary/Download button */\r\n.button-secondary {\r\n  @apply button-base border-gray-300 dark:border-gray-600 text-brown-dark dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:ring-primary-500;\r\n}\r\n\r\n/* Tailwind's typography plugin prose adjustments */\r\n.prose :where(p):not(:where([class~=\"not-prose\"] *)) {\r\n    margin-top: 0.5em;\r\n    margin-bottom: 0.5em;\r\n}\r\n\r\n/* Improve image container */\r\n.aspect-\\[3\\/4\\] { /* Common book cover aspect ratio */\r\n    aspect-ratio: 3 / 4;\r\n}\r\n\r\n/* Ensure SVGs scale correctly if needed */\r\nsvg {\r\n    flex-shrink: 0; /* Prevent icons from shrinking in flex layouts */\r\n}\r\n</style>"],"version":3}