{"file":"comments.vue3.mjs","mappings":";;;;;;;;;;;;AAoIA,UAAM,WAAW,kBAA4B;AAKvC,UAAA,WAAW,IAAwB,EAAE;AACrC,UAAA,UAAU,IAAI,KAAK;AACnB,UAAA,QAAQ,IAAkB,IAAI;AAC9B,UAAA,cAAc,IAAI,KAAK;AACvB,UAAA,UAAU,IAAI,IAAI;AACJ,QAAI,CAAC;AACH,QAAwB,IAAI;AAE5C,UAAA,oBAAoB,IAAI,KAAK;AAC7B,UAAA,kBAAkB,IAA6B,IAAI;AA4FnD,UAAA,aAAa,CAAC,eAA8B;AAAA,IAA2C;AAGvF,UAAA,cAAc,CAAC,YAAmE;;AACpF,UAAI,QAAQ,eAAa,aAAQ,YAAR,mBAAiB,QAAO;AAGtC,eAAA,EAAE,IAAI,YAAY,QAAQ,SAAS,IAAI,MAAM,QAAQ,QAAQ,QAAQ,KAAK,GAAG;AAAA,MAC7E,WAAA,QAAQ,aAAW,aAAQ,UAAR,mBAAe,QAAO;AACzC,eAAA,EAAE,IAAI,eAAe,QAAQ,OAAO,IAAI,MAAM,SAAS,QAAQ,MAAM,KAAK,GAAG;AAAA,MAC7E,WAAA,QAAQ,qBAAmB,aAAQ,kBAAR,mBAAuB,QAAO;AACzD,eAAA,EAAE,IAAI,kBAAkB,QAAQ,eAAe,IAAI,MAAM,SAAS,QAAQ,cAAc,KAAK,GAAG;AAAA,MAAA;AAEpG,aAAA;AAAA,IACX;AAQA,UAAM,uBAAuB,YAAY;AACjC,UAAA,CAAC,gBAAgB,MAAO;AAE5B,YAAM,UAAU,gBAAgB;AAChC,cAAQ,aAAa;AACrB,wBAAkB,QAAQ;AAEtB,UAAA;AACA,gBAAQ,IAAI,oBAAoB,QAAQ,EAAE,KAAK;AAC/C,cAAM,EAAE,OAAO,gBAAgB,MAAM,SAChC,KAAK,UAAU,EACf,OAAO,EACP,GAAG,MAAM,QAAQ,EAAE;AAExB,YAAI,YAAmB,OAAA;AAEvB,gBAAQ,IAAI,WAAW,QAAQ,EAAE,wBAAwB;AAEhD,iBAAA,QAAQ,SAAS,MAAM,OAAO,OAAK,EAAE,OAAO,QAAQ,EAAE;AAAA,eAI1D,KAAU;AACf,gBAAQ,MAAM,0BAA0B,QAAQ,EAAE,KAAK,GAAG;AAGnD,cAAA,oBAAoB,IAAI,OAAO,EAAE;AACxC,gBAAQ,aAAa;AAAA,MAAA,UACvB;AACG,wBAAgB,QAAQ;AAElB,cAAA,uBAAuB,SAAS,MAAM,KAAK,OAAK,EAAE,OAAO,QAAQ,EAAE;AACtE,YAAA,2CAA2C,aAAa;AAAA,MAAA;AAAA,IAEpE;AAGQ,YAAA,EAAE,OAAO,mBAAmB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","names":[],"sources":["../../../../../pages/admin/comments.vue"],"sourcesContent":["<template>\r\n  <div class=\"p-4 sm:p-6\">\r\n    <h1 class=\"text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-6\">إدارة التعليقات</h1>\r\n\r\n    <!-- TODO: Add Filters (e.g., by content, user, date, post) -->\r\n\r\n    <!-- Loading State -->\r\n    <div v-if=\"pending && comments.length === 0\" class=\"text-center py-10\">\r\n      <LoadingSpinner />\r\n      <p class=\"mt-3 text-gray-500 dark:text-gray-400\">جارٍ تحميل التعليقات...</p>\r\n    </div>\r\n\r\n    <!-- Error State -->\r\n    <div v-else-if=\"error\" class=\"error-box\">\r\n      <p>حدث خطأ أثناء تحميل التعليقات:</p>\r\n      <pre class=\"mt-2 text-sm\">{{ error.message }}</pre>\r\n      <button @click=\"refreshComments\" class=\"button-secondary mt-4\">إعادة المحاولة</button>\r\n    </div>\r\n\r\n    <!-- Empty State -->\r\n    <div v-else-if=\"comments.length === 0 && !pending\" class=\"text-center py-10 bg-gray-50 dark:bg-gray-800 rounded-lg\">\r\n       <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\" class=\"w-12 h-12 mx-auto text-gray-400\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9.008 9.008 0 0 1-9.887 8.554c-1.197.449-2.52.696-3.888.696C3.04 21.25 0 17.556 0 13c0-4.063 2.368-7.568 5.88-9.105a.75.75 0 0 1 .92.841 8.41 8.41 0 0 0 .454 2.351 .75.75 0 0 1-.687 1.342 9.903 9.903 0 0 1-.547-1.932A8.91 8.91 0 0 0 3.04 13c0 3.54 2.468 6.5 5.88 7.105v-1.05a1.482 1.482 0 0 1 1.488-1.48l.06-.004a8.4 8.4 0 0 0 4.986-7.412 8.36 8.36 0 0 0-.085-1.113.75.75 0 0 1 1.47-.29 9.86 9.86 0 0 1 .053.516c0 2.398-1.054 4.56-2.792 6.056l-.06.004a1.482 1.482 0 0 1-1.488 1.48v1.05c0 .33.116.643.31.887.71.865 1.617 1.568 2.662 2.082A9.008 9.008 0 0 0 21 13a8.91 8.91 0 0 0-2.12-5.88.75.75 0 1 1 1.06-1.061A10.41 10.41 0 0 1 21 13Z\" /></svg>\r\n      <p class=\"mt-3 font-medium text-gray-700 dark:text-gray-300\">لا توجد تعليقات لعرضها حالياً.</p>\r\n    </div>\r\n\r\n    <!-- Comments List -->\r\n    <div v-else class=\"space-y-4\">\r\n      <div\r\n        v-for=\"comment in comments\"\r\n        :key=\"comment.id\"\r\n        class=\"bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700 relative\"\r\n        :class=\"{ 'opacity-50': comment.isDeleting }\"\r\n      >\r\n        <!-- Comment Header: User, Date, Linked Post -->\r\n        <div class=\"flex items-start justify-between mb-2\">\r\n          <div class=\"flex items-center space-x-3 rtl:space-x-reverse\">\r\n             <img :src=\"comment.profiles?.avatar_url || '/images/default-avatar.png'\" alt=\"صورة المستخدم\" class=\"w-8 h-8 rounded-full object-cover bg-gray-200 dark:bg-gray-600\">\r\n            <div>\r\n              <p class=\"text-sm font-semibold text-gray-800 dark:text-gray-200\">{{ comment.profiles?.full_name ?? 'مستخدم غير معروف' }}</p>\r\n              <p class=\"text-xs text-gray-500 dark:text-gray-400\">\r\n                {{ formatDate(comment.created_at) }}\r\n                 <span v-if=\"getPostLink(comment)\" class=\"mx-1\"> - على:\r\n                     <NuxtLink :to=\"getPostLink(comment)?.to || '#'\" class=\"text-primary hover:underline\">\r\n                         {{ getPostLink(comment)?.text || 'منشور' }}\r\n                     </NuxtLink>\r\n                 </span>\r\n              </p>\r\n            </div>\r\n          </div>\r\n           <!-- Actions: Approve/Unapprove (Future), Delete -->\r\n           <div class=\"flex items-center space-x-2 rtl:space-x-reverse flex-shrink-0\">\r\n                <!-- TODO: Add Approve/Unapprove button if needed using comment.is_approved -->\r\n                 <!-- <button\r\n                     @click=\"toggleApproval(comment)\"\r\n                     :disabled=\"comment.isDeleting || comment.isTogglingApproval\"\r\n                     :class=\"['p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors', comment.is_approved ? 'text-green-500 hover:text-green-700' : 'text-yellow-500 hover:text-yellow-700']\"\r\n                     :title=\"comment.is_approved ? 'إلغاء الموافقة' : 'الموافقة على التعليق'\"\r\n                 >\r\n                     <LoadingSpinner v-if=\"comment.isTogglingApproval\" class=\"w-4 h-4\" />\r\n                     <svg v-else-if=\"comment.is_approved\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5\"><path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5z\" clip-rule=\"evenodd\" /></svg>\r\n                     <svg v-else xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5\"><path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm-.75-4.75a.75.75 0 0 0 1.5 0V8.66l1.95 2.1a.75.75 0 1 0 1.1-1.02l-3.25-3.5a.75.75 0 0 0-1.1 0l-3.25 3.5a.75.75 0 1 0 1.1 1.02l1.95-2.1v4.59Z\" clip-rule=\"evenodd\" /></svg>\r\n                 </button> -->\r\n                 <button\r\n                     @click=\"confirmDeleteComment(comment)\"\r\n                     :disabled=\"comment.isDeleting\"\r\n                     class=\"p-1 rounded text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 hover:text-red-700 transition-colors\"\r\n                     title=\"حذف التعليق\"\r\n                 >\r\n                    <LoadingSpinner v-if=\"comment.isDeleting\" class=\"w-4 h-4\" />\r\n                    <svg v-else xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5\">\r\n                        <path fill-rule=\"evenodd\" d=\"M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.58.22-2.325.418C2.38 4.97 1.5 5.647 1.5 6.5V17a3 3 0 0 0 3 3h11a3 3 0 0 0 3-3V6.5c0-.853-.88-1.53-2.175-1.889a48.47 48.47 0 0 0-2.325-.418v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.5.66 1.5 1.5v1.5c0 .84-.66 1.5-1.5 1.5s-1.5-.66-1.5-1.5V5.5C8.5 4.66 9.16 4 10 4ZM4.5 6.5c0-.132.015-.26.043-.386a.75.75 0 0 1 .914-.551 47.14 47.14 0 0 1 8.999.171.75.75 0 0 1 .914.55c.028.127.043.255.043.386V17a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 4.5 17V6.5Z\" clip-rule=\"evenodd\" />\r\n                    </svg>\r\n                 </button>\r\n           </div>\r\n        </div>\r\n\r\n        <!-- Comment Content -->\r\n        <p class=\"text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap\">{{ comment.content }}</p>\r\n\r\n        <!-- TODO: Add reply functionality if needed -->\r\n      </div>\r\n\r\n       <!-- Infinite Scroll Loader/Trigger -->\r\n       <div ref=\"scrollTrigger\" class=\"h-10 flex justify-center items-center\">\r\n           <LoadingSpinner v-if=\"loadingMore\" class=\"w-6 h-6 text-primary\" />\r\n           <span v-if=\"!hasMore && comments.length > 0\" class=\"text-sm text-gray-500 dark:text-gray-400\">لا توجد تعليقات أخرى.</span>\r\n       </div>\r\n    </div>\r\n\r\n     <!-- Confirmation Modal -->\r\n     <ConfirmationModal\r\n       :isOpen=\"showDeleteConfirm\"\r\n       title=\"تأكيد الحذف\"\r\n       message=\"هل أنت متأكد من حذف هذا التعليق؟ لا يمكن التراجع عن هذا الإجراء.\"\r\n       confirmButtonText=\"نعم، حذف\"\r\n       cancelButtonText=\"إلغاء\"\r\n       @confirm=\"executeDeleteComment\"\r\n       @cancel=\"showDeleteConfirm = false\"\r\n     />\r\n\r\n  </div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, onMounted, onUnmounted } from 'vue';\r\nimport { useSupabaseClient, useAsyncData, definePageMeta, useHead } from '#imports';\r\nimport type { Database, Tables } from '~/types/database.types';\r\nimport LoadingSpinner from '~/components/LoadingSpinner.vue';\r\nimport ConfirmationModal from '~/components/ConfirmationModal.vue'; // Ensure this component exists\r\n// TODO: Import notification store\r\n// import { useNotificationStore } from '~/stores/notification';\r\n\r\n// --- تعريف الأنواع ---\r\n// نضيف حقول مؤقتة لحالة الحذف والموافقة\r\ntype CommentWithState = Tables<'comments'> & {\r\n  profiles: Pick<Tables<'profiles'>, 'full_name' | 'avatar_url'> | null;\r\n  // Optional linked post data (add more fields if needed)\r\n  lessons: Pick<Tables<'lessons'>, 'id' | 'title'> | null;\r\n  books: Pick<Tables<'books'>, 'id' | 'title'> | null;\r\n  study_courses: Pick<Tables<'study_courses'>, 'id' | 'title'> | null;\r\n  // State flags\r\n  isDeleting?: boolean;\r\n  // isTogglingApproval?: boolean; // If approval feature is added\r\n};\r\n\r\n// --- حماية الصفحة وتخطيطها ---\r\ndefinePageMeta({\r\n  layout: 'admin',\r\n  middleware: ['admin']\r\n});\r\n\r\n// --- إعدادات ---\r\nconst supabase = useSupabaseClient<Database>();\r\n// const notificationStore = useNotificationStore();\r\nconst ITEMS_PER_PAGE = 30; // عدد التعليقات لكل دفعة تحميل\r\n\r\n// --- الحالة التفاعلية ---\r\nconst comments = ref<CommentWithState[]>([]);\r\nconst pending = ref(false); // حالة التحميل الأولي\r\nconst error = ref<Error | null>(null);\r\nconst loadingMore = ref(false); // حالة تحميل الدفعة التالية\r\nconst hasMore = ref(true);     // هل يوجد المزيد من التعليقات للتحميل؟\r\nconst currentPage = ref(0);     // الصفحة الحالية (تبدأ من 0)\r\nconst scrollTrigger = ref<HTMLElement | null>(null); // عنصر مراقبة التمرير\r\nlet observer: IntersectionObserver | null = null; // مراقب التمرير\r\nconst showDeleteConfirm = ref(false); // حالة عرض مودال التأكيد\r\nconst commentToDelete = ref<CommentWithState | null>(null); // التعليق المراد حذفه\r\n\r\n// --- جلب التعليقات (مع دعم Infinite Scroll) ---\r\nconst loadComments = async (reset: boolean = false) => {\r\n  if (reset) {\r\n    pending.value = true;\r\n    error.value = null;\r\n    currentPage.value = 0;\r\n    comments.value = [];\r\n    hasMore.value = true;\r\n  }\r\n\r\n  if (loadingMore.value || !hasMore.value) return;\r\n\r\n  loadingMore.value = true;\r\n  if (!reset) pending.value = false; // Turn off initial loading state\r\n\r\n  const pageToFetch = currentPage.value;\r\n  const rangeFrom = pageToFetch * ITEMS_PER_PAGE;\r\n  const rangeTo = rangeFrom + ITEMS_PER_PAGE - 1;\r\n\r\n  console.log(`Loading comments page ${pageToFetch + 1} (Range: ${rangeFrom}-${rangeTo})`);\r\n\r\n  try {\r\n    const { data, error: fetchError } = await supabase\r\n      .from('comments')\r\n      .select(`\r\n        *,\r\n        profiles ( full_name, avatar_url ),\r\n        lessons ( id, title ),\r\n        books ( id, title ),\r\n        study_courses ( id, title )\r\n      `)\r\n      .order('created_at', { ascending: false }) // عرض الأحدث أولاً\r\n      .range(rangeFrom, rangeTo);\r\n\r\n    if (fetchError) throw fetchError;\r\n\r\n    const newComments = (data ?? []) as CommentWithState[];\r\n    console.log(`Fetched ${newComments.length} new comments.`);\r\n\r\n    if (reset) {\r\n      comments.value = newComments;\r\n    } else {\r\n      comments.value.push(...newComments);\r\n    }\r\n\r\n    hasMore.value = newComments.length === ITEMS_PER_PAGE;\r\n    currentPage.value += 1;\r\n\r\n  } catch (err: any) {\r\n    console.error(\"Error loading comments:\", err);\r\n    error.value = err;\r\n    hasMore.value = false; // Stop loading on error\r\n  } finally {\r\n    loadingMore.value = false;\r\n    if (reset) pending.value = false;\r\n  }\r\n};\r\n\r\n// --- مراقبة التمرير ---\r\nconst setupIntersectionObserver = () => {\r\n  if (observer) observer.disconnect();\r\n  const options = { rootMargin: '0px 0px 200px 0px' }; // Load slightly before reaching the end\r\n  observer = new IntersectionObserver((entries) => {\r\n    if (entries[0].isIntersecting && !loadingMore.value && hasMore.value) {\r\n      loadComments();\r\n    }\r\n  }, options);\r\n\r\n  if (scrollTrigger.value) {\r\n    observer.observe(scrollTrigger.value);\r\n  }\r\n};\r\n\r\n// --- تحميل الدفعة الأولى وإعداد المراقب ---\r\nonMounted(() => {\r\n  loadComments(true); // Load initial batch\r\n  setupIntersectionObserver();\r\n});\r\n\r\n// --- تنظيف المراقب ---\r\nonUnmounted(() => {\r\n  if (observer) observer.disconnect();\r\n});\r\n\r\n// --- دالة لإعادة تحميل التعليقات (تستخدم عند الخطأ) ---\r\nconst refreshComments = () => {\r\n    loadComments(true);\r\n};\r\n\r\n// --- دوال مساعدة ---\r\nconst formatDate = (dateString: string | null) => { /* ... (نفس دالة التنسيق السابقة) ... */ };\r\n\r\n// دالة لإنشاء رابط للمنشور المرتبط بالتعليق\r\nconst getPostLink = (comment: CommentWithState): { to: string; text: string } | null => {\r\n    if (comment.lesson_id && comment.lessons?.title) {\r\n        // Needs course ID for lesson link - requires joining or fetching course id separately\r\n        // Assuming a fixed path structure for now, ADJUST IF NEEDED\r\n        return { to: `/lessons/${comment.lesson_id}`, text: `درس: ${comment.lessons.title}` };\r\n    } else if (comment.book_id && comment.books?.title) {\r\n        return { to: `/books?open=${comment.book_id}`, text: `كتاب: ${comment.books.title}` }; // Example link\r\n    } else if (comment.study_course_id && comment.study_courses?.title) {\r\n        return { to: `/study/courses/${comment.study_course_id}`, text: `دورة: ${comment.study_courses.title}` };\r\n    }\r\n    return null; // لا يوجد رابط معروف\r\n};\r\n\r\n// --- وظائف حذف التعليق ---\r\nconst confirmDeleteComment = (comment: CommentWithState) => {\r\n    commentToDelete.value = comment;\r\n    showDeleteConfirm.value = true;\r\n};\r\n\r\nconst executeDeleteComment = async () => {\r\n    if (!commentToDelete.value) return;\r\n\r\n    const comment = commentToDelete.value;\r\n    comment.isDeleting = true; // تفعيل حالة الحذف للتعليق المحدد\r\n    showDeleteConfirm.value = false; // إخفاء المودال\r\n\r\n    try {\r\n        console.log(`Deleting comment ${comment.id}...`);\r\n        const { error: deleteError } = await supabase\r\n            .from('comments')\r\n            .delete()\r\n            .eq('id', comment.id);\r\n\r\n        if (deleteError) throw deleteError;\r\n\r\n        console.log(`Comment ${comment.id} deleted successfully.`);\r\n        // إزالة التعليق من القائمة المحلية لتحديث الواجهة فورًا\r\n        comments.value = comments.value.filter(c => c.id !== comment.id);\r\n        // TODO: Show success notification\r\n        // notificationStore.showSuccess('تم حذف التعليق بنجاح.');\r\n\r\n    } catch (err: any) {\r\n        console.error(`Error deleting comment ${comment.id}:`, err);\r\n        // TODO: Show error notification\r\n        // notificationStore.showError(`فشل حذف التعليق: ${err.message}`);\r\n         alert(`فشل حذف التعليق: ${err.message}`); // Placeholder alert\r\n        comment.isDeleting = false; // إلغاء تفعيل حالة الحذف عند الخطأ\r\n    } finally {\r\n         commentToDelete.value = null; // مسح التعليق المحدد للحذف\r\n         // Ensure isDeleting is false even if deletion was successful but element remains somehow\r\n         const deletedCommentInList = comments.value.find(c => c.id === comment.id);\r\n         if(deletedCommentInList) deletedCommentInList.isDeleting = false;\r\n    }\r\n};\r\n\r\n// --- Meta ---\r\nuseHead({ title: 'إدارة التعليقات' });\r\n</script>\r\n\r\n<style scoped>\r\n/* (نفس الأنماط العامة السابقة) */\r\n.error-box {\r\n  @apply p-4 border border-red-300 bg-red-50 text-red-700 rounded-md dark:bg-red-900/30 dark:border-red-700/50 dark:text-red-300;\r\n}\r\n.button-secondary {\r\n  @apply inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-muted disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150;\r\n}\r\n</style>"],"version":3}