{"version":3,"file":"index.vue3.mjs","sources":["../../../../../pages/admin/index.vue"],"sourcesContent":["<template>\r\n  <div class=\"p-4 md:p-6 lg:p-8 bg-gray-50 dark:bg-gray-900 min-h-screen\">\r\n    <div class=\"flex justify-between items-center mb-6\">\r\n      <h1 class=\"text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-200\">\r\n        📊 لوحة الإحصائيات\r\n      </h1>\r\n      <button\r\n        @click=\"forceRefresh\"\r\n        :disabled=\"isLoading\"\r\n        class=\"px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 flex items-center\"\r\n      >\r\n        <svg v-if=\"isLoading\" class=\"animate-spin -ml-1 mr-2 h-5 w-5 text-white\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n          <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n          <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\r\n        </svg>\r\n        <svg v-else xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5 mr-2\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0115.357 2m0 0H15\" />\r\n        </svg>\r\n        {{ isLoading ? 'جاري التحديث...' : 'تحديث' }}\r\n      </button>\r\n    </div>\r\n\r\n    <!-- حالة التحميل الأولية -->\r\n    <div v-if=\"isLoading && !stats.totalUsers\" class=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6\">\r\n      <div v-for=\"n in 12\" :key=\"`skel-${n}`\" class=\"bg-white dark:bg-gray-800 p-4 rounded-lg shadow animate-pulse\">\r\n        <div class=\"h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-3\"></div>\r\n        <div class=\"h-8 bg-gray-300 dark:bg-gray-600 rounded w-1/2\"></div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- حالة الخطأ -->\r\n    <div v-else-if=\"error\" class=\"text-center text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/30 p-6 rounded-lg shadow border border-red-200 dark:border-red-800\">\r\n      <h3 class=\"text-lg font-semibold mb-2\">حدث خطأ!</h3>\r\n      <p class=\"mb-4\">لم نتمكن من جلب بيانات لوحة الإحصائيات.</p>\r\n      <p class=\"text-sm text-gray-600 dark:text-gray-400 mb-4\">الخطأ: {{ error.message || 'غير معروف' }}</p>\r\n      <button\r\n        @click=\"forceRefresh\"\r\n        :disabled=\"isLoading\"\r\n        class=\"px-4 py-2 bg-red-600 text-white rounded-md shadow hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 flex items-center mx-auto\"\r\n      >\r\n        <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5 mr-2\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\">\r\n           <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0115.357 2m0 0H15\" />\r\n        </svg>\r\n        إعادة المحاولة\r\n      </button>\r\n    </div>\r\n\r\n    <!-- عرض الإحصائيات -->\r\n    <div v-else class=\"space-y-8\">\r\n      <!-- قسم المستخدمين والنشاط -->\r\n      <section>\r\n        <h2 class=\"text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300 border-b pb-2 border-gray-300 dark:border-gray-700\">\r\n          المستخدمون والتفاعل\r\n        </h2>\r\n        <div class=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6\">\r\n          <AdminStatCard title=\"إجمالي المستخدمين\" :value=\"stats.totalUsers\" icon=\"users\" link-to=\"/admin/users\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد المستخدمين المسجلين\" />\r\n          <AdminStatCard title=\"إجمالي التعليقات\" :value=\"stats.totalComments\" icon=\"comments\" link-to=\"/admin/comments\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد التعليقات على الدروس\"/>\r\n          <AdminStatCard title=\"التسجيلات بالدورات\" :value=\"stats.totalEnrollments\" icon=\"graduation-cap\" link-to=\"/admin/enrollments\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد مرات تسجيل المستخدمين في الدورات\" />\r\n          <AdminStatCard title=\"إكمالات الدروس\" :value=\"stats.totalCompletions\" icon=\"check-circle\" link-to=\"/admin/completions\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد الدروس التي تم إكمالها بواسطة المستخدمين\"/>\r\n        </div>\r\n      </section>\r\n\r\n      <!-- قسم المحتوى -->\r\n      <section>\r\n        <h2 class=\"text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300 border-b pb-2 border-gray-300 dark:border-gray-700\">\r\n          المحتوى التعليمي\r\n        </h2>\r\n        <div class=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6\">\r\n          <AdminStatCard title=\"إجمالي الكتب\" :value=\"stats.totalBooks\" icon=\"book\" link-to=\"/admin/books\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد الكتب المتاحة\"/>\r\n          <AdminStatCard title=\"إجمالي الدروس\" :value=\"stats.totalLessons\" icon=\"video\" link-to=\"/admin/lessons\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد الدروس المتاحة\"/>\r\n          <AdminStatCard title=\"إجمالي الدورات\" :value=\"stats.totalCourses\" icon=\"chalkboard-teacher\" link-to=\"/admin/courses\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد الدورات التدريبية المتاحة\"/>\r\n          <AdminStatCard title=\"إجمالي الاختبارات\" :value=\"stats.totalQuizzes\" icon=\"question-circle\" link-to=\"/admin/quizzes\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد الاختبارات المتاحة\"/>\r\n        </div>\r\n      </section>\r\n\r\n      <!-- قسم التفاعل والاستفسارات -->\r\n      <section>\r\n        <h2 class=\"text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300 border-b pb-2 border-gray-300 dark:border-gray-700\">\r\n          الاستفسارات والتنبيهات\r\n        </h2>\r\n        <div class=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6\">\r\n          <AdminStatCard title=\"أسئلة للشيخ\" :value=\"stats.totalQuestionsToSheikh\" icon=\"question\" link-to=\"/admin/questions-sheikh\" :is-loading=\"isLoading\" tooltip=\"إجمالي الأسئلة الموجهة للشيخ\"/>\r\n          <AdminStatCard\r\n            title=\"أسئلة بانتظار الرد\"\r\n            :value=\"stats.unansweredQuestions\"\r\n            icon=\"clock\"\r\n            :warning=\"stats.unansweredQuestions !== null && stats.unansweredQuestions > 0\"\r\n            link-to=\"/admin/questions-sheikh?filter=unanswered\"\r\n            :is-loading=\"isLoading\"\r\n            tooltip=\"عدد الأسئلة الموجهة للشيخ ولم يتم الرد عليها بعد\"\r\n           />\r\n          <AdminStatCard\r\n            title=\"إشعارات غير مقروءة\"\r\n            :value=\"stats.unreadNotifications\"\r\n            icon=\"bell\"\r\n            :warning=\"stats.unreadNotifications !== null && stats.unreadNotifications > 0\"\r\n            link-to=\"/admin/notifications\"\r\n            :is-loading=\"isLoading\"\r\n            tooltip=\"عدد الإشعارات الهامة التي لم يتم الاطلاع عليها\"\r\n           />\r\n          <AdminStatCard title=\"محاولات الاختبارات\" :value=\"stats.totalQuizAttempts\" icon=\"file-alt\" link-to=\"/admin/quiz-attempts\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد المحاولات التي أجراها المستخدمون للاختبارات\"/>\r\n        </div>\r\n      </section>\r\n\r\n      <!-- قسم إحصائيات الموقع (اختياري) -->\r\n      <section v-if=\"stats.totalLessonViews !== null || stats.totalBookDownloads !== null\">\r\n         <h2 class=\"text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300 border-b pb-2 border-gray-300 dark:border-gray-700\">\r\n           إحصائيات الموقع\r\n         </h2>\r\n         <div class=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6\">\r\n           <AdminStatCard v-if=\"stats.totalLessonViews !== null\" title=\"مشاهدات الدروس\" :value=\"stats.totalLessonViews\" icon=\"eye\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد مرات مشاهدة الدروس\"/>\r\n           <AdminStatCard v-if=\"stats.totalBookDownloads !== null\" title=\"تحميلات الكتب\" :value=\"stats.totalBookDownloads\" icon=\"download\" :is-loading=\"isLoading\" tooltip=\"إجمالي عدد مرات تحميل الكتب\"/>\r\n           <!-- أضف المزيد حسب الحاجة -->\r\n         </div>\r\n      </section>\r\n\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, onMounted } from 'vue';\r\nimport { useSupabaseClient } from '#imports' // Nuxt 3 auto-import\r\nimport type { Database } from '~/types/database.types'; // Adjust path if needed\r\nimport type { PostgrestError } from '@supabase/supabase-js';\r\nimport AdminStatCard from '~/components/admin/AdminStatCard.vue'; // Adjust path if needed\r\n\r\n// تحديد نوع الإحصائيات\r\ninterface DashboardStats {\r\n  totalUsers: number | null;\r\n  totalComments: number | null;\r\n  totalEnrollments: number | null;\r\n  totalCompletions: number | null;\r\n  totalBooks: number | null;\r\n  totalLessons: number | null;\r\n  totalCourses: number | null;\r\n  totalQuizzes: number | null;\r\n  totalQuestionsToSheikh: number | null;\r\n  unansweredQuestions: number | null;\r\n  unreadNotifications: number | null;\r\n  totalQuizAttempts: number | null;\r\n  totalLessonViews: number | null;\r\n  totalBookDownloads: number | null;\r\n}\r\n\r\n// Layout & Middleware\r\ndefinePageMeta({\r\n  layout: 'admin',\r\n  middleware: 'admin' // Assuming 'admin' middleware handles auth\r\n});\r\n\r\nconst supabase = useSupabaseClient<Database>();\r\nconst stats = ref<DashboardStats>({\r\n  totalUsers: null,\r\n  totalComments: null,\r\n  totalEnrollments: null,\r\n  totalCompletions: null,\r\n  totalBooks: null,\r\n  totalLessons: null,\r\n  totalCourses: null,\r\n  totalQuizzes: null,\r\n  totalQuestionsToSheikh: null,\r\n  unansweredQuestions: null,\r\n  unreadNotifications: null,\r\n  totalQuizAttempts: null,\r\n  totalLessonViews: null,\r\n  totalBookDownloads: null,\r\n});\r\nconst isLoading = ref(true);\r\nconst error = ref<Error | PostgrestError | null>(null);\r\nconst lastFetched = ref<number | null>(null);\r\nconst CACHE_DURATION_MS = 5 * 60 * 1000; // 5 دقائق كاش\r\n\r\n// دالة لجلب العد بشكل فعال وآمن\r\nasync function fetchCount(\r\n    tableName: keyof Database['public']['Tables'],\r\n    filter?: (query: any) => any\r\n): Promise<number> {\r\n  try {\r\n    let query = supabase.from(tableName).select('*', { count: 'exact', head: true });\r\n    if (filter) {\r\n      query = filter(query);\r\n    }\r\n    const { count, error: countError } = await query;\r\n\r\n    if (countError) {\r\n      console.error(`Supabase count error for ${tableName}:`, countError.message);\r\n      // لا ترمي الخطأ هنا، فقط أرجع قيمة تدل على الفشل ليتم التعامل معها في Promise.allSettled\r\n      throw countError; // ارمِ الخطأ ليتم التقاطه بواسطة allSettled\r\n    }\r\n    return count ?? 0;\r\n  } catch (err: any) {\r\n    console.error(`Unexpected error fetching count for ${tableName}:`, err);\r\n    // ارمِ الخطأ ليتم التقاطه\r\n    throw err instanceof Error ? err : new Error(`Failed to fetch count for ${tableName}`);\r\n  }\r\n}\r\n\r\n// دالة لجلب جميع الإحصائيات مع معالجة الأخطاء والكاش\r\nasync function fetchAllStats(force = false) {\r\n  const now = Date.now();\r\n  // التحقق من الكاش إلا إذا كان التحديث إجباريًا\r\n  if (!force && lastFetched.value && (now - lastFetched.value < CACHE_DURATION_MS)) {\r\n    console.log(\"Using cached stats.\");\r\n    return; // استخدم البيانات الموجودة في الكاش\r\n  }\r\n\r\n  isLoading.value = true;\r\n  error.value = null; // إعادة تعيين الخطأ\r\n\r\n  // تعريف المهام مع مفاتيحها لتسهيل الربط\r\n  const tasks = [\r\n    { key: 'totalUsers', promise: fetchCount('profiles') },\r\n    { key: 'totalComments', promise: fetchCount('comments') },\r\n    { key: 'totalEnrollments', promise: fetchCount('course_enrollments') },\r\n    { key: 'totalCompletions', promise: fetchCount('lesson_completions') },\r\n    { key: 'totalBooks', promise: fetchCount('books') },\r\n    { key: 'totalLessons', promise: fetchCount('lessons') },\r\n    { key: 'totalCourses', promise: fetchCount('study_courses') },\r\n    { key: 'totalQuizzes', promise: fetchCount('quizzes') },\r\n    { key: 'totalQuestionsToSheikh', promise: fetchCount('questions_to_sheikh') },\r\n    { key: 'unansweredQuestions', promise: fetchCount('questions_to_sheikh', q => q.eq('is_answered', false)) },\r\n    { key: 'unreadNotifications', promise: fetchCount('notifications', q => q.eq('is_read', false).is('user_id', null)) }, // .is('user_id', null) لتحديد الاشعارات العامة ربما؟ أو إزالته إذا كانت لكل المستخدمين\r\n    { key: 'totalQuizAttempts', promise: fetchCount('quiz_attempts') },\r\n    // إحصائيات اختيارية\r\n    { key: 'totalLessonViews', promise: fetchCount('site_stats', q => q.eq('type', 'lesson_view')) },\r\n    { key: 'totalBookDownloads', promise: fetchCount('site_stats', q => q.eq('type', 'book_download')) },\r\n  ];\r\n\r\n  try {\r\n    const results = await Promise.allSettled(tasks.map(task => task.promise));\r\n    let firstError: Error | PostgrestError | null = null;\r\n\r\n    results.forEach((result, index) => {\r\n      const taskKey = tasks[index].key as keyof DashboardStats;\r\n\r\n      if (result.status === 'fulfilled') {\r\n        stats.value[taskKey] = result.value;\r\n      } else {\r\n        // سجل الخطأ للإحصائية المحددة\r\n        console.error(`Failed to fetch stat for ${taskKey}:`, result.reason);\r\n        stats.value[taskKey] = null; // اعرض null عند الفشل\r\n        // سجل أول خطأ يحدث لعرضه للمستخدم\r\n        if (!firstError) {\r\n          firstError = result.reason instanceof Error ? result.reason : new Error(String(result.reason));\r\n        }\r\n      }\r\n    });\r\n\r\n    if (firstError) {\r\n        error.value = firstError; // اعرض الخطأ العام الأول الذي حدث\r\n    } else {\r\n        lastFetched.value = Date.now(); // تم التحديث بنجاح، سجل وقت الجلب\r\n    }\r\n\r\n  } catch (err: any) {\r\n     // هذا الـ catch لالتقاط أخطاء غير متوقعة جداً (نادر مع allSettled)\r\n     console.error(\"An unexpected error occurred outside Promise.allSettled:\", err);\r\n     if (!error.value) error.value = err instanceof Error ? err : new Error(\"Unknown error during fetching process\");\r\n  } finally {\r\n    isLoading.value = false;\r\n  }\r\n}\r\n\r\n// دالة لإجبار التحديث وتجاوز الكاش\r\nfunction forceRefresh() {\r\n  lastFetched.value = null; // مسح وقت الجلب الأخير لإجبار التحديث\r\n  fetchAllStats(true);\r\n}\r\n\r\n// جلب البيانات عند تحميل المكون\r\nonMounted(() => {\r\n  fetchAllStats();\r\n});\r\n</script>\r\n\r\n<style scoped>\r\n/* إضافة انتقالات بسيطة للبطاقات */\r\n.grid > * {\r\n  transition: all 0.3s ease-in-out;\r\n}\r\n.grid > *:hover {\r\n  transform: translateY(-4px);\r\n  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);\r\n}\r\n\r\n/* تخصيص إضافي إذا لزم الأمر */\r\n</style>"],"names":[],"mappings":";;;;;;;;;AAuJiB,sBAA4B;AAC7C,UAAM,QAAQ,IAAoB;AAAA,MAChC,YAAY;AAAA,MACZ,eAAe;AAAA,MACf,kBAAkB;AAAA,MAClB,kBAAkB;AAAA,MAClB,YAAY;AAAA,MACZ,cAAc;AAAA,MACd,cAAc;AAAA,MACd,cAAc;AAAA,MACd,wBAAwB;AAAA,MACxB,qBAAqB;AAAA,MACrB,qBAAqB;AAAA,MACrB,mBAAmB;AAAA,MACnB,kBAAkB;AAAA,MAClB,oBAAoB;AAAA,IAAA,CACrB;AACK,UAAA,YAAY,IAAI,IAAI;AACpB,UAAA,QAAQ,IAAmC,IAAI;AACjC,QAAmB,IAAI;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}