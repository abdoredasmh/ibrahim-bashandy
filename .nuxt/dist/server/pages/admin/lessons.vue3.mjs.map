{"version":3,"file":"lessons.vue3.mjs","sources":["../../../../../pages/admin/lessons.vue"],"sourcesContent":["<template>\r\n  <div class=\"container mx-auto px-4 py-8 md:py-12\">\r\n    <div class=\"flex flex-wrap justify-between items-center gap-4 mb-6 pb-4 border-b border-gray-200 dark:border-gray-700\">\r\n      <h1 class=\"text-2xl font-semibold text-gray-800 dark:text-gray-100\">إدارة الدروس <span class=\"text-gray-500 dark:text-gray-400 text-lg\">({{ totalLessons }})</span></h1>\r\n      <button\r\n        @click=\"openAddModal\"\r\n        class=\"button-primary inline-flex items-center\"\r\n        :disabled=\"isListLoading || isDeleting !== null\"\r\n      >\r\n        <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5 me-1.5\" aria-hidden=\"true\"><path d=\"M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z\" /></svg>\r\n        إضافة درس جديد\r\n      </button>\r\n    </div>\r\n\r\n    <!-- Filters, Search, and Sort Row - IMPROVED LAYOUT -->\r\n    <div class=\"mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg border dark:border-gray-700\">\r\n\r\n      <!-- Search Input -->\r\n      <div>\r\n        <label for=\"search-term\" class=\"admin-label\">بحث بالعنوان:</label>\r\n        <input\r\n          id=\"search-term\"\r\n          type=\"text\"\r\n          v-model=\"searchTerm\"\r\n          :disabled=\"isListLoading\"\r\n          placeholder=\"ابحث...\"\r\n          @input=\"handleSearchInput\"\r\n          class=\"admin-input\"\r\n        />\r\n      </div>\r\n\r\n      <!-- Filter by Category -->\r\n      <div>\r\n        <label for=\"filter-category\" class=\"admin-label\">التصنيف:</label>\r\n        <select\r\n          id=\"filter-category\"\r\n          v-model=\"filterCategory\"\r\n          :disabled=\"isListLoading || isLoadingFilters\"\r\n          class=\"admin-select\"\r\n        >\r\n          <option :value=\"null\">الكل</option>\r\n          <option v-if=\"isLoadingFilters\" disabled>جاري التحميل...</option>\r\n          <option v-for=\"cat in categories\" :key=\"cat.id\" :value=\"cat.id\">{{ cat.name }}</option>\r\n           <option v-if=\"!isLoadingFilters && categories.length === 0\" disabled>لا توجد تصنيفات</option>\r\n        </select>\r\n      </div>\r\n\r\n      <!-- Filter by Course -->\r\n      <div>\r\n         <label for=\"filter-course\" class=\"admin-label\">الدورة الدراسية:</label>\r\n        <select\r\n          id=\"filter-course\"\r\n          v-model=\"filterCourse\"\r\n          :disabled=\"isListLoading || isLoadingFilters\"\r\n          class=\"admin-select\"\r\n        >\r\n          <option :value=\"null\">الكل</option>\r\n           <option :value=\"NO_COURSE_VALUE\">-- دروس عامة (بلا دورة) --</option>\r\n          <option v-if=\"isLoadingFilters\" disabled>جاري التحميل...</option>\r\n          <option v-for=\"course in courses\" :key=\"course.id\" :value=\"course.id\">{{ course.title }}</option>\r\n           <option v-if=\"!isLoadingFilters && courses.length === 0\" disabled>لا توجد دورات</option>\r\n        </select>\r\n      </div>\r\n\r\n       <!-- Sort Options -->\r\n       <div>\r\n           <label for=\"sort-by\" class=\"admin-label\">ترتيب حسب:</label>\r\n           <div class=\"flex gap-2\"> \r\n               <select\r\n                 id=\"sort-by\"\r\n                 v-model=\"sortBy\"\r\n                 :disabled=\"isListLoading\"\r\n                 class=\"admin-select flex-grow\"\r\n               >\r\n                 <option value=\"created_at\">تاريخ الإنشاء</option>\r\n                 <option value=\"title\">العنوان</option>\r\n                 <option value=\"course_id\">الدورة</option>\r\n                 <option value=\"category_id\">التصنيف</option>\r\n                 <option value=\"module_number\">الوحدة</option>\r\n                 <option value=\"lesson_order\">الترتيب</option>\r\n               </select>\r\n               <select\r\n                 aria-label=\"Sort order\"\r\n                 v-model=\"sortOrder\"\r\n                 :disabled=\"isListLoading\"\r\n                 class=\"admin-select w-24 flex-shrink-0\" \r\n               >\r\n                 <option value=\"desc\">تنازلي</option>\r\n                 <option value=\"asc\">تصاعدي</option>\r\n               </select>\r\n           </div>\r\n       </div>\r\n    </div>\r\n\r\n    <!-- Loading State for List -->\r\n    <div v-if=\"isListLoading && !lessons?.length\" class=\"text-center py-16\">\r\n      <LoadingSpinner class=\"w-10 h-10\" />\r\n      <p class=\"mt-3 text-gray-500 dark:text-gray-400\">جاري تحميل الدروس...</p>\r\n    </div>\r\n\r\n    <!-- Fetch Error Message -->\r\n    <div v-else-if=\"fetchError\" class=\"error-box\" role=\"alert\">\r\n      <strong class=\"font-bold\">خطأ في جلب البيانات!</strong>\r\n      <span class=\"block sm:inline\"> {{ fetchError.message || 'حدث خطأ أثناء جلب الدروس.' }}</span>\r\n       <button @click=\"() => fetchLessons(1)\" class=\"ml-2 mt-2 sm:mt-0 underline text-sm font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300\">إعادة المحاولة</button>\r\n    </div>\r\n\r\n    <!-- Status Messages (Success/Action Error) -->\r\n    <Transition name=\"fade\">\r\n      <div v-if=\"successMessage\" class=\"my-4 p-3 bg-green-100 border border-green-300 text-green-800 dark:bg-green-900/40 dark:border-green-700 dark:text-green-200 rounded text-sm font-medium shadow-sm\"> {{ successMessage }} </div>\r\n    </Transition>\r\n     <Transition name=\"fade\">\r\n      <div v-if=\"actionError\" class=\"my-4 p-3 bg-red-100 border border-red-300 text-red-700 dark:bg-red-900/40 dark:border-red-700 dark:text-red-200 rounded text-sm font-medium shadow-sm\"> {{ actionError }} </div>\r\n     </Transition>\r\n\r\n    <!-- Lessons Table Container -->\r\n    <div v-if=\"lessons && lessons.length > 0\" class=\"bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg border dark:border-gray-700 relative\">\r\n        <!-- Loading overlay for updates/deletes -->\r\n        <Transition name=\"fade\">\r\n           <div v-if=\"isListLoading || isDeleting !== null\" class=\"absolute inset-0 bg-white/60 dark:bg-gray-800/60 flex items-center justify-center z-10 backdrop-blur-sm rounded-lg\">\r\n               <LoadingSpinner class=\"w-8 h-8 text-primary-500\" />\r\n           </div>\r\n        </Transition>\r\n      <div class=\"overflow-x-auto\">\r\n          <table class=\"min-w-full divide-y divide-gray-200 dark:divide-gray-700\">\r\n            <thead class=\"bg-gray-50 dark:bg-gray-700/50\">\r\n              <tr>\r\n                 <th scope=\"col\" class=\"w-24 px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\r\n                  معاينة\r\n                </th>\r\n                <th scope=\"col\" class=\"px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\r\n                  العنوان\r\n                </th>\r\n                <th scope=\"col\" class=\"px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap\">\r\n                  التصنيف\r\n                </th>\r\n                 <th scope=\"col\" class=\"px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap\">\r\n                  الدورة\r\n                </th>\r\n                 <th scope=\"col\" class=\"px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden md:table-cell whitespace-nowrap\">\r\n                  الوحدة/الترتيب\r\n                </th>\r\n                <th scope=\"col\" class=\"px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden lg:table-cell whitespace-nowrap\">\r\n                  تاريخ الإنشاء\r\n                </th>\r\n                <th scope=\"col\" class=\"relative px-4 py-3\">\r\n                  <span class=\"sr-only\">الإجراءات</span>\r\n                </th>\r\n              </tr>\r\n            </thead>\r\n            <tbody class=\"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700\">\r\n              <tr v-for=\"lesson in lessons\" :key=\"lesson.id\" class=\"hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors duration-150 group\" :class=\"{'opacity-40 pointer-events-none': isDeleting === lesson.id}\">\r\n                 <td class=\"px-3 py-2 whitespace-nowrap text-center\">\r\n                   <button\r\n                     v-if=\"lesson.youtube_url && getYoutubeThumbnail(lesson.youtube_url)\"\r\n                     @click=\"openVideoPreviewModal(lesson.youtube_url)\"\r\n                     class=\"w-20 h-12 overflow-hidden rounded-md group/thumb relative focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 block mx-auto shadow-sm\"\r\n                     :title=\"`معاينة فيديو: ${lesson.title}`\"\r\n                     :disabled=\"isDeleting === lesson.id\"\r\n                     aria-label=\"معاينة الفيديو\"\r\n                   >\r\n                      <img\r\n                       :src=\"getYoutubeThumbnail(lesson.youtube_url)\"\r\n                       :alt=\"`معاينة درس ${lesson.title}`\"\r\n                       class=\"w-full h-full object-cover transition-transform duration-200 ease-in-out group-hover/thumb:scale-110\"\r\n                       loading=\"lazy\"\r\n                     />\r\n                      <div class=\"absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover/thumb:opacity-100 transition-opacity duration-200\">\r\n                           <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-6 h-6 text-white/80\"><path fill-rule=\"evenodd\" d=\"M2 10a8 8 0 1 1 16 0 8 8 0 0 1-16 0Zm6.39-2.908a.75.75 0 0 1 .766.027l3.5 2.25a.75.75 0 0 1 0 1.262l-3.5 2.25A.75.75 0 0 1 8 12.25v-4.5a.75.75 0 0 1 .39-.658Z\" clip-rule=\"evenodd\" /></svg>\r\n                      </div>\r\n                   </button>\r\n                   <div v-else class=\"w-20 h-12 bg-gray-200 dark:bg-gray-700 rounded-md flex items-center justify-center text-gray-400 dark:text-gray-500 text-xs italic mx-auto\">\r\n                     بلا فيديو\r\n                   </div>\r\n                 </td>\r\n                <td class=\"px-4 py-3\">\r\n                   <div class=\"text-sm font-medium text-gray-900 dark:text-gray-100 max-w-xs\" :title=\"lesson.title\">\r\n                    <NuxtLink :to=\"getLessonPublicLink(lesson)\" target=\"_blank\" class=\"hover:text-primary-600 dark:hover:text-primary-400 transition-colors group-hover:underline underline-offset-2\">\r\n                     {{ lesson.title }}\r\n                     <span class=\"text-xs text-gray-400 dark:text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity inline-block ms-1\" aria-hidden=\"true\"> (مشاهدة)</span>\r\n                    </NuxtLink>\r\n                   </div>\r\n                   <div class=\"text-xs text-gray-500 dark:text-gray-400 lg:hidden mt-1\">\r\n                    {{ formatDate(lesson.created_at, true) }} <!-- Short date for mobile -->\r\n                   </div>\r\n                </td>\r\n                <td class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400\">\r\n                  {{ lesson.categories?.name || '-' }}\r\n                </td>\r\n                <td class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400\">\r\n                   <NuxtLink v-if=\"lesson.course_id && lesson.study_courses?.title\" :to=\"`/study/courses/${lesson.course_id}`\" target=\"_blank\" class=\"hover:text-primary-600 dark:hover:text-primary-400 transition-colors\">\r\n                    {{ lesson.study_courses.title }}\r\n                   </NuxtLink>\r\n                   <span v-else class=\"text-gray-400 dark:text-gray-500 italic\">عام</span>\r\n                </td>\r\n                 <td class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 hidden md:table-cell\">\r\n                    <span v-if=\"lesson.module_number\" class=\"font-mono text-xs bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded\">#{{ lesson.module_number }}</span>\r\n                    <span v-else class=\"text-gray-400 dark:text-gray-500 text-xs italic\">عام</span>\r\n                    <span v-if=\"lesson.lesson_order\" class=\"text-xs\"> / {{ lesson.lesson_order }}</span>\r\n                 </td>\r\n                <td class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 hidden lg:table-cell\">\r\n                  {{ formatDate(lesson.created_at) }}\r\n                </td>\r\n                <td class=\"px-4 py-3 whitespace-nowrap text-left text-sm font-medium\">\r\n                  <div class=\"flex justify-end items-center gap-2\">\r\n                      <button\r\n                        @click=\"openEditModal(lesson)\"\r\n                        class=\"admin-action-button text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-200\"\r\n                        :disabled=\"isDeleting === lesson.id || isListLoading\"\r\n                        title=\"تعديل الدرس\"\r\n                        aria-label=\"تعديل الدرس\"\r\n                      >\r\n                         <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5\"><path d=\"m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.886L17.5 5.501a2.121 2.121 0 0 0-3-3L3.58 13.42a4 4 0 0 0-.886 1.343Z\" /></svg>\r\n                      </button>\r\n                      <button\r\n                        @click=\"confirmDelete(lesson)\"\r\n                        class=\"admin-action-button text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200\"\r\n                        :disabled=\"isDeleting === lesson.id || isListLoading\"\r\n                        title=\"حذف الدرس\"\r\n                        aria-label=\"حذف الدرس\"\r\n                      >\r\n                         <LoadingSpinner v-if=\"isDeleting === lesson.id\" class=\"w-5 h-5\" />\r\n                         <svg v-else xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"w-5 h-5\"><path fill-rule=\"evenodd\" d=\"M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.58.22-2.326.418C2.482 4.958 2 5.752 2 6.596v3.073c0 .844.482 1.638 1.274 2.014 1.106.527 2.283.9 3.476 1.146A6.997 6.997 0 0 0 10 18.25a6.997 6.997 0 0 0 3.25-.518c1.193-.246 2.37-.619 3.476-1.146C17.518 11.207 18 10.413 18 9.67V6.596c0-.844-.482-1.638-1.274-2.014-.746-.198-1.531-.341-2.326-.418V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 3.75c0-.69.56-1.25 1.25-1.25h2.5c.69 0 1.25.56 1.25 1.25v.415c-.885.102-1.745.276-2.55.5a.75.75 0 0 1-.4 0c-.805-.224-1.665-.398-2.55-.5V3.75Z\" clip-rule=\"evenodd\" /></svg>\r\n                      </button>\r\n                  </div>\r\n                </td>\r\n              </tr>\r\n            </tbody>\r\n          </table>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- Message when no lessons match filters -->\r\n    <div v-else-if=\"!isListLoading && (!lessons || lessons.length === 0)\" class=\"text-center py-16 text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/20\">\r\n         <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\" class=\"w-12 h-12 mx-auto mb-4 text-gray-400 dark:text-gray-500\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z\" /></svg>\r\n        <p v-if=\"searchTerm || filterCategory !== null || filterCourse !== null\">لا توجد دروس تطابق معايير البحث أو الفلترة الحالية.</p>\r\n        <p v-else>لا توجد دروس لعرضها حالياً. قم بإضافة درس جديد.</p>\r\n    </div>\r\n\r\n     <!-- Pagination Controls -->\r\n     <div v-if=\"totalPages > 1\" class=\"mt-6 flex justify-center items-center space-x-2 rtl:space-x-reverse\">\r\n         <button\r\n           @click=\"changePage(currentPage - 1)\"\r\n           :disabled=\"currentPage === 1 || isListLoading\"\r\n           class=\"pagination-button\"\r\n          >\r\n           السابق\r\n         </button>\r\n         <span class=\"text-sm text-gray-700 dark:text-gray-300 px-2 font-medium\">\r\n           صفحة {{ currentPage }} من {{ totalPages }} <span class=\"text-gray-500 dark:text-gray-400\">({{ totalLessons }} درس)</span>\r\n         </span>\r\n         <button\r\n           @click=\"changePage(currentPage + 1)\"\r\n           :disabled=\"currentPage === totalPages || isListLoading\"\r\n           class=\"pagination-button\"\r\n          >\r\n           التالي\r\n         </button>\r\n      </div>\r\n\r\n   <!-- Lesson Add/Edit Modal -->\r\n   <AdminLessonModal\r\n     :show=\"showModal\"\r\n     :lesson-data=\"selectedLesson\"\r\n     :preselected-course-id=\"preselectedCourseIdForModal\"\r\n     @close=\"closeModal\"\r\n     @saved=\"handleSave\"\r\n   />\r\n\r\n   <!-- Video Preview Modal -->\r\n    <VideoPreviewModal\r\n      :show=\"showVideoPreview\"\r\n      :video-url=\"previewVideoUrl\"\r\n      @close=\"closeVideoPreviewModal\"\r\n    />\r\n\r\n  </div>\r\n</template>\r\n\r\n<!-- Script section remains the same as the previous version -->\r\n<script setup lang=\"ts\">\r\nimport { ref, computed, onMounted, watch, reactive } from 'vue';\r\nimport type { Database, Tables } from '~/types/database.types';\r\nimport LoadingSpinner from '~/components/LoadingSpinner.vue';\r\nimport AdminLessonModal from '~/components/admin/AdminLessonModal.vue';\r\nimport VideoPreviewModal from '~/components/admin/VideoPreviewModal.vue';\r\nimport type { PostgrestError, SupabaseClient } from '@supabase/supabase-js';\r\nimport { useDebounceFn } from '@vueuse/core';\r\n\r\n// --- Constants ---\r\nconst PAGE_SIZE = 15;\r\nconst SEARCH_DEBOUNCE_MS = 400;\r\nconst NO_COURSE_VALUE = -1; // Special value for filtering lessons with course_id = NULL\r\n\r\n// --- Page Meta ---\r\ndefinePageMeta({ layout: 'admin', middleware: 'admin' });\r\nuseHead({ title: 'إدارة الدروس' });\r\n\r\n// --- Composables ---\r\nconst supabase = useSupabaseClient<Database>() as SupabaseClient<Database>;\r\n\r\n// --- State ---\r\nconst isListLoading = ref(true);\r\nconst fetchError = ref<PostgrestError | null>(null);\r\nconst lessons = ref<LessonWithRelations[] | null>(null);\r\nconst totalLessons = ref(0);\r\nconst searchTerm = ref('');\r\nconst filterCategory = ref<number | null>(null);\r\nconst filterCourse = ref<number | null | typeof NO_COURSE_VALUE>(null);\r\nconst sortBy = ref<'created_at' | 'title' | 'course_id' | 'category_id' | 'module_number' | 'lesson_order'>('created_at'); // Added sort options\r\nconst sortOrder = ref<'asc' | 'desc'>('desc');\r\nconst categories = ref<Tables<'categories'>[]>([]);\r\nconst courses = ref<Tables<'study_courses'>[]>([]);\r\nconst isLoadingFilters = ref(true);\r\nconst currentPage = ref(1);\r\nconst isDeleting = ref<number | null>(null);\r\nconst successMessage = ref<string | null>(null);\r\nconst actionError = ref<string | null>(null);\r\nconst showModal = ref(false);\r\nconst selectedLesson = ref<LessonWithRelations | null>(null);\r\nconst showVideoPreview = ref(false);\r\nconst previewVideoUrl = ref<string | null>(null);\r\nconst preselectedCourseIdForModal = computed(() =>\r\n    filterCourse.value !== null && filterCourse.value !== NO_COURSE_VALUE ? filterCourse.value : null\r\n);\r\n\r\n// --- Define Types ---\r\ntype LessonBase = Tables<'lessons'>;\r\ntype LessonWithRelations = LessonBase & {\r\n  categories: Pick<Tables<'categories'>, 'name'> | null;\r\n  study_courses: Pick<Tables<'study_courses'>, 'title'> | null;\r\n};\r\n\r\n// --- Computed Properties ---\r\nconst totalPages = computed(() => {\r\n  if (!totalLessons.value || totalLessons.value <= 0) return 1;\r\n  return Math.ceil(totalLessons.value / PAGE_SIZE);\r\n});\r\n\r\n// --- Functions ---\r\nconst fetchFilterOptions = async () => { /* ... (keep previous implementation) ... */\r\n  console.log(\"[fetchFilterOptions] Fetching categories and courses...\");\r\n  isLoadingFilters.value = true; actionError.value = null;\r\n  try {\r\n    const [catResult, courseResult] = await Promise.allSettled([\r\n      supabase.from('categories').select('id, name').order('name'),\r\n      supabase.from('study_courses').select('id, title').order('title')\r\n    ]);\r\n    if (catResult.status === 'fulfilled' && !catResult.value.error) { categories.value = catResult.value.data || []; }\r\n    else { console.error(\"Error fetching categories:\", catResult.status === 'rejected' ? catResult.reason : catResult.value.error); setActionError(\"فشل تحميل قائمة التصنيفات.\"); }\r\n    if (courseResult.status === 'fulfilled' && !courseResult.value.error) { courses.value = courseResult.value.data || []; }\r\n    else { console.error(\"Error fetching courses:\", courseResult.status === 'rejected' ? courseResult.reason : courseResult.value.error); setActionError(\"فشل تحميل قائمة الدورات.\"); }\r\n    console.log(`[fetchFilterOptions] Fetched ${categories.value.length} categories, ${courses.value.length} courses.`);\r\n  } catch (err: any) { console.error(\"Unexpected error in fetchFilterOptions:\", err); setActionError(\"خطأ غير متوقع في تحميل بيانات الفلاتر.\"); }\r\n  finally { isLoadingFilters.value = false; }\r\n};\r\n\r\nconst fetchLessons = async (page = currentPage.value) => {\r\n  isListLoading.value = true; fetchError.value = null; clearMessages(false);\r\n  console.log(`[fetchLessons] Fetching page ${page}, Filters: Cat=${filterCategory.value}, Course=${filterCourse.value}, Search='${searchTerm.value}', Sort=${sortBy.value} ${sortOrder.value}`);\r\n  const rangeFrom = (page - 1) * PAGE_SIZE; const rangeTo = rangeFrom + PAGE_SIZE - 1;\r\n  try {\r\n    let query = supabase.from('lessons').select(`id, title, description, youtube_url, category_id, course_id, created_at, module_number, lesson_order, categories ( name ), study_courses ( title )`, { count: 'exact' });\r\n    if (filterCategory.value !== null) query = query.eq('category_id', filterCategory.value);\r\n    if (filterCourse.value !== null) query = filterCourse.value === NO_COURSE_VALUE ? query.is('course_id', null) : query.eq('course_id', filterCourse.value);\r\n    const trimmedSearch = searchTerm.value.trim(); if (trimmedSearch) query = query.ilike('title', `%${trimmedSearch}%`);\r\n    // Ensure sorting by related tables uses the correct syntax if needed, but sorting by local columns is fine\r\n    query = query.order(sortBy.value, { ascending: sortOrder.value === 'asc', nullsFirst: false });\r\n    if (sortBy.value !== 'created_at') query = query.order('created_at', { ascending: false }); // Secondary sort\r\n    query = query.range(rangeFrom, rangeTo);\r\n    console.log('[fetchLessons] Executing query...'); const { data, error, count } = await query;\r\n    console.log(`[fetchLessons] Query executed. Error: ${!!error}, Count: ${count}, Data received: ${data?.length ?? 0}`);\r\n    if (error) throw error;\r\n    lessons.value = data as LessonWithRelations[] | null; totalLessons.value = count ?? 0; currentPage.value = page;\r\n    if (page > totalPages.value && totalPages.value > 0) { console.log(`[fetchLessons] Current page ${page} out of bounds. Fetching last page.`); await fetchLessons(totalPages.value); }\r\n  } catch (err: any) { console.error('[fetchLessons] Error fetching lessons:', err); fetchError.value = err as PostgrestError; lessons.value = null; totalLessons.value = 0; }\r\n  finally { isListLoading.value = false; }\r\n};\r\n\r\nconst handleSearchInput = useDebounceFn(() => { if (currentPage.value !== 1) { currentPage.value = 1; } else { fetchLessons(1); } }, SEARCH_DEBOUNCE_MS);\r\nconst changePage = (newPage: number) => { if (newPage >= 1 && newPage <= totalPages.value && newPage !== currentPage.value && !isListLoading.value) { currentPage.value = newPage; } };\r\nconst openAddModal = () => { if (!isListLoading.value && isDeleting.value === null) { selectedLesson.value = null; showModal.value = true; clearMessages(); } };\r\nconst openEditModal = (lesson: LessonWithRelations) => { if (!isListLoading.value && isDeleting.value === null) { selectedLesson.value = { ...lesson }; showModal.value = true; clearMessages(); } };\r\nconst closeModal = () => { showModal.value = false; selectedLesson.value = null; };\r\nconst openVideoPreviewModal = (url: string | null | undefined) => { if (url && !isDeleting.value) { previewVideoUrl.value = url; showVideoPreview.value = true; } };\r\nconst closeVideoPreviewModal = () => { showVideoPreview.value = false; previewVideoUrl.value = null; };\r\n\r\nconst handleSave = async () => { closeModal(); setSuccessMessage('تم حفظ الدرس بنجاح.'); await fetchLessons(currentPage.value); };\r\n\r\nconst confirmDelete = async (lesson: LessonWithRelations) => {\r\n  if (isDeleting.value !== null || isListLoading.value) return;\r\n  if (window.confirm(`هل أنت متأكد أنك تريد حذف الدرس \"${lesson.title}\"؟ لا يمكن التراجع عن هذا الإجراء.`)) {\r\n    isDeleting.value = lesson.id; clearMessages();\r\n    try {\r\n      console.log(`[confirmDelete] Deleting lesson ID: ${lesson.id}`); const { error: deleteError } = await supabase.from('lessons').delete().eq('id', lesson.id); if (deleteError) throw deleteError;\r\n      console.log(`[confirmDelete] Lesson ID: ${lesson.id} deleted successfully.`); setSuccessMessage('تم حذف الدرس بنجاح.'); await fetchLessons(currentPage.value);\r\n    } catch (err: any) { console.error(`[confirmDelete] Error deleting lesson ID: ${lesson.id}:`, err); setActionError(`فشل حذف الدرس: ${err.message || 'خطأ غير معروف'}.`); }\r\n    finally { isDeleting.value = null; }\r\n  }\r\n};\r\n\r\n// --- Helper Functions ---\r\nconst formatDate = (dateString: string | null, short = false): string => { if (!dateString) return '-'; try { const date = new Date(dateString); if (isNaN(date.getTime())) return 'تاريخ غير صالح'; const options: Intl.DateTimeFormatOptions = short ? { year: 'numeric', month: 'short', day: 'numeric' } : { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' }; return date.toLocaleDateString('ar-EG', options); } catch (e) { return 'خطأ تنسيق'; } };\r\nconst getYoutubeVideoId = (url: string | null | undefined): string | null => { if (!url) return null; const regex = /(?:https?:\\/\\/)?(?:www\\.)?(?:youtube\\.com\\/(?:watch\\?v=|embed\\/|v\\/|shorts\\/)|youtu\\.be\\/)([a-zA-Z0-9_-]{11})(?:\\S+)?/; const match = url.match(regex); return match?.[1] || null; };\r\nconst getYoutubeThumbnail = (url: string | null | undefined): string | null => { const videoId = getYoutubeVideoId(url); return videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : null; };\r\nconst setSuccessMessage = (msg: string) => { successMessage.value = msg; actionError.value = null; setTimeout(() => { successMessage.value = null; }, 4000); };\r\nconst setActionError = (msg: string) => { actionError.value = msg; successMessage.value = null; };\r\nconst clearMessages = (clearActionErr = true) => { successMessage.value = null; if (clearActionErr) actionError.value = null; };\r\nconst getLessonPublicLink = (lesson: LessonWithRelations): string => { return lesson.course_id ? `/study/courses/${lesson.course_id}/lessons/${lesson.id}` : '#'; };\r\n\r\n// --- Watchers ---\r\nwatch([filterCategory, filterCourse, sortBy, sortOrder], () => { if (currentPage.value !== 1) { currentPage.value = 1; } else { fetchLessons(1); } }, { deep: true });\r\nwatch(currentPage, (newPage, oldPage) => { if (newPage !== oldPage) { fetchLessons(newPage); } });\r\n\r\n// --- Lifecycle Hooks ---\r\nonMounted(async () => { console.log('[onMounted] Initializing data...'); isListLoading.value = true; isLoadingFilters.value = true; await Promise.all([fetchLessons(1), fetchFilterOptions()]); console.log('[onMounted] Initial data fetch complete.'); });\r\n\r\n</script>\r\n\r\n<style scoped>\r\n/* Using consistent admin styles */\r\n.admin-label { @apply block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1; }\r\n.admin-input, .admin-select {\r\n     @apply block w-full px-3 py-2 text-sm rounded-md shadow-sm\r\n            border border-gray-300 dark:border-gray-600\r\n            bg-white dark:bg-gray-700\r\n            text-gray-900 dark:text-gray-100\r\n            placeholder-gray-400 dark:placeholder-gray-500\r\n            focus:ring-1 focus:ring-offset-0 focus:ring-primary focus:border-primary\r\n            focus:outline-none\r\n            disabled:opacity-70 disabled:cursor-not-allowed transition-colors;\r\n}\r\n.error-box {\r\n     @apply bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 text-sm dark:bg-red-900/20 dark:border-red-700/50 dark:text-red-300;\r\n}\r\n.admin-action-button {\r\n     @apply p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-1;\r\n}\r\n.pagination-button {\r\n    @apply px-3 py-1 text-sm rounded border bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors;\r\n}\r\n.max-w-xs { max-width: 20rem; } /* For truncating titles */\r\n\r\n/* Base button styles used in template */\r\n.button-base {\r\n    @apply inline-flex items-center justify-center px-4 py-2 border text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-60 disabled:cursor-not-allowed transition-colors duration-150;\r\n}\r\n.button-primary {\r\n    @apply button-base border-transparent text-white bg-primary hover:bg-opacity-85 focus:ring-primary;\r\n}\r\n.button-secondary {\r\n    @apply button-base border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:ring-blue-muted;\r\n}\r\n\r\n/* Fade transition for messages and loading overlay */\r\n.fade-enter-active,\r\n.fade-leave-active {\r\n  transition: opacity 0.3s ease;\r\n}\r\n.fade-enter-from,\r\n.fade-leave-to {\r\n  opacity: 0;\r\n}\r\n</style>"],"names":[],"mappings":"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"}