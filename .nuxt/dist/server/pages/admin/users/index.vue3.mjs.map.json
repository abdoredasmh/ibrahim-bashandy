{"file":"index.vue3.mjs","mappings":";;;;;;;;;AA2HA,MAAM,kBAAkB;;;;;AAYxB,UAAM,WAAW,kBAA4B;AACvC,UAAA,EAAE,OAAO,IAAI,WAAW;AAGxB,UAAA,UAAU,IAAI,IAAI;AAClB,UAAA,cAAc,IAAI,KAAK;AACvB,UAAA,aAAa,IAA2B,IAAI;AAC5C,UAAA,QAAQ,IAAqB,EAAE;AAC/B,UAAA,cAAc,IAAI,CAAC;AACnB,UAAA,WAAW,IAAI,eAAe;AAC9B,UAAA,UAAU,IAAI,IAAI;AAClB,UAAA,aAAa,IAAI,EAAE;AACnB,UAAA,aAAa,IAA8B,KAAK;AAChD,UAAA,eAAe,IAA+C,KAAK;AAenE,UAAA,kBAAkB,IAAwB,IAAI;AAkBpD,UAAM,aAAa,OAAO,OAAO,GAAG,YAAY,UAAU;AACxD,UAAI,WAAW;AACX,oBAAY,QAAQ;AAAA,MAAA,OACjB;AACH,gBAAQ,QAAQ;AAChB,cAAM,QAAQ,CAAC;AACf,oBAAY,QAAQ;AACpB,gBAAQ,QAAQ;AAAA,MAAA;AAEpB,iBAAW,QAAQ;AAGb,YAAA,aAAa,OAAO,KAAK,SAAS;AAClC,YAAA,UAAU,YAAY,SAAS,QAAQ;AAEzC,UAAA;AAEF,YAAI,YAAY,SACb,KAAK,UAAU,EACf,OAAO,GAAG,EACV,MAAM,cAAc,EAAE,WAAW,OAAO;AAGvC,YAAA,WAAW,UAAU,OAAO;AAAE,sBAAY,UAAU,GAAG,QAAQ,WAAW,KAAK;AAAA,QAAA;AAC7E,cAAA,gBAAgB,WAAW,MAAM,KAAK;AAC5C,YAAI,eAAe;AAAE,sBAAY,UAAU,MAAM,aAAa,IAAI,aAAa,GAAG;AAAA,QAAA;AAC9E,YAAA,aAAa,UAAU,OAAO;AAC1B,cAAA,aAAa,UAAU,UAAU;AAAc,wBAAA,UAAU,GAAG,aAAa,IAAI;AAAA,UAAA,WACxE,aAAa,UAAU,aAAa;AAAE,wBAAY,UAAU,GAAG,gDAA+B,KAAK,GAAE,aAAa;AAAA,UAAA,WAClH,aAAa,UAAU,UAAU;AAAE,wBAAY,UAAU,GAAG,aAAa,KAAK,EAAE,GAAG,gEAA+D,oBAAI,KAAK,GAAE,YAAY,CAAC,EAAE;AAAA,UAAA;AAAA,QAAG;AAItL,cAAA,EAAE,MAAM,cAAc,OAAO,kBAAkB,MAAM,UACxD,MAAM,WAAW,OAAO;AAE3B,YAAI,cAAqB,OAAA;AAGxB,cAAM,WAAU,6CAAc,IAAI,OAAK,EAAE,QAAO,CAAC;AAC7C,YAAA,mCAAmB,IAAiC;AACpD,YAAA,QAAQ,SAAS,GAAG;AAChB,cAAA;AACD,kBAAM,EAAE,MAAM,UAAU,OAAO,UAAA,IAAc,MAAM,SAAS,KAAK,MAAM,UAAU,EAAE,MAAM,GAAG,SAAS,KAAM;AAC3G,gBAAI,UAAiB,OAAA;AACrB,gBAAI,qCAAU,OAAO;AACX,oBAAA,gBAAgB,SAAS,MAAM,OAAO,OAAK,QAAQ,SAAS,EAAE,EAAE,CAAC;AACzD,4BAAA,QAAQ,CAAK,MAAA,aAAa,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,MAAO,CAAA,CAAC;AAAA,YAAA;AAAA,mBAEnE,SAAc;AAAU,oBAAA,KAAK,qCAAqC,QAAQ,OAAO;AAAA,UAAA;AAAA,QAAG;AAI3F,cAAA,gBAAe,6CAAc,IAAI,CAAY,YAAA;;AAAA;AAAA,YAC/C,GAAG;AAAA,YACH,cAAY,kBAAa,IAAI,QAAQ,EAAE,MAA3B,mBAA8B,UAAS;AAAA,UACvD;AAAA,eAAO,CAAC;AAET,YAAI,WAAW;AACP,gBAAA,MAAM,KAAK,GAAG,YAAY;AAAA,QAAA,OAC3B;AACL,gBAAM,QAAQ;AAAA,QAAA;AAIR,gBAAA,QAAQ,aAAa,WAAW,SAAS;AACjD,YAAI,QAAQ,OAAO;AACf,sBAAY,QAAQ,OAAO;AAAA,QAAA;AAAA,eAIxB,KAAU;AACT,gBAAA,MAAM,yBAAyB,GAAG;AAC1C,mBAAW,QAAQ;AACnB,YAAI,CAAC,WAAW;AACZ,gBAAM,QAAQ,CAAC;AAAA,QAAA;AAEnB,gBAAQ,QAAQ;AAAA,MAAA,UAChB;AACA,gBAAQ,QAAQ;AAChB,oBAAY,QAAQ;AAAA,MAAA;AAAA,IAExB;AAGA,UAAM,eAAe,MAAM;AACvB,iBAAW,GAAG,KAAK;AAAA,IACvB;AAGA,UAAM,WAAW,MAAM;AACnB,UAAI,CAAC,QAAQ,SAAS,CAAC,YAAY,SAAS,QAAQ,OAAO;AAC5C,mBAAA,YAAY,OAAO,IAAI;AAAA,MAAA;AAAA,IAE1C;AAGA;AAAA,MACE;AAAA,MACA,CAAC,CAAC,EAAE,eAAA,CAAgB,MAAM;AACxB,YAAI,gBAAgB;AACT,mBAAA;AAAA,QAAA;AAAA,MAEb;AAAA,MACA,EAAE,WAAW,IAAI;AAAA;AAAA,IACnB;AAGM,UAAA,aAAa,CAAC,eAAkD;AAChE,UAAA,CAAC,WAAmB,QAAA;AACpB,UAAA;AAAQ,cAAA,OAAO,IAAI,KAAK,UAAU;AAAG,YAAI,MAAM,KAAK,QAAS,CAAA,EAAU,QAAA;AAAyB,eAAA,KAAK,eAAe,SAAS,EAAE,WAAW,UAAU,WAAW,SAAS;AAAA,eACrK,GAAG;AAAS,eAAA;AAAA,MAAA;AAAA,IACrB;AAEM,UAAA,qBAAqB,CAAC,mBAAuD;AAC3E,UAAA,CAAC,eAAuB,QAAA;AACxB,UAAA;AAAE,eAAO,IAAI,KAAK,cAAc,wBAAQ,KAAK;AAAA,MAAA,QAAW;AAAS,eAAA;AAAA,MAAA;AAAA,IACzE;AAkBA,UAAM,CAAC,YAAY,cAAc,UAAU,GAAG,MAAM;AACnC,mBAAA;AAAA,IAAA,CAChB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","names":[],"sources":["../../../../../../pages/admin/users/index.vue"],"sourcesContent":["<template>\r\n  <div class=\"container mx-auto px-4 py-6\">\r\n    <h1 class=\"text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-6\">إدارة المستخدمين</h1>\r\n\r\n    <!-- Filters and Search -->\r\n    <div class=\"mb-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border dark:border-gray-700 flex flex-wrap items-center gap-4 sticky top-0 z-10\"> \r\n      <!-- Search -->\r\n      <div class=\"flex-grow min-w-[250px] relative\">\r\n        <label for=\"user-search\" class=\"sr-only\">بحث</label>\r\n        <input\r\n          id=\"user-search\"\r\n          type=\"text\"\r\n          v-model=\"searchTerm\"\r\n          @input=\"handleSearchInput\"\r\n          placeholder=\"ابحث بالاسم أو البريد الإلكتروني...\"\r\n          class=\"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 pl-8\"\r\n        />\r\n         <div class=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 16 16\" fill=\"currentColor\" class=\"w-4 h-4 text-gray-400\"><path fill-rule=\"evenodd\" d=\"M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z\" clip-rule=\"evenodd\" /></svg></div>\r\n        <button v-if=\"searchTerm\" @click=\"clearSearch\" :disabled=\"pending\" class=\"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 disabled:opacity-50 z-10\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 16 16\" fill=\"currentColor\" class=\"w-4 h-4\"><path fill-rule=\"evenodd\" d=\"M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14Zm2.78-4.22a.75.75 0 0 1-1.06 1.06L8 9.06l-1.72 1.72a.75.75 0 1 1-1.06-1.06L6.94 8 5.22 6.28a.75.75 0 0 1 1.06-1.06L8 6.94l1.72-1.72a.75.75 0 1 1 1.06 1.06L9.06 8l1.72 1.78Z\" clip-rule=\"evenodd\" /></svg></button>\r\n      </div>\r\n      <!-- Filter by Role -->\r\n      <div><select id=\"role-filter\" v-model=\"filterRole\" :disabled=\"pending\" class=\"rounded-md ...\"><option value=\"all\">كل الأدوار</option><option value=\"user\">مستخدم</option><option value=\"admin\">مشرف</option></select></div>\r\n      <!-- Filter by Status -->\r\n      <div><select id=\"status-filter\" v-model=\"filterStatus\" :disabled=\"pending\" class=\"rounded-md ...\"><option value=\"all\">كل الحالات</option><option value=\"active\">نشط</option><option value=\"banned\">محظور</option><option value=\"suspended\">تعليق موقوف</option></select></div>\r\n       <!-- Refresh Button -->\r\n       <button @click=\"refreshUsers\" :disabled=\"pending\" title=\"تحديث القائمة\" class=\"p-2 ...\"><svg :class=\"['w-4 h-4', pending ? 'animate-spin' : '']\">...</svg></button>\r\n    </div>\r\n\r\n    <!-- Error State -->\r\n     <div v-if=\"fetchError\" class=\"my-4 p-3 bg-red-100 ...\"> خطأ! {{ fetchError.message }}</div>\r\n\r\n    <!-- Users Table/List -->\r\n    <div class=\"overflow-x-auto bg-white dark:bg-gray-800 shadow rounded-lg\">\r\n      <table class=\"min-w-full divide-y divide-gray-200 dark:divide-gray-700\">\r\n        <thead class=\"bg-gray-50 dark:bg-gray-700\">\r\n          <tr>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-right ...\">المستخدم</th>\r\n            <th scope=\"col\" class=\"px-6 py-3 text-right ... hidden sm:table-cell\">الدور</th> \r\n            <th scope=\"col\" class=\"px-6 py-3 text-right ... hidden md:table-cell\">الحالة</th> \r\n            <th scope=\"col\" class=\"px-6 py-3 text-right ... hidden lg:table-cell\">تاريخ الانضمام</th> \r\n            <th scope=\"col\" class=\"relative px-6 py-3\"><span class=\"sr-only\">عرض التفاصيل</span></th>\r\n          </tr>\r\n        </thead>\r\n        <tbody class=\"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700\">\r\n          <tr v-if=\"pending && users.length === 0\">\r\n             <td colspan=\"5\" class=\"text-center py-10\"><LoadingSpinner /></td>\r\n          </tr>\r\n          <tr v-else-if=\"!pending && users.length === 0\">\r\n             <td colspan=\"5\" class=\"text-center py-10 text-gray-500\">لا يوجد مستخدمون يطابقون بحثك أو الفلاتر.</td>\r\n          </tr>\r\n          <tr v-for=\"user in users\" :key=\"user.id\" class=\"hover:bg-gray-50 dark:hover:bg-gray-700/50\">\r\n          \r\n            <td class=\"px-6 py-4 whitespace-nowrap\">\r\n              <div class=\"flex items-center\">\r\n                <div class=\"flex-shrink-0 h-10 w-10\"><UserAvatar :src=\"user.avatar_url || undefined\" :alt=\"user.full_name || 'مستخدم'\" size=\"md\" /></div>\r\n                <div class=\"mr-4\">\r\n                  <div class=\"text-sm font-medium text-gray-900 dark:text-gray-100\">{{ user.full_name || 'لم يحدد اسم' }}</div>\r\n                  <div class=\"text-sm text-gray-500 dark:text-gray-400\">{{ user.auth_email || 'لا يوجد بريد' }}</div>\r\n             \r\n                    <div class=\"sm:hidden mt-1 flex items-center gap-2 text-xs\">\r\n                         <span :class=\"['px-1.5 py-0.5 rounded-full', user.role === 'admin' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300']\">{{ user.role }}</span>\r\n                          <span v-if=\"user.is_banned\" class=\"px-1.5 py-0.5 rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300\">محظور</span>\r\n                          <span v-else-if=\"isCommentSuspended(user.comment_suspended_until)\" class=\"px-1.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300\">موقوف</span>\r\n                    </div>\r\n                </div>\r\n              </div>\r\n            </td>\r\n           \r\n            <td class=\"px-6 py-4 whitespace-nowrap hidden sm:table-cell\">\r\n               <span :class=\"['px-2 inline-flex text-xs leading-5 font-semibold rounded-full', user.role === 'admin' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300']\">\r\n                   {{ user.role === 'admin' ? 'مشرف' : 'مستخدم' }}\r\n               </span>\r\n            </td>\r\n          \r\n            <td class=\"px-6 py-4 whitespace-nowrap hidden md:table-cell\">\r\n              <span v-if=\"user.is_banned\" class=\"px-2 ... bg-red-100 ...\">محظور</span>\r\n              <span v-else-if=\"isCommentSuspended(user.comment_suspended_until)\" class=\"px-2 ... bg-yellow-100 ...\">تعليق موقوف</span>\r\n              <span v-else class=\"px-2 ... bg-green-100 ...\">نشط</span>\r\n            </td>\r\n           \r\n             <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 hidden lg:table-cell\">\r\n                {{ formatDate(user.created_at) }}\r\n             </td>\r\n       \r\n            <td class=\"px-6 py-4 whitespace-nowrap text-left text-sm font-medium rtl:text-right\">\r\n                <NuxtLink :to=\"`/admin/users/${user.id}`\" class=\"text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 group flex items-center gap-1\">\r\n                    <span>التفاصيل</span>\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 16 16\" fill=\"currentColor\" class=\"w-4 h-4 transition-transform group-hover:translate-x-[-2px] rtl:group-hover:translate-x-[2px]\"><path fill-rule=\"evenodd\" d=\"M9.78 4.22a.75.75 0 0 1 0 1.06L7.06 8l2.72 2.72a.75.75 0 1 1-1.06 1.06L5.47 8.53a.75.75 0 0 1 0-1.06l3.25-3.25a.75.75 0 0 1 1.06 0Z\" clip-rule=\"evenodd\" /></svg>\r\n                </NuxtLink>\r\n            </td>\r\n          </tr>\r\n        </tbody>\r\n      </table>\r\n    </div>\r\n\r\n    <!-- Infinite Scroll Loader/Trigger -->\r\n    <div ref=\"loadMoreTrigger\" class=\"h-20 flex items-center justify-center\">\r\n       <div v-if=\"pendingMore\" class=\"text-center\">\r\n           <LoadingSpinner />\r\n           <p class=\"text-sm text-gray-500 mt-1\">تحميل المزيد...</p>\r\n       </div>\r\n        <div v-else-if=\"!pending && users.length > 0 && !hasMore\" class=\"text-sm text-gray-500\">\r\n           لا يوجد المزيد من المستخدمين.\r\n       </div>\r\n    </div>\r\n\r\n  </div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, computed, onMounted, watch, onBeforeUnmount } from 'vue';\r\nimport type { Database, Tables, Enums } from '~/types/database.types';\r\nimport LoadingSpinner from '~/components/LoadingSpinner.vue';\r\nimport UserAvatar from '~/components/UserAvatar.vue';\r\n// Remove modal imports for now\r\n// import SendMessageModal from '~/components/admin/SendMessageModal.vue';\r\n// import SuspendCommentModal from '~/components/admin/SuspendCommentModal.vue';\r\n// import ConfirmationModal, { type ConfirmationConfig } from '~/components/admin/ConfirmationModal.vue';\r\nimport { useSupabaseClient, definePageMeta, useNuxtApp } from '#imports';\r\nimport type { PostgrestError, User } from '@supabase/supabase-js';\r\nimport { useIntersectionObserver } from '@vueuse/core'; // Import for infinite scroll\r\n\r\n// --- Constants ---\r\nconst ADMIN_PAGE_SIZE = 30; // Increase page size for infinite scroll\r\nconst SEARCH_DEBOUNCE_MS = 400;\r\n\r\n// --- Define Types ---\r\ntype AdminUserView = Tables<'profiles'> & {\r\n  auth_email?: string | null;\r\n};\r\n\r\n// --- Page Meta ---\r\ndefinePageMeta({ layout: 'admin', middleware: 'admin' });\r\n\r\n// --- Composables ---\r\nconst supabase = useSupabaseClient<Database>();\r\nconst { $toast } = useNuxtApp();\r\n\r\n// --- State ---\r\nconst pending = ref(true);        // Overall loading state (initial load or filter change)\r\nconst pendingMore = ref(false);   // Loading state for fetching next page (infinite scroll)\r\nconst fetchError = ref<PostgrestError | null>(null);\r\nconst users = ref<AdminUserView[]>([]); // Initialize as empty array\r\nconst currentPage = ref(1);\r\nconst pageSize = ref(ADMIN_PAGE_SIZE);\r\nconst hasMore = ref(true);        // Flag to indicate if more users might exist\r\nconst searchTerm = ref('');\r\nconst filterRole = ref<'all' | 'user' | 'admin'>('all');\r\nconst filterStatus = ref<'all' | 'active' | 'banned' | 'suspended'>('all');\r\nlet searchDebounceTimer: ReturnType<typeof setTimeout> | null = null;\r\n// Remove action/modal related state for this page\r\n// const isLoadingAction = ref<string | null>(null);\r\n// const actionMessage = ref<string | null>(null);\r\n// const actionMessageType = ref<'success' | 'error'>('success');\r\n// const activeActionsMenu = ref<string | null>(null);\r\n// const showSendMessageModal = ref(false);\r\n// const showSuspendModal = ref(false);\r\n// const showConfirmModal = ref(false);\r\n// const selectedUserForModal = ref<AdminUserView | null>(null);\r\n// const confirmConfig = ref<ConfirmationConfig | null>(null);\r\n// let actionToConfirm: { type: 'ban' | 'unban' | 'unsuspend', user: AdminUserView } | null = null;\r\n\r\n// --- Infinite Scroll Trigger Ref ---\r\nconst loadMoreTrigger = ref<HTMLElement | null>(null);\r\n\r\n\r\n// --- Functions ---\r\n\r\nconst handleSearchInput = () => {\r\n  if (searchDebounceTimer) clearTimeout(searchDebounceTimer);\r\n  searchDebounceTimer = setTimeout(() => {\r\n    refreshUsers(); // Trigger a full refresh (reset to page 1)\r\n  }, SEARCH_DEBOUNCE_MS);\r\n};\r\n\r\nconst clearSearch = () => {\r\n    searchTerm.value = '';\r\n    // Watcher will trigger refresh\r\n};\r\n\r\n/** Fetch users, supporting pagination for infinite scroll */\r\nconst fetchUsers = async (page = 1, appending = false) => {\r\n  if (appending) {\r\n      pendingMore.value = true; // Show loading more indicator\r\n  } else {\r\n      pending.value = true; // Show main loading indicator\r\n      users.value = []; // Clear existing users on a full refresh\r\n      currentPage.value = 1;\r\n      hasMore.value = true; // Assume there's more when refreshing\r\n  }\r\n  fetchError.value = null;\r\n  // clearActionMessage(); // No actions on this page anymore\r\n\r\n  const rangeFrom = (page - 1) * pageSize.value;\r\n  const rangeTo = rangeFrom + pageSize.value - 1;\r\n\r\n  try {\r\n    // --- Build Base Query ---\r\n    let baseQuery = supabase\r\n      .from('profiles')\r\n      .select(`*`) // Assuming created_at exists in profiles\r\n      .order('created_at', { ascending: false });\r\n\r\n    // --- Apply Filters ---\r\n    if (filterRole.value !== 'all') { baseQuery = baseQuery.eq('role', filterRole.value); }\r\n    const trimmedSearch = searchTerm.value.trim();\r\n    if (trimmedSearch) { baseQuery = baseQuery.ilike('full_name', `%${trimmedSearch}%`); } // Basic search on name\r\n    if (filterStatus.value !== 'all') {\r\n        if (filterStatus.value === 'banned') { baseQuery = baseQuery.eq('is_banned', true); }\r\n        else if (filterStatus.value === 'suspended') { baseQuery = baseQuery.gt('comment_suspended_until', new Date().toISOString()); }\r\n        else if (filterStatus.value === 'active') { baseQuery = baseQuery.eq('is_banned', false).or(`comment_suspended_until.is.null,comment_suspended_until.lte.${new Date().toISOString()}`); }\r\n    }\r\n\r\n    // --- Execute Data Query ---\r\n    const { data: profilesData, error: profilesError } = await baseQuery\r\n      .range(rangeFrom, rangeTo);\r\n\r\n    if (profilesError) throw profilesError;\r\n\r\n    // --- Fetch Auth Emails (Optional) ---\r\n     const userIds = profilesData?.map(p => p.id) ?? [];\r\n     let authUsersMap = new Map<string, Pick<User, 'email'>>(); // Only need email now\r\n     if (userIds.length > 0) {\r\n         try {\r\n            const { data: authData, error: authError } = await supabase.auth.admin.listUsers({ page: 1, perPage: 1000 });\r\n            if (authError) throw authError;\r\n            if (authData?.users) {\r\n                const relevantUsers = authData.users.filter(u => userIds.includes(u.id));\r\n                relevantUsers.forEach(u => authUsersMap.set(u.id, { email: u.email }));\r\n            }\r\n         } catch (authErr: any) { console.warn(\"Could not fetch auth user emails:\", authErr.message); }\r\n     }\r\n\r\n     // --- Combine and Append/Set Data ---\r\n     const fetchedUsers = profilesData?.map(profile => ({\r\n         ...profile,\r\n         auth_email: authUsersMap.get(profile.id)?.email ?? null,\r\n     })) ?? [];\r\n\r\n    if (appending) {\r\n      users.value.push(...fetchedUsers); // Append new users\r\n    } else {\r\n      users.value = fetchedUsers; // Replace users on full refresh\r\n    }\r\n\r\n    // Update hasMore flag\r\n    hasMore.value = fetchedUsers.length === pageSize.value;\r\n    if (hasMore.value) {\r\n        currentPage.value = page + 1; // Prepare for the next page fetch\r\n    }\r\n\r\n\r\n  } catch (err: any) {\r\n    console.error(\"Error fetching users:\", err);\r\n    fetchError.value = err as PostgrestError;\r\n    if (!appending) { // Clear users only if it was a full refresh error\r\n        users.value = [];\r\n    }\r\n    hasMore.value = false; // Stop fetching on error\r\n  } finally {\r\n    pending.value = false;\r\n    pendingMore.value = false;\r\n  }\r\n};\r\n\r\n/** Trigger a full refresh (reset to page 1) */\r\nconst refreshUsers = () => {\r\n    fetchUsers(1, false);\r\n};\r\n\r\n/** Load next page for infinite scroll */\r\nconst loadMore = () => {\r\n    if (!pending.value && !pendingMore.value && hasMore.value) {\r\n        fetchUsers(currentPage.value, true);\r\n    }\r\n};\r\n\r\n// --- Intersection Observer for Infinite Scroll ---\r\nuseIntersectionObserver(\r\n  loadMoreTrigger,\r\n  ([{ isIntersecting }]) => {\r\n    if (isIntersecting) {\r\n      loadMore();\r\n    }\r\n  },\r\n  { threshold: 0.1 } // Trigger when 10% of the element is visible\r\n);\r\n\r\n// --- Helper Functions ---\r\nconst formatDate = (dateString: string | null | undefined): string => {\r\n  if (!dateString) return 'غير محدد';\r\n  try { const date = new Date(dateString); if (isNaN(date.getTime())) return 'تاريخ غير صالح'; return date.toLocaleString('ar-EG', { dateStyle: 'medium', timeStyle: 'short' }); }\r\n  catch (e) { return 'خطأ تنسيق'; }\r\n};\r\n\r\nconst isCommentSuspended = (suspendedUntil: string | null | undefined): boolean => {\r\n    if (!suspendedUntil) return false;\r\n    try { return new Date(suspendedUntil) > new Date(); } catch { return false; }\r\n};\r\n\r\n// Remove action/modal related functions as they moved to detail page\r\n// const updateUserRole = ...\r\n// const toggleBanStatus = ...\r\n// const handleUserSuspended = ...\r\n// const removeCommentSuspension = ...\r\n// const openSendMessageModal = ...\r\n// const openSuspendModal = ...\r\n// const handleMessageSent = ...\r\n// const confirmAction = ...\r\n// const executeConfirmedAction = ...\r\n// const toggleActions = ...\r\n// const handleClickOutside = ...\r\n\r\n\r\n// --- Watchers ---\r\n// Watch filters and search term to trigger a refresh\r\nwatch([filterRole, filterStatus, searchTerm], () => {\r\n    refreshUsers();\r\n});\r\n\r\n// --- Lifecycle Hooks ---\r\nonMounted(() => {\r\n  fetchUsers(1); // Fetch initial data\r\n  // Remove click outside listener for actions menu\r\n});\r\n\r\nonBeforeUnmount(() => {\r\n  if (searchDebounceTimer) clearTimeout(searchDebounceTimer);\r\n});\r\n\r\n</script>\r\n\r\n<style scoped>\r\n/* Add styles for responsiveness */\r\n@media (max-width: 640px) { /* sm */\r\n  .hidden-sm { display: none; }\r\n}\r\n@media (max-width: 768px) { /* md */\r\n  .hidden-md { display: none; }\r\n}\r\n@media (max-width: 1024px) { /* lg */\r\n  .hidden-lg { display: none; }\r\n}\r\n\r\n\r\n</style>"],"version":3}