import{e as V,u as P,r as p,A as U,c as l,o as i,a as t,v as w,i as k,x as u,y as h,a9 as _,a6 as j,F as S,j as $,t as y,_ as q}from"./CaF1xe-H.js";const A={class:"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"},N={class:"p-6"},L={class:"flex space-x-4 rtl:space-x-reverse"},z={class:"flex items-center"},I={class:"flex items-center"},T=["value"],Z={key:0,class:"mt-1 text-xs text-yellow-600 dark:text-yellow-400"},G={key:0,class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},H={key:0,class:"text-red-600 dark:text-red-400 text-sm"},J={class:"pt-4 flex justify-end space-x-2 rtl:space-x-reverse border-t border-gray-200 dark:border-gray-700"},K=["disabled"],O=["disabled"],Q={key:0},R={key:1},W=V({__name:"BookAddModal",props:{lessons:{}},emits:["close","book-added"],setup(X,{emit:D}){const f=D,c=P(),n=p(!1),d=p(""),a=p(null),s=U({title:"",description:"",is_research:!1,is_transcript:!1,linked_lesson_id:null,cover_image_url:null});function F(o){const e=o.target;e.files&&e.files[0]?e.files[0].type==="application/pdf"?(a.value=e.files[0],d.value=""):(a.value=null,e.value="",d.value="الرجاء اختيار ملف PDF فقط."):a.value=null}async function C(){if(!a.value){d.value="الرجاء اختيار ملف PDF للكتاب.";return}n.value=!0,d.value="";try{const o=a.value,e=o.name.split(".").pop(),E=`${`${Date.now()}_${o.name.replace(/[^a-zA-Z0-9.]/g,"_")}`}`,{data:M,error:g}=await c.storage.from("book-files").upload(E,o);if(g)throw g.message.includes("Duplicate")?new Error("حدث خطأ: اسم الملف موجود مسبقًا. حاول إعادة تسمية الملف أو المحاولة مرة أخرى."):g.message.includes("policy")?new Error("حدث خطأ في الأذونات عند رفع الملف. تحقق من سياسات التخزين."):new Error(`خطأ في رفع ملف PDF: ${g.message}`);const x=M.path,b={...s,storage_path:x};b.linked_lesson_id===""&&(b.linked_lesson_id=null);const{error:v}=await c.from("books").insert(b);if(v){try{await c.storage.from("book-files").remove([x]),console.warn("Uploaded file removed due to DB insertion failure.")}catch(B){console.error("Failed to remove uploaded file after DB error:",B.message)}throw new Error(`خطأ في حفظ بيانات الكتاب: ${v.message}`)}console.log("Book added successfully!"),f("book-added"),f("close")}catch(o){console.error("Error submitting book form:",o.message),d.value=o.message||"حدث خطأ غير متوقع."}finally{n.value=!1}}function m(){n.value||f("close")}return(o,e)=>(i(),l("div",{class:"fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4",onClick:w(m,["self"])},[t("div",A,[t("div",N,[t("div",{class:"flex justify-between items-center pb-3 border-b border-gray-200 dark:border-gray-700"},[e[6]||(e[6]=t("h3",{class:"text-xl font-semibold text-gray-900 dark:text-white"},"إضافة كتاب/بحث جديد",-1)),t("button",{onClick:m,class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"},e[5]||(e[5]=[t("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),t("form",{onSubmit:w(C,["prevent"]),class:"mt-6 space-y-4"},[t("div",null,[e[7]||(e[7]=t("label",{for:"book-title",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"العنوان *",-1)),u(t("input",{type:"text",id:"book-title","onUpdate:modelValue":e[0]||(e[0]=r=>s.title=r),required:"",class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"},null,512),[[h,s.title]])]),t("div",null,[e[8]||(e[8]=t("label",{for:"book-description",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"الوصف",-1)),u(t("textarea",{id:"book-description","onUpdate:modelValue":e[1]||(e[1]=r=>s.description=r),rows:"3",class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"},null,512),[[h,s.description]])]),t("div",L,[t("div",z,[u(t("input",{id:"is_research","onUpdate:modelValue":e[2]||(e[2]=r=>s.is_research=r),type:"checkbox",class:"h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600"},null,512),[[_,s.is_research]]),e[9]||(e[9]=t("label",{for:"is_research",class:"ms-2 block text-sm text-gray-900 dark:text-gray-300"},"هل هو بحث؟",-1))]),t("div",I,[u(t("input",{id:"is_transcript","onUpdate:modelValue":e[3]||(e[3]=r=>s.is_transcript=r),type:"checkbox",class:"h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600"},null,512),[[_,s.is_transcript]]),e[10]||(e[10]=t("label",{for:"is_transcript",class:"ms-2 block text-sm text-gray-900 dark:text-gray-300"},"هل هو تفريغ؟",-1))])]),t("div",null,[e[12]||(e[12]=t("label",{for:"linked-lesson",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"ربط بدرس (اختياري)",-1)),u(t("select",{id:"linked-lesson","onUpdate:modelValue":e[4]||(e[4]=r=>s.linked_lesson_id=r),class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"},[e[11]||(e[11]=t("option",{value:null},"-- لا يوجد ربط --",-1)),(i(!0),l(S,null,$(o.lessons,r=>(i(),l("option",{key:r.id,value:r.id},y(r.title),9,T))),128))],512),[[j,s.linked_lesson_id]]),!o.lessons||o.lessons.length===0?(i(),l("p",Z," لا توجد دروس متاحة للربط حاليًا. ")):k("",!0)]),t("div",null,[e[13]||(e[13]=t("label",{for:"book-file",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"ملف الكتاب (PDF) *",-1)),t("input",{type:"file",id:"book-file",onChange:F,accept:".pdf",required:"",class:"mt-1 block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-gray-600 dark:file:text-gray-200 dark:hover:file:bg-gray-500"},null,32),a.value?(i(),l("p",G,"الملف المختار: "+y(a.value.name),1)):k("",!0)]),d.value?(i(),l("div",H,y(d.value),1)):k("",!0),t("div",J,[t("button",{type:"button",onClick:m,disabled:n.value,class:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500"}," إلغاء ",8,K),t("button",{type:"submit",disabled:n.value||!a.value,class:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50"},[n.value?(i(),l("span",Q,"جاري الحفظ...")):(i(),l("span",R,"حفظ الكتاب"))],8,O)])],32)])])]))}}),ee=q(W,[["__scopeId","data-v-59f59fb0"]]);export{ee as default};
