import{e as Q,u as W,r as f,g as X,A as N,l as Y,c as a,o as i,a as e,t as p,i as E,v as j,x,y as w,a6 as Z,F as z,j as B,a9 as ee,b as te,d as T,_ as oe}from"./CaF1xe-H.js";import{L as re}from"./CpjGp_h0.js";const le={class:"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"},se={class:"p-6"},ae={class:"flex justify-between items-center pb-3 border-b border-gray-200 dark:border-gray-700"},ie={class:"text-xl font-semibold text-gray-900 dark:text-white"},de={class:"mt-6 space-y-6"},ne=["value"],ue={class:"flex items-center"},ce={key:0,class:"pt-6 border-t border-gray-200 dark:border-gray-700"},me={key:0,class:"text-center py-4"},ge={key:1,class:"text-red-500 dark:text-red-400 bg-red-100 dark:bg-red-900/30 p-3 rounded-md text-sm"},be={key:2,class:"space-y-3"},ve={key:0,class:"text-center text-sm text-gray-500 dark:text-gray-400 py-3 px-4 bg-gray-50 dark:bg-gray-700/50 rounded-md"},pe={key:1,class:"space-y-2"},ye={class:"flex items-center space-x-3 rtl:space-x-reverse flex-grow min-w-0"},fe={class:"font-mono text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded flex-shrink-0"},xe=["title"],_e=["title"],ke={class:"flex items-center space-x-2 rtl:space-x-reverse flex-shrink-0"},he=["onClick","disabled"],we=["onClick","disabled"],De={key:2,class:"mt-4 p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700/30"},Me={class:"text-md font-semibold mb-3 text-gray-700 dark:text-gray-300"},$e={class:"grid grid-cols-1 sm:grid-cols-3 gap-3"},Ee=["for"],Ce=["id"],Ve={class:"sm:col-span-2"},qe=["for"],Ie=["id"],Se=["for"],Ue=["id"],Le={key:0,class:"text-red-500 text-xs p-2 bg-red-100 dark:bg-red-900/30 rounded border border-red-300 dark:border-red-700"},Ae={class:"flex justify-end space-x-2 rtl:space-x-reverse pt-2"},je=["disabled"],Fe=["disabled"],Ne={key:0},ze={key:1},Be={key:3,class:"mt-4"},Te={key:1,class:"text-red-600 dark:text-red-400 text-sm p-2 bg-red-100 dark:bg-red-900/30 rounded border border-red-300 dark:border-red-700"},Oe={class:"pt-6 flex justify-end space-x-2 rtl:space-x-reverse border-t border-gray-200 dark:border-gray-700"},Pe=["disabled"],Re=["disabled"],Ge={key:0},He={key:1},Je=Q({__name:"CourseAddEditModal",props:{courseData:{},categories:{}},emits:["close","saved"],setup(O,{emit:P}){const b=O,F=P,y=W(),D=f(!1),C=f(""),V=X(()=>{var o;return!!((o=b.courseData)!=null&&o.id)}),l=N({title:"",description:null,category_id:null,youtube_playlist_url:null,image_url:null,is_active:!1}),h=f([]),L=f(!1),I=f(null),q=f(!1),d=f(null),g=f(!1),_=f(null),n=N({module_number:null,title:"",description:null});Y(()=>b.courseData,o=>{console.log("Course data prop changed:",o),o!=null&&o.id?(console.log("Populating form for editing course ID:",o.id),Object.assign(l,{title:o.title,description:o.description,category_id:o.category_id,youtube_playlist_url:o.youtube_playlist_url,image_url:o.image_url,is_active:o.is_active??!1}),S()):(console.log("Resetting form for adding new course"),Object.assign(l,{title:"",description:null,category_id:null,youtube_playlist_url:null,image_url:null,is_active:!1}),h.value=[]),C.value="",U()},{immediate:!0,deep:!0});async function S(){var t;if(!V.value||!((t=b.courseData)!=null&&t.id)){console.log("Skipping module fetch: Not editing or no course ID."),h.value=[];return}const o=b.courseData.id;console.log(`Fetching modules for course ID: ${o}`),L.value=!0,I.value=null;try{const{data:u,error:c}=await y.from("course_modules").select("*").eq("course_id",o).order("module_number",{ascending:!0});if(c)throw c;h.value=u||[],console.log("Modules fetched:",h.value.length)}catch(u){console.error("Error fetching modules:",u),I.value=u.message||"Unknown error",h.value=[]}finally{L.value=!1}}function U(){q.value=!1,d.value=null,n.module_number=null,n.title="",n.description=null,_.value=null}function R(o){U(),d.value={...o},n.module_number=o.module_number,n.title=o.title,n.description=o.description,console.log("Started editing module:",d.value)}function G(){U()}async function H(){var u,c,v,s;if(!((u=b.courseData)!=null&&u.id))return;if(n.module_number===null||n.module_number<=0||!((c=n.title)!=null&&c.trim())){_.value="رقم الوحدة (أكبر من 0) واسم الوحدة مطلوبان.";return}g.value=!0,_.value=null;const o=b.courseData.id,t={course_id:o,module_number:n.module_number,title:n.title.trim(),description:((v=n.description)==null?void 0:v.trim())||null};try{let m;const k=t.module_number;if((s=d.value)!=null&&s.id){if(console.log(`Updating module ID: ${d.value.id}`),d.value.module_number!==k){const{data:r,error:$}=await y.from("course_modules").select("id").eq("course_id",o).eq("module_number",k).not("id","eq",d.value.id).maybeSingle();if($)throw $;if(r)throw new Error(`رقم الوحدة ${k} موجود بالفعل.`)}const{error:M}=await y.from("course_modules").update(t).eq("id",d.value.id);m=M}else{console.log(`Inserting new module for course ID: ${o}`);const{data:M,error:r}=await y.from("course_modules").select("id").eq("course_id",o).eq("module_number",k).maybeSingle();if(r)throw r;if(M)throw new Error(`رقم الوحدة ${k} موجود بالفعل.`);const{error:$}=await y.from("course_modules").insert(t);m=$}if(m)throw m;console.log("Module saved successfully."),U(),await S()}catch(m){console.error("Error saving module:",m),_.value=`فشل حفظ الوحدة: ${m.message}`}finally{g.value=!1}}async function J(o){var v;if(!((v=b.courseData)!=null&&v.id)||!o.id||!confirm(`هل أنت متأكد من حذف الوحدة "${o.title}" (رقم ${o.module_number})؟ 

تحذير: سيتم إلغاء ربط أي دروس حالية بهذه الوحدة.`))return;g.value=!0,_.value=null;const t=b.courseData.id,u=o.module_number,c=o.id;console.log(`Attempting to delete module ID: ${c}, Number: ${u}`);try{console.log(`Unlinking lessons with module_number ${u}`);const{error:s}=await y.from("lessons").update({module_number:null}).eq("course_id",t).eq("module_number",u);if(s)throw new Error(`فشل إلغاء ربط الدروس: ${s.message}`);console.log("Lessons unlinked."),console.log(`Deleting module record ID: ${c}`);const{error:m}=await y.from("course_modules").delete().eq("id",c);if(m)throw m;console.log("Module deleted."),await S()}catch(s){console.error("Error deleting module:",s),_.value=`فشل حذف الوحدة: ${s.message}`}finally{g.value=!1}}async function K(){var t,u,c,v;D.value=!0,C.value="";const o={title:l.title.trim(),description:((t=l.description)==null?void 0:t.trim())||null,category_id:l.category_id||null,youtube_playlist_url:((u=l.youtube_playlist_url)==null?void 0:u.trim())||null,image_url:((c=l.image_url)==null?void 0:c.trim())||null,is_active:l.is_active||!1};try{if(V.value&&((v=b.courseData)!=null&&v.id)){const{error:s}=await y.from("study_courses").update(o).eq("id",b.courseData.id);if(s)throw s}else{const{error:s}=await y.from("study_courses").insert(o);if(s)throw s}F("saved"),alert("تم حفظ تفاصيل الدورة بنجاح.")}catch(s){console.error("Error saving course details:",s.message),C.value=`فشل حفظ تفاصيل الدورة: ${s.message}`}finally{D.value=!1}}function A(){!D.value&&!g.value&&F("close")}return(o,t)=>{var u,c,v,s,m,k,M;return i(),a("div",{class:"fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4",onClick:j(A,["self"])},[e("div",le,[e("div",se,[e("div",ae,[e("h3",ie,p(V.value?"تعديل الدورة":"إضافة دورة جديدة"),1),e("button",{onClick:A,class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"},t[10]||(t[10]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),e("div",de,[e("section",null,[t[19]||(t[19]=e("h4",{class:"text-lg font-medium text-gray-800 dark:text-gray-200 mb-3"},"تفاصيل الدورة الأساسية",-1)),e("form",{onSubmit:j(K,["prevent"]),class:"space-y-4",id:"course-details-form"},[e("div",null,[t[11]||(t[11]=e("label",{for:"course-title",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"العنوان *",-1)),x(e("input",{type:"text",id:"course-title","onUpdate:modelValue":t[0]||(t[0]=r=>l.title=r),required:"",class:"admin-input"},null,512),[[w,l.title]])]),e("div",null,[t[12]||(t[12]=e("label",{for:"course-description",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"الوصف",-1)),x(e("textarea",{id:"course-description","onUpdate:modelValue":t[1]||(t[1]=r=>l.description=r),rows:"4",class:"admin-input"},null,512),[[w,l.description]])]),e("div",null,[t[14]||(t[14]=e("label",{for:"course-category",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"الفئة (اختياري)",-1)),x(e("select",{id:"course-category","onUpdate:modelValue":t[2]||(t[2]=r=>l.category_id=r),class:"admin-select"},[t[13]||(t[13]=e("option",{value:null},"-- اختر فئة --",-1)),(i(!0),a(z,null,B(o.categories,r=>(i(),a("option",{key:r.id,value:r.id},p(r.name),9,ne))),128))],512),[[Z,l.category_id]])]),e("div",null,[t[15]||(t[15]=e("label",{for:"course-youtube-playlist",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"رابط قائمة تشغيل يوتيوب (اختياري)",-1)),x(e("input",{type:"url",id:"course-youtube-playlist","onUpdate:modelValue":t[3]||(t[3]=r=>l.youtube_playlist_url=r),class:"admin-input",placeholder:"https://www.youtube.com/playlist?list=..."},null,512),[[w,l.youtube_playlist_url]])]),e("div",null,[t[16]||(t[16]=e("label",{for:"course-image-url",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"رابط صورة الغلاف (اختياري)",-1)),x(e("input",{type:"url",id:"course-image-url","onUpdate:modelValue":t[4]||(t[4]=r=>l.image_url=r),class:"admin-input",placeholder:"https://..."},null,512),[[w,l.image_url]]),t[17]||(t[17]=e("p",{class:"form-hint"},"أدخل رابطًا مباشرًا للصورة أو اترك الحقل فارغًا.",-1))]),e("div",ue,[x(e("input",{id:"is_active","onUpdate:modelValue":t[5]||(t[5]=r=>l.is_active=r),type:"checkbox",class:"h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600"},null,512),[[ee,l.is_active]]),t[18]||(t[18]=e("label",{for:"is_active",class:"ms-2 block text-sm text-gray-900 dark:text-gray-300"},"نشر الدورة (مرئية للطلاب)",-1))])],32)]),V.value&&((u=b.courseData)!=null&&u.id)?(i(),a("section",ce,[t[24]||(t[24]=e("h4",{class:"text-lg font-medium text-gray-800 dark:text-gray-200 mb-4"},"إدارة وحدات الدورة",-1)),L.value?(i(),a("div",me,[te(re,{small:""}),t[20]||(t[20]=e("p",{class:"text-sm text-gray-500 dark:text-gray-400 mt-2"},"جاري تحميل الوحدات...",-1))])):I.value?(i(),a("div",ge,[T(" حدث خطأ أثناء تحميل الوحدات: "+p(I.value)+" ",1),e("button",{onClick:S,class:"ms-2 underline font-semibold"},"إعادة المحاولة")])):(i(),a("div",be,[h.value.length===0&&!q.value?(i(),a("div",ve," لم يتم إضافة وحدات لهذه الدورة بعد. ")):(i(),a("ul",pe,[(i(!0),a(z,null,B(h.value,r=>(i(),a("li",{key:r.id,class:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-md border border-gray-200 dark:border-gray-600"},[e("div",ye,[e("span",fe,"#"+p(r.module_number),1),e("span",{class:"font-medium text-gray-800 dark:text-gray-200 truncate",title:r.title},p(r.title),9,xe),r.description?(i(),a("span",{key:0,class:"text-xs text-gray-500 dark:text-gray-400 truncate hidden sm:inline-block",title:r.description}," - "+p(r.description),9,_e)):E("",!0)]),e("div",ke,[e("button",{onClick:$=>R(r),type:"button",disabled:g.value,class:"button-icon text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300",title:"تعديل الوحدة"},t[21]||(t[21]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-4 h-4"},[e("path",{d:"M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z"})],-1)]),8,he),e("button",{onClick:$=>J(r),type:"button",disabled:g.value,class:"button-icon text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300",title:"حذف الوحدة"},t[22]||(t[22]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-4 h-4"},[e("path",{"fill-rule":"evenodd",d:"M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z","clip-rule":"evenodd"})],-1)]),8,we)])]))),128))])),q.value||d.value?(i(),a("div",De,[e("h5",Me,p(d.value?`تعديل الوحدة #${d.value.module_number}`:"إضافة وحدة جديدة"),1),e("form",{onSubmit:j(H,["prevent"]),class:"space-y-3"},[e("div",$e,[e("div",null,[e("label",{for:`module-number-${((c=d.value)==null?void 0:c.id)??"new"}`,class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"رقم الوحدة *",8,Ee),x(e("input",{type:"number",id:`module-number-${((v=d.value)==null?void 0:v.id)??"new"}`,"onUpdate:modelValue":t[6]||(t[6]=r=>n.module_number=r),required:"",min:"1",class:"admin-input mt-1"},null,8,Ce),[[w,n.module_number,void 0,{number:!0}]])]),e("div",Ve,[e("label",{for:`module-title-${((s=d.value)==null?void 0:s.id)??"new"}`,class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"اسم الوحدة *",8,qe),x(e("input",{type:"text",id:`module-title-${((m=d.value)==null?void 0:m.id)??"new"}`,"onUpdate:modelValue":t[7]||(t[7]=r=>n.title=r),required:"",class:"admin-input mt-1"},null,8,Ie),[[w,n.title]])])]),e("div",null,[e("label",{for:`module-description-${((k=d.value)==null?void 0:k.id)??"new"}`,class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"وصف الوحدة (اختياري)",8,Se),x(e("textarea",{id:`module-description-${((M=d.value)==null?void 0:M.id)??"new"}`,"onUpdate:modelValue":t[8]||(t[8]=r=>n.description=r),rows:"2",class:"admin-textarea mt-1"},null,8,Ue),[[w,n.description]])]),_.value?(i(),a("div",Le,p(_.value),1)):E("",!0),e("div",Ae,[e("button",{type:"button",onClick:G,disabled:g.value,class:"button-secondary-small"},"إلغاء",8,je),e("button",{type:"submit",disabled:g.value,class:"button-primary-small"},[g.value?(i(),a("span",Ne,"جاري الحفظ...")):(i(),a("span",ze,p(d.value?"حفظ التعديل":"إضافة الوحدة"),1))],8,Fe)])],32)])):E("",!0),!q.value&&!d.value?(i(),a("div",Be,[e("button",{onClick:t[9]||(t[9]=r=>q.value=!0),type:"button",class:"button-outline w-full sm:w-auto"},t[23]||(t[23]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-4 h-4 me-1"},[e("path",{d:"M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"})],-1),T(" إضافة وحدة جديدة ")]))])):E("",!0)]))])):E("",!0),C.value?(i(),a("div",Te,p(C.value),1)):E("",!0),e("div",Oe,[e("button",{type:"button",onClick:A,disabled:D.value||g.value,class:"button-secondary"},"إغلاق",8,Pe),e("button",{type:"submit",form:"course-details-form",disabled:D.value||g.value,class:"button-primary"},[D.value?(i(),a("span",Ge,"جاري حفظ التفاصيل...")):(i(),a("span",He,p(V.value?"حفظ تفاصيل الدورة":"إضافة الدورة"),1))],8,Re)])])])])])}}}),We=oe(Je,[["__scopeId","data-v-7feb0fe3"]]);export{We as default};
