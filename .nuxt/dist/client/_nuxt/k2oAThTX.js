import{_ as H}from"./CEyFpblA.js";import{e as R,r as k,g as N,c as l,o as s,b as $,a as r,w as C,i as A,t as w,d as S,p as V,_ as F,u as O,E as U,a0 as q,A as z,f as J,l as P,h as p,F as W,j as G,z as E}from"./CaF1xe-H.js";import{L as K}from"./CpjGp_h0.js";import{u as Q}from"./CqvecxAQ.js";import{u as X}from"./C0vmt3Ib.js";const Y={class:"bg-white dark:bg-gray-800 rounded-lg shadow border border-cream-gray dark:border-gray-700/50 overflow-hidden group transition-shadow duration-300 hover:shadow-lg flex flex-col"},I=["src","alt"],ee={key:0,class:"absolute inset-0 flex items-center justify-center bg-gray-200 dark:bg-gray-700 text-gray-400 dark:text-gray-500"},re={class:"p-4 flex flex-col flex-grow"},te={class:"font-semibold text-lg mb-1 line-clamp-2 text-brown-dark dark:text-beige-light group-hover:text-olive-green transition-colors duration-200"},se={class:"text-sm text-gray-600 dark:text-gray-400 line-clamp-3 mb-3 flex-grow"},oe={class:"text-xs text-gray-500 dark:text-gray-400 flex items-center justify-between mt-2"},le={key:0},ae={class:"px-4 pb-4 mt-auto"},ne=["disabled"],ie={key:0},de={key:1},ce=R({__name:"CourseCard",props:{course:{},lessonCount:{},isEnrolled:{type:Boolean}},emits:["enroll"],setup(j,{emit:v}){const h=j,y=v,b=k(!1),f=k(!1),_=N(()=>h.course.image_url||"/images/placeholder-course.jpg"),a=N(()=>`/study/courses/${h.course.id}`);function d(){b.value=!0}function x(){y("enroll",h.course.id)}return(c,u)=>{const g=H;return s(),l("div",Y,[$(g,{to:a.value,class:"block relative aspect-video overflow-hidden"},{default:C(()=>[r("img",{src:_.value,alt:`غلاف دورة: ${c.course.title}`,class:"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105",loading:"lazy",decoding:"async",onError:d},null,40,I),b.value?(s(),l("div",ee,u[0]||(u[0]=[r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-10 h-10"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm16.5-5.818V18"})],-1)]))):A("",!0)]),_:1},8,["to"]),r("div",re,[$(g,{to:a.value},{default:C(()=>[r("h3",te,w(c.course.title),1)]),_:1},8,["to"]),r("p",se,w(c.course.description||"..."),1),r("div",oe,[c.lessonCount!==void 0?(s(),l("span",le,[u[1]||(u[1]=r("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",fill:"currentColor",class:"w-3.5 h-3.5 inline-block align-middle me-1"},[r("path",{d:"M2 2.75C2 1.784 2.784 1 3.75 1h8.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 12.25 15h-8.5A1.75 1.75 0 0 1 2 13.25V2.75Z"}),r("path",{d:"M4.75 5a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5ZM4 9.75A.75.75 0 0 1 4.75 9h6.5a.75.75 0 0 1 0 1.5h-6.5A.75.75 0 0 1 4 9.75Z"})],-1)),S(" "+w(c.lessonCount)+" "+w(c.lessonCount===1?"درس":c.lessonCount<=10?"دروس":"درس"),1)])):A("",!0)])]),r("div",ae,[c.isEnrolled?(s(),V(g,{key:1,to:a.value,class:"w-full button-view"},{default:C(()=>u[2]||(u[2]=[S(" عرض الدورة ")])),_:1},8,["to"])):(s(),l("button",{key:0,onClick:x,disabled:f.value,class:"w-full button-enroll"},[f.value?(s(),l("span",de,"جاري الانتساب...")):(s(),l("span",ie,"انتساب للدورة"))],8,ne))])])}}}),ue=F(ce,[["__scopeId","data-v-8bfecfbf"]]),ge={class:"container mx-auto px-4 py-8 md:py-12"},me={key:0,class:"text-center py-20"},pe={key:1,class:"text-center py-10 px-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/50 rounded-lg max-w-lg mx-auto shadow-md"},fe={class:"text-sm text-red-700 dark:text-red-300 mb-5"},ve={key:2,class:"text-center py-16 text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/20"},he={key:3,class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-8"},ye={key:4},xe=R({__name:"index",async setup(j){let v,h;const y=O(),b=U(),{profile:f,isLoggedIn:_}=q(b),a=k([]),d=k([]),x=z({}),{data:c,pending:u,error:g,refresh:L}=([v,h]=J(async()=>Q("studyCoursesAndEnrollmentsList",async()=>{var B,Z;const t=(B=f.value)==null?void 0:B.id;console.log(`[useAsyncData] Fetching study data. User ID: ${t??"Guest"}`);const e=await Promise.allSettled([y.from("study_courses").select(`
                  *,
                  lessons!fk_lessons_course_id(count),
                  category:categories ( name )
                `).eq("is_active",!0).order("created_at",{ascending:!1}),_.value&&t?y.from("course_enrollments").select("course_id").eq("user_id",t):Promise.resolve({data:[],error:null})]);let o=[];if(e[0].status==="fulfilled"){const m=e[0].value;if(m.error){const i=m.error;throw console.error("Supabase error fetching courses (START) -----------"),console.error("Message:",i.message),console.error("Code:",i.code),console.error("Details:",i.details),console.error("Hint:",i.hint),console.error("Full error object for inspection:",JSON.stringify(i,null,2)),console.error("Supabase error fetching courses (END) -------------"),String(i.message).includes("more than one relationship")?new Error(`فشل جلب الدورات: ${i.message||"التباس في تعريف العلاقات"}. هناك التباس في تعريف العلاقات بين الجداول.`):new Error(`فشل جلب الدورات: ${i.message||"خطأ غير معروف من Supabase."}`)}o=m.data||[],console.log(`[useAsyncData] Raw courses fetched: ${o.length}`)}else throw console.error("Failed promise fetching courses (Rejected):",e[0].reason),console.error("Rejection reason details:",JSON.stringify(e[0].reason,null,2)),new Error(`فشل الاتصال لجلب الدورات: ${((Z=e[0].reason)==null?void 0:Z.message)||"سبب غير معروف."}`);let n=[];return e[1].status==="fulfilled"?e[1].value.error?console.warn("Supabase error fetching enrollments (continuing):",e[1].value.error.message):(n=e[1].value.data||[],console.log(`[useAsyncData] Enrollments fetched: ${n.length}`)):console.warn("Failed promise fetching user enrollments (continuing):",e[1].reason),{courses:o.map(m=>{var i,D,M;return{...m,lessons_count:((D=(i=m.lessons)==null?void 0:i[0])==null?void 0:D.count)??0,category_name:((M=m.category)==null?void 0:M.name)??null,lessons:void 0,category:void 0}}),enrollments:n.map(m=>m.course_id)}},{default:()=>({courses:[],enrollments:[]}),watch:[()=>{var t;return(t=f.value)==null?void 0:t.id}]})),v=await v,h(),v);P(c,t=>{t?(a.value=t.courses||[],d.value=t.enrollments||[],console.log("[Watch] Local state updated. Courses:",a.value.length,"Enrollments:",d.value.length)):!u.value&&!g.value&&(console.warn("[Watch] useAsyncData returned null/undefined data unexpectedly."),a.value=[],d.value=[])},{immediate:!0});async function T(t){var e;if(!_.value||!((e=f.value)!=null&&e.id)){alert("يجب تسجيل الدخول أولاً للانتساب للدورة."),E(`/login?redirect=${window.location.pathname}`);return}if(d.value.includes(t)){alert("أنت منتسب بالفعل لهذه الدورة."),E(`/study/courses/${t}`);return}x[t]=!0,console.log(`[handleEnroll] Attempting enrollment for course ${t}...`);try{const{error:o}=await y.from("course_enrollments").insert({user_id:f.value.id,course_id:t}).select("course_id").single();if(o)if(o.code==="23505")console.warn(`Enrollment conflict for course ${t}. Syncing state.`),alert("أنت منتسب بالفعل لهذه الدورة (تم تحديث الحالة)."),d.value.includes(t)||d.value.push(t);else throw o;else console.log(`[handleEnroll] Enrollment successful for course ${t}.`),d.value.push(t),alert("تم الانتساب للدورة بنجاح!"),E(`/study/courses/${t}`)}catch(o){console.error(`[handleEnroll] Error enrolling in course ${t}:`,o),alert(`فشل الانتساب للدورة: ${o.message||"حدث خطأ غير متوقع."}`)}finally{x[t]=!1}}return X({title:"الدورات الدراسية - موقع الشيخ إبراهيم بشندي",meta:[{name:"description",content:"تصفح والتحق بالدورات الدراسية المنهجية للشيخ إبراهيم بشندي في مختلف العلوم الشرعية."},{property:"og:title",content:"الدورات الدراسية - موقع الشيخ إبراهيم بشندي"},{property:"og:description",content:"دورات علمية منهجية ومتخصصة في العلوم الشرعية، متاحة للتعلم والدراسة عبر الإنترنت."},{property:"og:type",content:"website"}]}),(t,e)=>{var o;return s(),l("div",ge,[e[6]||(e[6]=r("h2",{class:"text-3xl font-bold text-brown-dark dark:text-beige-light mb-6 md:mb-8 border-b-2 border-primary pb-3"}," الدورات الدراسية المنهجية ",-1)),p(u)?(s(),l("div",me,[$(K,{class:"w-12 h-12 mx-auto text-primary"}),e[1]||(e[1]=r("p",{class:"mt-4 text-base text-gray-600 dark:text-gray-400"},"جارٍ تحميل الدورات المتاحة...",-1))])):p(g)?(s(),l("div",pe,[e[3]||(e[3]=r("div",{class:"flex justify-center items-center text-red-600 dark:text-red-400 mb-4"},[r("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-7 h-7","aria-hidden":"true"},[r("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-8-5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5A.75.75 0 0 1 10 5Zm0 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z","clip-rule":"evenodd"})]),r("h3",{class:"text-xl font-semibold ms-2"},"خطأ في تحميل الدورات")],-1)),r("p",fe,w(((o=p(g).data)==null?void 0:o.message)||p(g).message||"حدث خطأ غير متوقع أثناء محاولة جلب قائمة الدورات. يرجى المحاولة مرة أخرى."),1),r("button",{onClick:e[0]||(e[0]=(...n)=>p(L)&&p(L)(...n)),class:"button-secondary border-red-300 dark:border-red-600 text-red-700 dark:text-red-200 bg-red-100 dark:bg-red-800/60 hover:bg-red-200 dark:hover:bg-red-700/70 focus:ring-red-500 inline-flex items-center gap-1.5"},e[2]||(e[2]=[r("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-4 h-4","aria-hidden":"true"},[r("path",{"fill-rule":"evenodd",d:"M15.312 11.424a5.5 5.5 0 0 1-9.201 2.466l-.312-.311h2.433a.75.75 0 0 0 0-1.5H3.984a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0v-2.432l.311.31a7 7 0 0 0 11.767-3.18.75.75 0 1 0-1.475-.292ZM4.688 8.576a5.5 5.5 0 0 1 9.201-2.466l.312.311h-2.433a.75.75 0 0 0 0 1.5h4.516a.75.75 0 0 0 .75-.75v-4.5a.75.75 0 0 0-1.5 0v2.432l-.311-.31a7 7 0 0 0-11.767 3.18.75.75 0 0 0 1.475.292Z","clip-rule":"evenodd"})],-1),S(" إعادة المحاولة ")]))])):Array.isArray(a.value)&&a.value.length===0?(s(),l("div",ve,e[4]||(e[4]=[r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-12 h-12 mx-auto mb-4 text-gray-400 dark:text-gray-500","aria-hidden":"true"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"})],-1),r("p",{class:"text-lg font-medium"},"لا توجد دورات دراسية متاحة حاليًا.",-1),r("p",{class:"text-sm mt-1 text-gray-400 dark:text-gray-500"},"سيتم إضافة دورات جديدة قريبًا بإذن الله، تابعنا للمزيد.",-1)]))):Array.isArray(a.value)&&a.value.length>0?(s(),l("div",he,[(s(!0),l(W,null,G(a.value,n=>(s(),V(ue,{key:n.id,course:n,"lesson-count":n.lessons_count,"category-name":n.category_name,"is-enrolled":d.value.includes(n.id),"enroll-loading":x[n.id]||!1,onEnroll:T},null,8,["course","lesson-count","category-name","is-enrolled","enroll-loading"]))),128))])):!p(u)&&!p(g)?(s(),l("div",ye,e[5]||(e[5]=[r("p",{class:"text-center py-10 text-gray-400 dark:text-gray-500 italic"},"حالة عرض الدورات غير معروفة.",-1)]))):A("",!0)])}}}),$e=F(xe,[["__scopeId","data-v-198b0e3b"]]);export{$e as default};
