import{e as L,u as T,r as y,A as E,k as P,p as j,o as i,w as c,b as f,h as p,a as t,t as m,v as q,c as n,i as I,x as v,y as $,a9 as B,F as z,j as G,a6 as O,d as R,_ as Y}from"./CaF1xe-H.js";import{Y as K,h as D,G as Z,V as H,S as J}from"./vWwLff75.js";const Q={class:"fixed inset-0 overflow-y-auto"},W={class:"flex min-h-full items-center justify-center p-4 text-center"},X={class:"truncate"},ee={class:"flex space-x-4 rtl:space-x-reverse"},te={class:"flex items-center"},se={class:"flex items-center"},le=["value"],oe={key:0,class:"mt-1 text-xs text-indigo-600 dark:text-indigo-400"},ae={key:1,class:"mt-1 text-xs text-green-600 dark:text-green-400"},ie={key:2,class:"mt-1 text-xs text-red-500 dark:text-red-400"},re={key:0,class:"text-red-600 dark:text-red-400 text-sm bg-red-100 dark:bg-red-900/30 p-3 rounded-md"},ne={class:"pt-4 flex justify-end space-x-2 rtl:space-x-reverse border-t border-gray-200 dark:border-gray-700 flex-shrink-0"},de=["disabled"],ue=["disabled"],ce={key:0},pe={key:1},M="book-files",fe=L({__name:"BookEditModal",props:{book:{},lessons:{}},emits:["close","book-updated"],setup(S,{emit:V}){const U=S,b=V,x=T(),d=y(!1),u=y(""),r=y(null),o=E({...U.book}),l=E({title:"",description:"",is_research:!1,is_transcript:!1,linked_lesson_id:null,cover_image_url:null});P(()=>{l.title=o.title,l.description=o.description||"",l.is_research=o.is_research||!1,l.is_transcript=o.is_transcript||!1,l.linked_lesson_id=o.linked_lesson_id,l.cover_image_url=o.cover_image_url});function F(a){const e=a.target;e.files&&e.files[0]?e.files[0].type==="application/pdf"?(r.value=e.files[0],u.value=""):(r.value=null,e.value="",u.value="الرجاء اختيار ملف PDF فقط."):r.value=null}async function N(){d.value=!0,u.value="";let a=o.storage_path;const e=o.storage_path;try{if(r.value){const k=r.value,me=k.name.split(".").pop(),h=`public/${`${Date.now()}_${k.name.replace(/[^a-zA-Z0-9.]/g,"_")}`}`;console.log(`Attempting to upload new file to: ${h}`);const{data:A,error:w}=await x.storage.from(M).upload(h,k);if(w)throw new Error(`فشل رفع الملف الجديد: ${w.message}`);if(a=A.path,console.log(`New file uploaded successfully: ${a}`),e&&e!==a){console.log(`Attempting to remove old file: ${e}`);const{error:C}=await x.storage.from(M).remove([e]);C?(console.warn(`Could not delete old file ${e}:`,C.message),alert(`تم تحديث بيانات الكتاب ورفع الملف الجديد، ولكن فشل حذف الملف القديم (${e}) من التخزين.`)):console.log(`Old file ${e} removed successfully.`)}}const s={...l,storage_path:a};s.linked_lesson_id===""&&(s.linked_lesson_id=null),console.log(`Updating book ID ${o.id} with data:`,s);const{error:g}=await x.from("books").update(s).eq("id",o.id);if(g)throw console.error("DB Update Error:",g),r.value&&a&&console.error(`CRITICAL: DB update failed after uploading new file: ${a}. Manual cleanup of this file might be needed.`),new Error(`فشل تحديث بيانات الكتاب: ${g.message}`);console.log("Book updated successfully!"),b("book-updated"),b("close")}catch(s){console.error("Error in handleSubmit (Edit):",s),u.value=s.message||"حدث خطأ غير متوقع."}finally{d.value=!1}}function _(){d.value||b("close")}return(a,e)=>(i(),j(p(J),{appear:"",show:!0,as:"div"},{default:c(()=>[f(p(K),{as:"div",onClose:_,class:"relative z-50"},{default:c(()=>[f(p(D),{as:"div",enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:c(()=>e[5]||(e[5]=[t("div",{class:"fixed inset-0 bg-black bg-opacity-60 dark:bg-gray-900 dark:bg-opacity-75"},null,-1)])),_:1}),t("div",Q,[t("div",W,[f(p(D),{as:"div",enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:c(()=>[f(p(Z),{class:"w-full max-w-2xl transform overflow-hidden rounded-2xl bg-beige-light dark:bg-cream-gray p-6 text-end shadow-xl transition-all flex flex-col max-h-[90vh]"},{default:c(()=>[f(p(H),{as:"h3",class:"text-lg font-medium leading-6 text-brown-dark dark:text-brown-dark mb-4 flex justify-between items-center flex-shrink-0"},{default:c(()=>[t("button",{type:"button",class:"button-close",onClick:_,"aria-label":"إغلاق"},e[6]||(e[6]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20"},[t("title",null,"إغلاق"),t("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1),t("span",{class:"hidden sm:inline ms-1"},"إغلاق",-1)])),t("span",X,"تعديل الكتاب: "+m(o.title),1)]),_:1}),t("form",{onSubmit:q(N,["prevent"]),class:"mt-2 flex-grow space-y-4 overflow-y-auto px-1"},[t("div",null,[e[7]||(e[7]=t("label",{for:"edit-book-title",class:"form-label"},"العنوان *",-1)),v(t("input",{type:"text",id:"edit-book-title","onUpdate:modelValue":e[0]||(e[0]=s=>l.title=s),required:"",class:"form-input"},null,512),[[$,l.title]])]),t("div",null,[e[8]||(e[8]=t("label",{for:"edit-book-description",class:"form-label"},"الوصف",-1)),v(t("textarea",{id:"edit-book-description","onUpdate:modelValue":e[1]||(e[1]=s=>l.description=s),rows:"3",class:"form-input"},null,512),[[$,l.description]])]),t("div",ee,[t("div",te,[v(t("input",{id:"edit-is_research","onUpdate:modelValue":e[2]||(e[2]=s=>l.is_research=s),type:"checkbox",class:"form-checkbox"},null,512),[[B,l.is_research]]),e[9]||(e[9]=t("label",{for:"edit-is_research",class:"ms-2 form-label-inline"},"هل هو بحث؟",-1))]),t("div",se,[v(t("input",{id:"edit-is_transcript","onUpdate:modelValue":e[3]||(e[3]=s=>l.is_transcript=s),type:"checkbox",class:"form-checkbox"},null,512),[[B,l.is_transcript]]),e[10]||(e[10]=t("label",{for:"edit-is_transcript",class:"ms-2 form-label-inline"},"هل هو تفريغ؟",-1))])]),t("div",null,[e[12]||(e[12]=t("label",{for:"edit-linked-lesson",class:"form-label"},"ربط بدرس (اختياري)",-1)),v(t("select",{id:"edit-linked-lesson","onUpdate:modelValue":e[4]||(e[4]=s=>l.linked_lesson_id=s),class:"form-select"},[e[11]||(e[11]=t("option",{value:null},"-- لا يوجد ربط --",-1)),(i(!0),n(z,null,G(a.lessons,s=>(i(),n("option",{key:s.id,value:s.id},m(s.title),9,le))),128))],512),[[O,l.linked_lesson_id]])]),t("div",null,[e[13]||(e[13]=t("label",{for:"edit-book-file",class:"form-label"},[R(" ملف الكتاب (PDF) "),t("span",{class:"text-xs text-gray-500 dark:text-gray-400"},"(اختياري: اختر ملفًا جديدًا لاستبدال الملف الحالي)")],-1)),t("input",{type:"file",id:"edit-book-file",onChange:F,accept:".pdf",class:"form-file-input"},null,32),r.value?(i(),n("p",oe,"الملف الجديد المختار: "+m(r.value.name),1)):o.storage_path?(i(),n("p",ae,"الملف الحالي: "+m(o.storage_path.split("/").pop()),1)):(i(),n("p",ie,"لا يوجد ملف مرفق حاليًا."))]),u.value?(i(),n("div",re,m(u.value),1)):I("",!0),t("div",ne,[t("button",{type:"button",onClick:_,disabled:d.value,class:"button-secondary"}," إلغاء ",8,de),t("button",{type:"submit",disabled:d.value,class:"button-primary"},[d.value?(i(),n("span",ce,"جاري الحفظ...")):(i(),n("span",pe,"حفظ التعديلات"))],8,ue)])],32)]),_:1})]),_:1})])])]),_:1})]),_:1}))}}),_e=Y(fe,[["__scopeId","data-v-b4948731"]]);export{_e as default};
