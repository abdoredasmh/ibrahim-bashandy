import{e as J,u as K,N as R,r as p,g as W,l as N,p as O,o as u,w as y,b as w,a,h as g,d as B,t as b,v as X,c as i,i as f,x as m,y as c,a6 as V,F as U,j as L,a9 as Z,_ as ee}from"./CaF1xe-H.js";import{L as te}from"./CpjGp_h0.js";import{h as I,G as le,V as ae,Y as se,S as ue}from"./vWwLff75.js";const ie={class:"fixed inset-0 overflow-y-auto"},oe={class:"flex min-h-full items-center justify-center p-4 text-center"},re={class:"mt-4 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2"},ne={class:"sm:col-span-2"},de={class:"sm:col-span-2"},me={key:0},ve={key:0,class:"mt-1 text-sm text-gray-500"},pe=["value"],fe={key:0,disabled:""},ce={key:1},ye={key:0,class:"mt-1 text-sm text-gray-500"},ge=["value"],be={key:2},_e={key:0,class:"mt-1 text-sm text-gray-500"},xe=["disabled"],ke=["value"],qe={key:0,disabled:""},ze={key:1,disabled:""},we={key:3},Ce={class:"sm:col-span-2"},Ve={class:"flex items-center"},he={key:0,class:"mt-4 text-sm text-red-600 dark:text-red-400"},De={class:"mt-6 flex justify-start gap-3 border-t dark:border-gray-700 pt-5"},Se=["disabled"],Ee=["disabled"],Ue=J({__name:"QuizCreateEditModal",props:{modelValue:{type:Boolean,default:!1},quizData:{type:Object,default:null}},emits:["update:modelValue","saved","closed"],setup(Q,{emit:T}){const d=Q,h=T,_=K(),{$toast:Le}=R(),D=p(d.modelValue),o=p(!1),r=p(null),t=p({}),x=p([]),v=p([]),k=p(!1),q=p(!1),n=p(null),z=W(()=>{var s;return!!((s=d.quizData)!=null&&s.id)}),G=s=>{if(!s)return"";try{const e=new Date(s);return e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.toISOString().slice(0,16)}catch{return""}};N(()=>d.modelValue,s=>{D.value=s,s&&(M(),$())}),N(()=>d.quizData,s=>{M()},{deep:!0});const M=()=>{r.value=null,o.value=!1,z.value&&d.quizData?(t.value={...d.quizData,due_date:G(d.quizData.due_date),max_attempts:d.quizData.max_attempts??null,time_limit_minutes:d.quizData.time_limit_minutes??null,module_number:d.quizData.module_number??null},t.value.type==="lesson"&&t.value.lesson_id?Y(t.value.lesson_id):(n.value=null,v.value=[])):(t.value={title:"",description:null,type:null,course_id:null,lesson_id:null,module_number:null,pass_mark_percentage:50,max_attempts:null,time_limit_minutes:null,due_date:null,is_active:!0},n.value=null,v.value=[])},Y=async s=>{q.value=!0;try{const{data:e,error:l}=await _.from("lessons").select("course_id").eq("id",s).single();l||!(e!=null&&e.course_id)?(console.error("Could not find course for lesson:",s,l),n.value=null,v.value=[]):(n.value=e.course_id,await F())}catch(e){console.error("Error in findCourseForLesson:",e),n.value=null,v.value=[]}finally{}},$=async()=>{if(!(x.value.length>0)){k.value=!0;try{const{data:s,error:e}=await _.from("study_courses").select("id, title").order("title");if(e)throw e;x.value=s||[]}catch(s){console.error("Error fetching courses:",s),r.value="فشل تحميل قائمة الدورات."}finally{k.value=!1}}},F=async()=>{var s;if(v.value=[],t.value.lesson_id=null,!(!n.value||t.value.type!=="lesson")){q.value=!0;try{const{data:e,error:l}=await _.from("lessons").select("id, title").eq("course_id",n.value).order("lesson_order",{nulls:"last"}).order("title");if(l)throw l;v.value=e||[],z.value&&((s=d.quizData)!=null&&s.lesson_id)&&(t.value.lesson_id=d.quizData.lesson_id)}catch(e){console.error("Error fetching lessons:",e),r.value="فشل تحميل قائمة الدروس لهذه الدورة."}finally{q.value=!1}}},A=()=>{t.value.course_id=null,t.value.lesson_id=null,t.value.module_number=null,n.value=null,v.value=[]},P=()=>{t.value.lesson_id=null},H=async()=>{var e;if(o.value=!0,r.value=null,!((e=t.value.title)!=null&&e.trim())){r.value="عنوان الاختبار مطلوب.",o.value=!1;return}if(!t.value.type){r.value="نوع الاختبار مطلوب.",o.value=!1;return}if(t.value.type==="lesson"&&!t.value.lesson_id){r.value="يجب اختيار درس لاختبار الدرس.",o.value=!1;return}if((t.value.type==="module"||t.value.type==="final")&&!t.value.course_id){r.value="يجب اختيار دورة لاختبار الوحدة أو الاختبار النهائي.",o.value=!1;return}if(t.value.type==="module"&&(!t.value.module_number||t.value.module_number<1)){r.value="رقم الوحدة مطلوب وصحيح لاختبار الوحدة.",o.value=!1;return}if(t.value.pass_mark_percentage===null||t.value.pass_mark_percentage===void 0||t.value.pass_mark_percentage<0||t.value.pass_mark_percentage>100){r.value="درجة النجاح يجب أن تكون بين 0 و 100.",o.value=!1;return}if(t.value.max_attempts!==null&&t.value.max_attempts<1){r.value="عدد المحاولات يجب أن يكون 1 أو أكثر (أو يترك فارغًا).",o.value=!1;return}if(t.value.time_limit_minutes!==null&&t.value.time_limit_minutes<1){r.value="الوقت المحدد يجب أن يكون دقيقة واحدة أو أكثر.",o.value=!1;return}const s={title:t.value.title,description:t.value.description||null,type:t.value.type,course_id:t.value.type==="module"||t.value.type==="final"?t.value.course_id:null,lesson_id:t.value.type==="lesson"?t.value.lesson_id:null,module_number:t.value.type==="module"?t.value.module_number:null,pass_mark_percentage:t.value.pass_mark_percentage??50,max_attempts:t.value.max_attempts||null,time_limit_minutes:t.value.time_limit_minutes||null,due_date:t.value.due_date?new Date(t.value.due_date).toISOString():null,is_active:t.value.is_active??!0};try{let l=null,C=null;if(z.value&&t.value.id){const{data:S,error:E}=await _.from("quizzes").update({...s,updated_at:new Date().toISOString()}).eq("id",t.value.id).select().single();l=S,C=E}else{const{data:S,error:E}=await _.from("quizzes").insert(s).select().single();l=S,C=E}if(C)throw C;if(!l)throw new Error("لم يتم إرجاع بيانات الاختبار المحفوظة.");h("saved",l)}catch(l){console.error("Error saving quiz:",l),r.value=`فشل حفظ الاختبار: (${l.message||"خطأ غير معروف"})`}finally{o.value=!1}};function j(){o.value||(D.value=!1,h("update:modelValue",!1),h("closed"))}return(s,e)=>(u(),O(g(ue),{appear:"",show:D.value,as:"template"},{default:y(()=>[w(g(se),{as:"div",onClose:j,class:"relative z-40"},{default:y(()=>[w(g(I),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:y(()=>e[12]||(e[12]=[a("div",{class:"fixed inset-0 bg-black/40 backdrop-blur-sm","aria-hidden":"true"},null,-1)])),_:1}),a("div",ie,[a("div",oe,[w(g(I),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:y(()=>[w(g(le),{class:"w-full max-w-2xl transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 p-6 text-right shadow-xl transition-all"},{default:y(()=>[w(g(ae),{as:"h3",class:"text-lg font-semibold leading-6 text-gray-900 dark:text-gray-100 mb-4 border-b dark:border-gray-700 pb-3"},{default:y(()=>[B(b(z.value?"تعديل الاختبار":"إنشاء اختبار جديد"),1)]),_:1}),a("form",{onSubmit:X(H,["prevent"])},[a("div",re,[a("div",ne,[e[13]||(e[13]=a("label",{for:"quiz-title",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"عنوان الاختبار *",-1)),m(a("input",{type:"text",id:"quiz-title","onUpdate:modelValue":e[0]||(e[0]=l=>t.value.title=l),required:"",class:"mt-1 block w-full input-field"},null,512),[[c,t.value.title]])]),a("div",de,[e[14]||(e[14]=a("label",{for:"quiz-description",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"الوصف (اختياري)",-1)),m(a("textarea",{id:"quiz-description","onUpdate:modelValue":e[1]||(e[1]=l=>t.value.description=l),rows:"3",class:"mt-1 block w-full input-field"},null,512),[[c,t.value.description]])]),a("div",null,[e[16]||(e[16]=a("label",{for:"quiz-type",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"نوع الاختبار *",-1)),m(a("select",{id:"quiz-type","onUpdate:modelValue":e[2]||(e[2]=l=>t.value.type=l),required:"",onChange:A,class:"mt-1 block w-full input-field"},e[15]||(e[15]=[a("option",{value:null,disabled:""},"-- اختر النوع --",-1),a("option",{value:"lesson"},"اختبار درس",-1),a("option",{value:"module"},"اختبار وحدة",-1),a("option",{value:"final"},"اختبار نهائي",-1)]),544),[[V,t.value.type]])]),t.value.type==="module"||t.value.type==="final"?(u(),i("div",me,[e[18]||(e[18]=a("label",{for:"quiz-course",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"الدورة الدراسية *",-1)),k.value?(u(),i("div",ve,"جار تحميل الدورات...")):m((u(),i("select",{key:1,id:"quiz-course","onUpdate:modelValue":e[3]||(e[3]=l=>t.value.course_id=l),required:"",onChange:P,class:"mt-1 block w-full input-field"},[e[17]||(e[17]=a("option",{value:null,disabled:""},"-- اختر الدورة --",-1)),(u(!0),i(U,null,L(x.value,l=>(u(),i("option",{key:l.id,value:l.id},b(l.title),9,pe))),128)),!k.value&&x.value.length===0?(u(),i("option",fe,"-- لا توجد دورات --")):f("",!0)],544)),[[V,t.value.course_id]])])):f("",!0),t.value.type==="lesson"?(u(),i("div",ce,[e[20]||(e[20]=a("label",{for:"quiz-lesson-course",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"الدورة (لتحديد الدرس) *",-1)),k.value?(u(),i("div",ye,"جار تحميل الدورات...")):m((u(),i("select",{key:1,id:"quiz-lesson-course","onUpdate:modelValue":e[4]||(e[4]=l=>n.value=l),required:"",onChange:F,class:"mt-1 block w-full input-field"},[e[19]||(e[19]=a("option",{value:null,disabled:""},"-- اختر دورة لعرض دروسها --",-1)),(u(!0),i(U,null,L(x.value,l=>(u(),i("option",{key:l.id,value:l.id},b(l.title),9,ge))),128))],544)),[[V,n.value]])])):f("",!0),t.value.type==="lesson"?(u(),i("div",be,[e[22]||(e[22]=a("label",{for:"quiz-lesson",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"الدرس *",-1)),q.value?(u(),i("div",_e,"جار تحميل الدروس...")):m((u(),i("select",{key:1,id:"quiz-lesson","onUpdate:modelValue":e[5]||(e[5]=l=>t.value.lesson_id=l),required:"",disabled:!n.value||v.value.length===0,class:"mt-1 block w-full input-field"},[e[21]||(e[21]=a("option",{value:null,disabled:""},"-- اختر الدرس --",-1)),(u(!0),i(U,null,L(v.value,l=>(u(),i("option",{key:l.id,value:l.id},b(l.title),9,ke))),128)),!q.value&&v.value.length===0&&n.value?(u(),i("option",qe,"-- لا توجد دروس لهذه الدورة --")):f("",!0),n.value?f("",!0):(u(),i("option",ze,"-- اختر دورة أولاً --"))],8,xe)),[[V,t.value.lesson_id]])])):f("",!0),t.value.type==="module"?(u(),i("div",we,[e[23]||(e[23]=a("label",{for:"quiz-module",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"رقم الوحدة *",-1)),m(a("input",{type:"number",id:"quiz-module","onUpdate:modelValue":e[6]||(e[6]=l=>t.value.module_number=l),required:"",min:"1",class:"mt-1 block w-full input-field"},null,512),[[c,t.value.module_number,void 0,{number:!0}]])])):f("",!0),a("div",null,[e[24]||(e[24]=a("label",{for:"quiz-pass-mark",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"درجة النجاح (%) *",-1)),m(a("input",{type:"number",id:"quiz-pass-mark","onUpdate:modelValue":e[7]||(e[7]=l=>t.value.pass_mark_percentage=l),required:"",min:"0",max:"100",class:"mt-1 block w-full input-field"},null,512),[[c,t.value.pass_mark_percentage,void 0,{number:!0}]])]),a("div",null,[e[25]||(e[25]=a("label",{for:"quiz-max-attempts",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"أقصى عدد محاولات",-1)),m(a("input",{type:"number",id:"quiz-max-attempts","onUpdate:modelValue":e[8]||(e[8]=l=>t.value.max_attempts=l),min:"1",placeholder:"غير محدود",class:"mt-1 block w-full input-field"},null,512),[[c,t.value.max_attempts,void 0,{number:!0}]]),e[26]||(e[26]=a("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},"اتركه فارغًا لمحاولات غير محدودة.",-1))]),a("div",null,[e[27]||(e[27]=a("label",{for:"quiz-time-limit",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"الوقت المحدد (بالدقائق)",-1)),m(a("input",{type:"number",id:"quiz-time-limit","onUpdate:modelValue":e[9]||(e[9]=l=>t.value.time_limit_minutes=l),min:"1",class:"mt-1 block w-full input-field"},null,512),[[c,t.value.time_limit_minutes,void 0,{number:!0}]])]),a("div",null,[e[28]||(e[28]=a("label",{for:"quiz-due-date",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"تاريخ الاستحقاق (اختياري)",-1)),m(a("input",{type:"datetime-local",id:"quiz-due-date","onUpdate:modelValue":e[10]||(e[10]=l=>t.value.due_date=l),class:"mt-1 block w-full input-field"},null,512),[[c,t.value.due_date]])]),a("div",Ce,[a("div",Ve,[m(a("input",{id:"quiz-is-active",type:"checkbox","onUpdate:modelValue":e[11]||(e[11]=l=>t.value.is_active=l),class:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600"},null,512),[[Z,t.value.is_active]]),e[29]||(e[29]=a("label",{for:"quiz-is-active",class:"ml-2 block text-sm text-gray-900 dark:text-gray-300"},"الاختبار نشط ومتاح للطلاب؟",-1))])])]),r.value?(u(),i("p",he,b(r.value),1)):f("",!0),a("div",De,[a("button",{type:"submit",disabled:o.value,class:"inline-flex justify-center rounded-md border border-transparent bg-indigo-600 px-6 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50"},[o.value?(u(),O(te,{key:0,class:"w-5 h-5 text-white -ml-1 mr-2"})):f("",!0),B(" "+b(o.value?"جاري الحفظ...":z.value?"حفظ التعديلات":"إنشاء الاختبار"),1)],8,Se),a("button",{type:"button",class:"inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800",onClick:j,disabled:o.value}," إلغاء ",8,Ee)])],32)]),_:1})]),_:1})])])]),_:1})]),_:1},8,["show"]))}}),Ne=ee(Ue,[["__scopeId","data-v-60ba606a"]]);export{Ne as default};
