import{e as oe,u as de,r as d,A as ie,g as ne,l as R,k as ue,c as o,a as t,i as c,x as k,a6 as q,y as J,n as F,t as n,b as K,p as W,F as Q,j as z,d as X,v as ge,a9 as Y,a5 as ce,o as l,_ as ve}from"./CaF1xe-H.js";import{L as N}from"./CpjGp_h0.js";const ye={class:"mb-6 flex flex-wrap gap-4 items-center bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg border dark:border-gray-700"},be={class:"flex items-center gap-2"},me=["disabled"],xe={class:"flex items-center gap-2 flex-grow min-w-[200px]"},pe=["disabled"],fe=["disabled"],_e={class:"flex items-center gap-2"},ke=["disabled"],we=["disabled"],he={key:0,class:"my-4 p-3 bg-green-100 border border-green-300 text-green-700 rounded text-sm transition-opacity duration-300 ease-out"},Se={key:1,class:"my-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded text-sm transition-opacity duration-300 ease-out"},Ce={key:2,class:"my-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded relative",role:"alert"},Ee={class:"block sm:inline"},Me={key:3,class:"text-center py-10"},Le={key:4,class:"flex flex-col md:flex-row gap-6"},Te={class:"w-full md:w-2/5 lg:w-1/3 flex-shrink-0 flex flex-col"},Ve={class:"flex justify-between items-center mb-3"},De={class:"text-lg font-semibold text-gray-600 dark:text-gray-300"},Ne=["onClick"],$e={class:"text-gray-600 dark:text-gray-400 truncate text-xs mt-1"},je={class:"flex justify-between items-center mt-1.5 text-xs text-gray-400 dark:text-gray-500"},Be={key:0,class:"px-2 py-0.5 bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 rounded-full text-xs font-medium"},Ue={key:1,class:"px-2 py-0.5 bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300 rounded-full text-xs font-medium"},Ze={key:1,class:"text-sm text-center text-gray-500 dark:text-gray-400 mt-8 px-4 italic"},Ae={key:2,class:"space-y-2 p-2"},Ie={key:0,class:"mt-4 flex justify-center items-center space-x-2 rtl:space-x-reverse border-t dark:border-gray-700 pt-3"},qe=["disabled"],Fe={class:"text-sm text-gray-700 dark:text-gray-300"},Qe=["disabled"],ze={class:"flex-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow relative"},He={key:0,class:"absolute inset-0 bg-white/70 dark:bg-gray-900/70 flex items-center justify-center z-10 rounded-lg"},Oe={key:1},Pe={class:"mb-6 space-y-3 text-sm"},Ge={class:"mt-3"},Re={class:"text-gray-700 dark:text-gray-200 bg-gray-50 dark:bg-gray-700/50 p-3 rounded border dark:border-gray-600 whitespace-pre-wrap max-h-60 overflow-y-auto"},Je={class:"mb-4"},Ke=["disabled"],We={key:0,class:"mt-1 text-xs text-red-600 dark:text-red-400"},Xe={class:"mb-4"},Ye={key:0,class:"mt-1 text-sm text-gray-500"},et=["disabled"],tt=["value"],st={key:1,disabled:""},at={class:"mb-6 space-y-2"},rt={class:"flex flex-col sm:flex-row items-start sm:items-center gap-x-6 gap-y-2"},lt={class:"flex items-center"},ot=["disabled"],dt={class:"flex items-center"},it=["disabled"],nt={key:0,class:"mt-2 text-xs text-yellow-600 dark:text-yellow-400"},ut={class:"flex justify-end border-t dark:border-gray-700 pt-4"},gt=["disabled"],ct={key:2,class:"text-center py-16 text-gray-500 dark:text-gray-400"},vt={key:0,class:"mt-2 text-sm"},yt=15,bt=400,mt=oe({__name:"ask-sheikh",setup(xt){const L=de(),i=d(!0),T=d(null),b=d(null),C=d(0),E=d("pending"),V=d("asc"),p=d("");let $=null;const M=d([]),j=d(!0),u=d(1),B=d(yt),g=d(null),v=d(!1),y=d(null),w=d(null),h=d(null),H=d(null),a=ie({answer_text:"",is_public:!1,send_private:!0,category_id:null}),f=ne(()=>C.value===0?1:Math.ceil(C.value/B.value)),ee=()=>{$&&clearTimeout($),$=setTimeout(()=>{u.value!==1?u.value=1:S(1)},bt)},te=()=>{p.value=""},S=async(r=u.value)=>{var x;i.value=!0,T.value=null,Z(!1);const e=(r-1)*B.value,_=e+B.value-1;try{if(M.value.length===0&&j.value){const{data:I,error:G}=await L.from("question_categories").select("id, name").order("name");G?(console.error("Error fetching categories:",G),P("فشل تحميل تصنيفات الأسئلة.")):M.value=I||[],j.value=!1}let s=L.from("questions_to_sheikh").select(`
        id, user_id, question_text, submitted_at, is_answered, is_public,
        answer_text, category_id, answered_at,
        profiles ( full_name )
      `,{count:"exact"}).order("submitted_at",{ascending:V.value==="asc"}).range(e,_);if(E.value!=="all"){const I=E.value==="answered";s=s.eq("is_answered",I)}const m=p.value.trim();m&&(s=s.ilike("question_text",`%${m}%`));const{data:D,error:A,count:le}=await s;if(A)throw A;b.value=D||[],C.value=le??0,u.value=r,await ce(),(x=H.value)==null||x.scrollTo({top:0,behavior:"smooth"}),r>f.value&&f.value>0&&U(f.value)}catch(s){console.error("Error fetching questions:",s),T.value=s,b.value=null,C.value=0}finally{i.value=!1}},U=r=>{r>=1&&r<=f.value&&r!==u.value&&!i.value&&(u.value=r)},se=r=>{g.value=r,a.answer_text=r.answer_text||"",a.is_public=r.is_public||!1,a.send_private=!r.answered_at||!r.is_public,a.category_id=r.category_id,Z()},ae=async()=>{var r;if(!(!g.value||v.value)){if(y.value=null,!a.answer_text.trim()){y.value="نص الإجابة لا يمكن أن يكون فارغًا.";return}if(!a.is_public&&!a.send_private){y.value="يجب تحديد خيار للنشر (عام أو خاص).";return}v.value=!0,Z(!1);try{const e={answer_text:a.answer_text.trim(),answered_at:new Date().toISOString(),is_answered:!0,is_public:a.is_public,category_id:a.category_id?Number(a.category_id):null},{error:_}=await L.from("questions_to_sheikh").update(e).eq("id",g.value.id);if(_)throw new Error(`فشل تحديث السؤال: ${_.message}`);let x=!0;if(a.send_private&&g.value.user_id){const s={user_id:g.value.user_id,title:`رد على سؤالك: "${((r=g.value.question_text)==null?void 0:r.substring(0,30))??""}..."`,content:`**السؤال:**
${g.value.question_text}

**الإجابة:**
${a.answer_text.trim()}`,source:"ask_sheikh_reply",related_question_id:g.value.id},{error:m}=await L.from("user_private_messages").insert(s);m&&(console.error("Error sending private message:",m),P(`تحذير: تم حفظ الرد بنجاح، ولكن فشل إرسال الرسالة الخاصة للسائل. الخطأ: ${m.message}`),x=!1)}(x||!a.send_private)&&re("تم حفظ وإرسال الرد بنجاح."),g.value=null,a.answer_text="",a.is_public=!1,a.send_private=!0,a.category_id=null,await S(u.value)}catch(e){console.error("Error submitting reply:",e),y.value=e.message||"حدث خطأ غير متوقع أثناء إرسال الرد."}finally{v.value=!1}}},O=r=>{if(!r)return"غير محدد";try{const e=new Date(r);return isNaN(e.getTime())?"تاريخ غير صالح":e.toLocaleString("ar-EG",{dateStyle:"short",timeStyle:"short",hour12:!0})}catch{return"خطأ تنسيق"}},re=r=>{w.value=r,h.value=null,y.value=null,setTimeout(()=>{w.value=null},4e3)},P=r=>{h.value=r,w.value=null,setTimeout(()=>{h.value=null},7e3)},Z=(r=!0)=>{w.value=null,h.value=null,r&&(y.value=null)};return R([E,V,p],()=>{g.value=null,u.value!==1?u.value=1:S(1)}),R(u,r=>{S(r)}),ue(()=>{S(1)}),(r,e)=>{var _,x;return l(),o("div",null,[e[32]||(e[32]=t("h1",{class:"text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-6"},"إدارة أسئلة المستخدمين (اسأل الشيخ)",-1)),t("div",ye,[t("div",be,[e[11]||(e[11]=t("label",{for:"filter-status",class:"text-sm font-medium text-gray-700 dark:text-gray-300 flex-shrink-0"},"الحالة:",-1)),k(t("select",{id:"filter-status","onUpdate:modelValue":e[0]||(e[0]=s=>E.value=s),disabled:i.value,class:"block w-full sm:w-36 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white disabled:opacity-70"},e[10]||(e[10]=[t("option",{value:"pending"},"المعلقة",-1),t("option",{value:"answered"},"المجابة",-1),t("option",{value:"all"},"الكل",-1)]),8,me),[[q,E.value]])]),t("div",xe,[e[13]||(e[13]=t("label",{for:"search-term",class:"text-sm font-medium text-gray-700 dark:text-gray-300 flex-shrink-0"},"بحث:",-1)),k(t("input",{id:"search-term",type:"text","onUpdate:modelValue":e[1]||(e[1]=s=>p.value=s),disabled:i.value,placeholder:"ابحث في نص السؤال...",onInput:ee,class:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 disabled:opacity-70"},null,40,pe),[[J,p.value]]),p.value?(l(),o("button",{key:0,onClick:te,disabled:i.value,class:"p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 disabled:opacity-50"},e[12]||(e[12]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",fill:"currentColor",class:"w-4 h-4"},[t("path",{"fill-rule":"evenodd",d:"M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14Zm2.78-4.22a.75.75 0 0 1-1.06 1.06L8 9.06l-1.72 1.72a.75.75 0 1 1-1.06-1.06L6.94 8 5.22 6.28a.75.75 0 0 1 1.06-1.06L8 6.94l1.72-1.72a.75.75 0 1 1 1.06 1.06L9.06 8l1.72 1.78Z","clip-rule":"evenodd"})],-1)]),8,fe)):c("",!0)]),t("div",_e,[e[15]||(e[15]=t("label",{for:"sort-order",class:"text-sm font-medium text-gray-700 dark:text-gray-300 flex-shrink-0"},"ترتيب:",-1)),k(t("select",{id:"sort-order","onUpdate:modelValue":e[2]||(e[2]=s=>V.value=s),disabled:i.value,class:"block w-full sm:w-36 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white disabled:opacity-70"},e[14]||(e[14]=[t("option",{value:"asc"},"الأقدم أولاً",-1),t("option",{value:"desc"},"الأحدث أولاً",-1)]),8,ke),[[q,V.value]])]),t("button",{onClick:e[3]||(e[3]=()=>S(1)),disabled:i.value,title:"تحديث القائمة",class:"px-3 py-2 text-sm border border-gray-300 rounded-md dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 flex items-center gap-1"},[(l(),o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",fill:"currentColor",class:F(["w-4 h-4",i.value?"animate-spin":""])},e[16]||(e[16]=[t("path",{"fill-rule":"evenodd",d:"M13.836 2.477a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V5.562l-2.504 2.503a.75.75 0 0 1-1.06 0l-.47-.47a.75.75 0 0 1 0-1.061l2.503-2.503h-.938a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 .75.75Zm-2.161 7.899L9.172 7.872a.75.75 0 0 0-1.06 0l-.47.47a.75.75 0 0 0 0 1.061l2.504 2.503v.938a.75.75 0 0 0 1.5 0v-1.5a.75.75 0 0 0-.75-.75ZM2.75 4.25a.75.75 0 0 0 0 1.5h.938l2.503 2.504a.75.75 0 0 0 0 1.06l.47.471a.75.75 0 0 0 1.06 0l2.504-2.504v.938a.75.75 0 0 0 1.5 0v-1.5a.75.75 0 0 0-.75-.75h-1.5a.75.75 0 0 0 0 1.5h.938l-2.503 2.504a.75.75 0 0 1-1.06 0l-.47-.471a.75.75 0 0 1 0-1.06L6.188 5.75h.938a.75.75 0 0 0 0-1.5H2.75Z","clip-rule":"evenodd"},null,-1)]),2)),e[17]||(e[17]=t("span",{class:"hidden sm:inline"},"تحديث",-1))],8,we)]),w.value?(l(),o("div",he,n(w.value),1)):c("",!0),h.value||y.value?(l(),o("div",Se,n(h.value||y.value),1)):c("",!0),T.value?(l(),o("div",Ce,[e[18]||(e[18]=t("strong",{class:"font-bold"},"خطأ!",-1)),t("span",Ee," حدث خطأ أثناء جلب الأسئلة. الرجاء المحاولة مرة أخرى. ("+n(T.value.message)+")",1)])):c("",!0),i.value&&!b.value?(l(),o("div",Me,[K(N),e[19]||(e[19]=t("p",{class:"mt-2 text-gray-500 dark:text-gray-400"},"جارٍ تحميل الأسئلة...",-1))])):(l(),o("div",Le,[t("div",Te,[t("div",Ve,[t("h2",De," قائمة الأسئلة ("+n(C.value)+") ",1),i.value?(l(),W(N,{key:0,class:"w-4 h-4 text-indigo-500"})):c("",!0)]),t("div",{class:"flex-grow space-y-1 overflow-y-auto border dark:border-gray-700 rounded-md p-1 bg-white dark:bg-gray-800 shadow-sm min-h-[300px] max-h-[70vh]",ref_key:"questionListContainer",ref:H},[b.value&&b.value.length>0?(l(!0),o(Q,{key:0},z(b.value,s=>{var m,D;return l(),o("button",{key:s.id,onClick:A=>se(s),class:F(["block w-full text-right p-3 rounded-md transition-all duration-150 text-sm border-b border-gray-100 dark:border-gray-700/50 last:border-b-0",[((m=g.value)==null?void 0:m.id)===s.id?"bg-indigo-100 dark:bg-indigo-900/50 ring-1 ring-indigo-500 shadow-inner":"hover:bg-gray-100 dark:hover:bg-gray-700",s.is_answered?"opacity-80":"opacity-100"]])},[t("p",{class:F(["font-medium text-gray-800 dark:text-gray-100 truncate",{"!font-semibold":!s.is_answered}])},n(((D=s.profiles)==null?void 0:D.full_name)||"مستخدم غير مسجل"),3),t("p",$e,n(s.question_text),1),t("div",je,[t("span",null,n(O(s.submitted_at)),1),s.is_answered?(l(),o("span",Be,"مجاب")):(l(),o("span",Ue,"معلق"))])],10,Ne)}),128)):i.value?c("",!0):(l(),o("p",Ze,n(p.value?"لا توجد أسئلة تطابق بحثك.":"لا توجد أسئلة تطابق الفلتر الحالي."),1)),i.value&&!((_=b.value)!=null&&_.length)?(l(),o("div",Ae,[(l(),o(Q,null,z(5,s=>t("div",{key:s,class:"animate-pulse bg-gray-200 dark:bg-gray-700 h-16 rounded-md"})),64))])):c("",!0)],512),f.value>1?(l(),o("div",Ie,[t("button",{onClick:e[4]||(e[4]=s=>U(u.value-1)),disabled:u.value===1||i.value,class:"px-3 py-1 text-sm rounded border bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"}," السابق ",8,qe),t("span",Fe," صفحة "+n(u.value)+" من "+n(f.value),1),t("button",{onClick:e[5]||(e[5]=s=>U(u.value+1)),disabled:u.value===f.value||i.value,class:"px-3 py-1 text-sm rounded border bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"}," التالي ",8,Qe)])):c("",!0)]),t("div",ze,[v.value?(l(),o("div",He,[K(N,{class:"w-8 h-8 text-indigo-600"})])):c("",!0),g.value?(l(),o("div",Oe,[e[29]||(e[29]=t("h2",{class:"text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100 border-b dark:border-gray-700 pb-3"},"تفاصيل السؤال والرد",-1)),t("div",Pe,[t("p",null,[e[20]||(e[20]=t("strong",{class:"font-medium text-gray-700 dark:text-gray-300"},"السائل:",-1)),X(" "+n(((x=g.value.profiles)==null?void 0:x.full_name)||"غير معروف"),1)]),t("p",null,[e[21]||(e[21]=t("strong",{class:"font-medium text-gray-700 dark:text-gray-300"},"تاريخ الإرسال:",-1)),X(" "+n(O(g.value.submitted_at)),1)]),t("div",Ge,[e[22]||(e[22]=t("p",{class:"font-medium text-gray-700 dark:text-gray-300 mb-1"},"نص السؤال:",-1)),t("p",Re,n(g.value.question_text),1)])]),t("form",{onSubmit:ge(ae,["prevent"])},[t("div",Je,[e[23]||(e[23]=t("label",{for:"answer_text",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"نص الإجابة *",-1)),k(t("textarea",{id:"answer_text","onUpdate:modelValue":e[6]||(e[6]=s=>a.answer_text=s),rows:"8",required:"",placeholder:"اكتب ردك هنا...",class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white disabled:opacity-70",disabled:v.value},null,8,Ke),[[J,a.answer_text]]),y.value?(l(),o("p",We,n(y.value),1)):c("",!0)]),t("div",Xe,[e[25]||(e[25]=t("label",{for:"reply-category",class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"تصنيف السؤال (اختياري)",-1)),j.value?(l(),o("div",Ye,"جار تحميل التصنيفات...")):k((l(),o("select",{key:1,id:"reply-category","onUpdate:modelValue":e[7]||(e[7]=s=>a.category_id=s),class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white disabled:opacity-70",disabled:v.value},[e[24]||(e[24]=t("option",{value:null},"-- بدون تصنيف --",-1)),M.value&&M.value.length>0?(l(!0),o(Q,{key:0},z(M.value,s=>(l(),o("option",{key:s.id,value:s.id},n(s.name),9,tt))),128)):(l(),o("option",st,"-- لا توجد تصنيفات متاحة --"))],8,et)),[[q,a.category_id]])]),t("div",at,[e[28]||(e[28]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300"},"خيارات النشر:",-1)),t("div",rt,[t("div",lt,[k(t("input",{id:"is_public",type:"checkbox","onUpdate:modelValue":e[8]||(e[8]=s=>a.is_public=s),class:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600",disabled:v.value},null,8,ot),[[Y,a.is_public]]),e[26]||(e[26]=t("label",{for:"is_public",class:"ms-2 block text-sm text-gray-900 dark:text-gray-300"},"نشر الإجابة للعامة",-1))]),t("div",dt,[k(t("input",{id:"send_private",type:"checkbox","onUpdate:modelValue":e[9]||(e[9]=s=>a.send_private=s),class:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600",disabled:v.value},null,8,it),[[Y,a.send_private]]),e[27]||(e[27]=t("label",{for:"send_private",class:"ms-2 block text-sm text-gray-900 dark:text-gray-300"},"إرسال رد خاص للسائل",-1))])]),!a.is_public&&!a.send_private?(l(),o("p",nt,"تنبيه: يجب اختيار خيار واحد على الأقل (نشر عام أو إرسال خاص).")):c("",!0)]),t("div",ut,[t("button",{type:"submit",disabled:v.value||!a.is_public&&!a.send_private||!a.answer_text.trim(),class:"inline-flex justify-center rounded-md border border-transparent bg-indigo-600 px-6 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"},[v.value?(l(),W(N,{key:0,class:"w-5 h-5 text-white -ms-1 me-2"})):c("",!0),t("span",null,n(v.value?"جاري الإرسال...":"إرسال الرد"),1)],8,gt)])],32)])):(l(),o("div",ct,[e[30]||(e[30]=t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-12 h-12 mx-auto mb-4 text-gray-400"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"})],-1)),e[31]||(e[31]=t("p",null,"الرجاء اختيار سؤال من القائمة لعرض تفاصيله والرد عليه.",-1)),!i.value&&b.value&&b.value.length===0?(l(),o("p",vt,"(لا توجد أسئلة لعرضها بناءً على الفلاتر الحالية)")):c("",!0)]))])]))])}}}),_t=ve(mt,[["__scopeId","data-v-e7d7b24d"]]);export{_t as default};
