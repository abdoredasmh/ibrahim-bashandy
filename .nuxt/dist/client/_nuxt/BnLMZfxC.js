const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./PEXghgMb.js","./CaF1xe-H.js","./entry.DgcQJhFP.css","./DCq45ofR.js","./vWwLff75.js","./BookEditModal.DqDJ7RWf.css"])))=>i.map(i=>d[i]);
import{e as P,u as T,r as l,k as V,c as r,a as o,p as k,i as b,b as R,F as I,j as O,h as x,o as a,t as p,W as E,X as w,_ as U}from"./CaF1xe-H.js";import{L as j}from"./CpjGp_h0.js";const z={class:"flex justify-between items-center mb-6"},G=["disabled"],q={key:0},K={key:1},W={key:0,class:"text-center py-10"},X={key:1,class:"text-center py-10 text-gray-500 dark:text-gray-400"},H={key:2,class:"overflow-x-auto shadow ring-1 ring-black ring-opacity-5 dark:ring-gray-700 rounded-lg"},J={class:"min-w-full divide-y divide-gray-200 dark:divide-gray-700"},Q={class:"bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700"},Y={class:"table-cell font-medium text-gray-900 dark:text-white"},Z={class:"table-cell"},ee={key:0,class:"badge-blue"},te={key:1,class:"badge-yellow"},oe={key:2,class:"badge-green"},se={class:"table-cell"},ae={class:"table-cell"},re={class:"table-cell text-right font-medium space-x-2 rtl:space-x-reverse"},le=["onClick"],ne=["onClick"],de="book-files",ie=P({__name:"books",setup(ce){const B=E(()=>w(()=>import("./PEXghgMb.js"),__vite__mapDeps([0,1,2]),import.meta.url)),$=E(()=>w(()=>import("./DCq45ofR.js"),__vite__mapDeps([3,1,2,4,5]),import.meta.url)),i=T(),_=l(!1),f=l(!1),c=l(null),h=l([]),m=l(!0),u=l([]),n=l(!0);async function g(){m.value=!0;try{const{data:e,error:t}=await i.from("books").select("*").order("created_at",{ascending:!1});if(t)throw t;h.value=e||[]}catch(e){console.error("Error fetching books:",e.message),alert(`فشل تحميل قائمة الكتب: ${e.message}`)}finally{m.value=!1}}async function A(){n.value=!0;try{const{data:e,error:t}=await i.from("lessons").select("id, title").order("title",{ascending:!0});if(t)throw t;u.value=e||[]}catch(e){console.error("Error fetching lessons:",e.message)}finally{n.value=!1}}function D(e){if(!e)return null;const t=u.value.find(s=>s.id===e);return t?t.title:`درس #${e}`}function C(e){if(!e)return"-";try{return new Date(e).toLocaleDateString("ar-EG",{day:"numeric",month:"short",year:"numeric"})}catch{return"تاريخ غير صالح"}}function L(){n.value||(_.value=!0)}function v(){_.value=!1}function M(){v(),g()}function S(e){n.value||(c.value=e,f.value=!0)}function y(){f.value=!1,c.value=null}function F(){y(),g()}async function N(e){if(!confirm(`هل أنت متأكد من حذف الكتاب "${e.title}"؟ سيتم حذف الملف (${e.storage_path||"لا يوجد"}) نهائيًا ولا يمكن التراجع عن هذا الإجراء.`))return;console.log(`Attempting deletion for book ID: ${e.id}, Path: ${e.storage_path}`);const t=e.storage_path;try{console.log(`Deleting book record from DB (ID: ${e.id})`);const{error:s}=await i.from("books").delete().eq("id",e.id);if(s)throw console.error("DB Delete Error:",s),new Error(`فشل حذف سجل الكتاب من قاعدة البيانات: ${s.message}`);if(console.log("Book record deleted successfully from DB."),t){console.log(`Attempting to remove file from storage: ${t}`);const{error:d}=await i.storage.from(de).remove([t]);d?(console.error(`Storage Delete Error: Failed to delete ${t}`,d),alert(`تم حذف سجل الكتاب بنجاح، ولكن فشل حذف الملف (${t}) من التخزين. الخطأ: ${d.message}. قد تحتاج لحذفه يدويًا.`)):(console.log(`File ${t} removed successfully from storage.`),alert("تم حذف الكتاب وملفه بنجاح."))}else console.log("No storage_path found, skipping storage deletion."),alert("تم حذف سجل الكتاب بنجاح (لم يكن هناك ملف مرتبط).");g()}catch(s){console.error("Error during book deletion process:",s),alert(`حدث خطأ غير متوقع أثناء الحذف: ${s.message}`)}}return V(()=>{g(),A()}),(e,t)=>(a(),r("div",null,[o("div",z,[t[0]||(t[0]=o("h1",{class:"text-2xl font-semibold"},"إدارة الكتب والأبحاث",-1)),o("button",{onClick:L,class:"button-primary",disabled:n.value},[n.value?(a(),r("span",q,"تحميل البيانات...")):(a(),r("span",K,"إضافة كتاب/بحث جديد"))],8,G)]),m.value?(a(),r("div",W,[R(j),t[1]||(t[1]=o("p",{class:"mt-2 text-sm text-gray-500 dark:text-gray-400"},"جارٍ تحميل قائمة الكتب...",-1))])):h.value.length===0?(a(),r("div",X," لا توجد كتب أو أبحاث مضافة حتى الآن. ")):(a(),r("div",H,[o("table",J,[t[2]||(t[2]=o("thead",{class:"bg-gray-50 dark:bg-gray-800"},[o("tr",null,[o("th",{scope:"col",class:"table-header"},"العنوان"),o("th",{scope:"col",class:"table-header"},"النوع"),o("th",{scope:"col",class:"table-header"},"مرتبط بدرس"),o("th",{scope:"col",class:"table-header"},"تاريخ الإضافة"),o("th",{scope:"col",class:"relative px-6 py-3"},[o("span",{class:"sr-only"},"إجراءات")])])],-1)),o("tbody",Q,[(a(!0),r(I,null,O(h.value,s=>(a(),r("tr",{key:s.id},[o("td",Y,p(s.title),1),o("td",Z,[s.is_research?(a(),r("span",ee,"بحث")):s.is_transcript?(a(),r("span",te,"تفريغ")):(a(),r("span",oe,"كتاب"))]),o("td",se,p(D(s.linked_lesson_id)||"غير مرتبط"),1),o("td",ae,p(C(s.created_at)),1),o("td",re,[o("button",{onClick:d=>S(s),class:"text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-200"},"تعديل",8,le),o("button",{onClick:d=>N(s),class:"text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200"},"حذف",8,ne)])]))),128))])])])),_.value?(a(),k(x(B),{key:3,lessons:u.value,onClose:v,onBookAdded:M},null,8,["lessons"])):b("",!0),f.value&&c.value?(a(),k(x($),{key:4,book:c.value,lessons:u.value,onClose:y,onBookUpdated:F},null,8,["book","lessons"])):b("",!0)]))}}),_e=U(ie,[["__scopeId","data-v-051e6a69"]]);export{_e as default};
