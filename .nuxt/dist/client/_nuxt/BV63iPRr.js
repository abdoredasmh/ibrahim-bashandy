import{_ as Se}from"./CEyFpblA.js";import{e as Te,u as Ie,a1 as Ce,C as qe,r as c,a2 as Ee,k as ze,a5 as se,m as je,g as Fe,c as i,a as r,x as P,a6 as J,i as j,F as V,j as W,t as b,y as Oe,h as oe,d as le,b as ie,p as $e,o,n as ue,w as Le,_ as Ne}from"./CaF1xe-H.js";import{L as de}from"./CpjGp_h0.js";import{u as Ae}from"./C0vmt3Ib.js";var Me=typeof global=="object"&&global&&global.Object===Object&&global,Be=typeof self=="object"&&self&&self.Object===Object&&self,fe=Me||Be||Function("return this")(),Q=fe.Symbol,ye=Object.prototype,Re=ye.hasOwnProperty,Ue=ye.toString,B=Q?Q.toStringTag:void 0;function De(t){var s=Re.call(t,B),h=t[B];try{t[B]=void 0;var f=!0}catch{}var v=Ue.call(t);return f&&(s?t[B]=h:delete t[B]),v}var Pe=Object.prototype,Ve=Pe.toString;function We(t){return Ve.call(t)}var Ge="[object Null]",Qe="[object Undefined]",ce=Q?Q.toStringTag:void 0;function He(t){return t==null?t===void 0?Qe:Ge:ce&&ce in Object(t)?De(t):We(t)}function Xe(t){return t!=null&&typeof t=="object"}var Ze="[object Symbol]";function Je(t){return typeof t=="symbol"||Xe(t)&&He(t)==Ze}var Ke=/\s/;function Ye(t){for(var s=t.length;s--&&Ke.test(t.charAt(s)););return s}var et=/^\s+/;function tt(t){return t&&t.slice(0,Ye(t)+1).replace(et,"")}function ee(t){var s=typeof t;return t!=null&&(s=="object"||s=="function")}var ge=NaN,rt=/^[-+]0x[0-9a-f]+$/i,at=/^0b[01]+$/i,nt=/^0o[0-7]+$/i,st=parseInt;function ve(t){if(typeof t=="number")return t;if(Je(t))return ge;if(ee(t)){var s=typeof t.valueOf=="function"?t.valueOf():t;t=ee(s)?s+"":s}if(typeof t!="string")return t===0?t:+t;t=tt(t);var h=at.test(t);return h||nt.test(t)?st(t.slice(2),h?2:8):rt.test(t)?ge:+t}var K=function(){return fe.Date.now()},ot="Expected a function",lt=Math.max,it=Math.min;function ut(t,s,h){var f,v,g,d,l,y,m=0,q=!1,E=!1,I=!0;if(typeof t!="function")throw new TypeError(ot);s=ve(s)||0,ee(h)&&(q=!!h.leading,E="maxWait"in h,g=E?lt(ve(h.maxWait)||0,s):g,I="trailing"in h?!!h.trailing:I);function k(u){var T=f,_=v;return f=v=void 0,m=u,d=t.apply(_,T),d}function $(u){return m=u,l=setTimeout(w,s),q?k(u):d}function F(u){var T=u-y,_=u-m,R=s-T;return E?it(R,g-_):R}function C(u){var T=u-y,_=u-m;return y===void 0||T>=s||T<0||E&&_>=g}function w(){var u=K();if(C(u))return L(u);l=setTimeout(w,F(u))}function L(u){return l=void 0,I&&f?k(u):(f=v=void 0,d)}function O(){l!==void 0&&clearTimeout(l),m=0,f=y=v=l=void 0}function z(){return l===void 0?d:L(K())}function S(){var u=K(),T=C(u);if(f=arguments,v=this,y=u,T){if(l===void 0)return $(y);if(E)return clearTimeout(l),l=setTimeout(w,s),k(y)}return l===void 0&&(l=setTimeout(w,s)),d}return S.cancel=O,S.flush=z,S}const dt={class:"p-4 sm:p-6"},ct={class:"mb-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border dark:border-gray-700 shadow-sm"},gt={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"},vt=["value"],ft={key:0,disabled:""},yt={key:1,disabled:""},mt=["disabled"],pt={value:null},xt=["value"],bt={key:0,disabled:""},ht={key:1,disabled:""},kt={key:2,disabled:""},_t={class:"relative"},wt=["aria-expanded"],St={key:0,class:"absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto",id:"student-results-list",role:"listbox"},Tt={key:0,class:"px-4 py-2 text-sm text-gray-500 dark:text-gray-400"},It={key:1,role:"presentation"},Ct=["onMousedown","aria-selected"],qt={key:0,class:"px-4 py-2 text-sm text-gray-500 dark:text-gray-400"},Et={key:1,class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},zt={class:"mt-4 text-right border-t pt-4 dark:border-gray-700"},jt={key:0,class:"text-center py-10"},Ft={key:1,class:"error-box mt-6"},Ot={class:"mt-2 text-sm bg-red-100 dark:bg-red-900/50 p-2 rounded overflow-x-auto"},$t={key:2,class:"text-center py-10 bg-gray-50 dark:bg-gray-800/50 rounded-lg mt-6 border dark:border-gray-700"},Lt={class:"mt-3 font-medium text-gray-700 dark:text-gray-300"},Nt={key:3,class:"overflow-x-auto bg-white dark:bg-gray-800 shadow rounded-lg border dark:border-gray-700 mt-6"},At={class:"min-w-full divide-y divide-gray-200 dark:divide-gray-700"},Mt={class:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"},Bt={class:"px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500 dark:text-gray-400"},Rt={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300"},Ut={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300"},Dt={class:"px-6 py-4 whitespace-nowrap text-sm"},Pt={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400"},Vt={class:"px-6 py-4 whitespace-nowrap text-center text-sm font-medium"},Wt={key:1,class:"text-sm text-gray-500 dark:text-gray-400"},Y=25,G="pending_manual",Gt=Te({__name:"index",setup(t){const s=Ie(),h=Ce(),f=qe(),v=c(f.query.status||G),g=c(f.query.courseId?Number(f.query.courseId):null),d=c(f.query.quizId?Number(f.query.quizId):null),l=c(f.query.studentId||null),y=c(null),m=c(""),q=c(!1),E=c([]),I=c([]),k=c([]),$=c(!1),F=c(!1),C=c(!1),w=Ee([]),L=c(0),O=c(!1),z=c(!0),S=c(!1),u=c(null),T=c(null);let _=null;const R=async()=>{$.value=!0;try{const{data:a,error:e}=await s.from("study_courses").select("id, title").order("title");if(e)throw e;E.value=a??[]}catch(a){console.error("Error fetching courses list:",a.message)}finally{$.value=!1}},te=async a=>{if(I.value=[],d.value=null,!!a){F.value=!0;try{const{data:e,error:p}=await s.from("quizzes").select("id, title").eq("course_id",a).order("title");if(p)throw p;I.value=e??[]}catch(e){console.error(`Error fetching quizzes for course ${a}:`,e.message)}finally{F.value=!1}}},me=async a=>{if(!a||a.trim().length<2){k.value=[],C.value=!1;return}C.value=!0;try{const{data:e,error:p}=await s.from("profiles").select("id, full_name").ilike("full_name",`%${a.trim()}%`).limit(15);if(p)throw p;k.value=e??[]}catch(e){console.error("Error searching students:",e.message),k.value=[]}finally{C.value=!1}},re=ut(()=>me(m.value),350),pe=async a=>{if(!(!a||y.value))try{const{data:e,error:p}=await s.from("profiles").select("full_name").eq("id",a).maybeSingle();if(p)throw p;e?y.value=e.full_name:(console.warn(`Profile not found for initial studentId: ${a}`),l.value=null,U())}catch(e){console.error("Error fetching selected student name:",e.message)}},N=async(a=!1)=>{if(a&&(S.value=!0,u.value=null,L.value=0,w.value=[],z.value=!0,await se(),ae()),O.value||!z.value||S.value&&!a)return;a||(O.value=!0);const p=L.value*Y,n=p+Y-1;try{let x=s.from("quiz_attempts").select(`
                id,
                user_id,
                quiz_id,
                submitted_at,
                grading_status,
                quizzes ( title ),
                profiles ( id, full_name )
            `).order("submitted_at",{ascending:!1}).range(p,n);v.value&&(x=x.eq("grading_status",v.value)),d.value&&(x=x.eq("quiz_id",d.value)),l.value&&(x=x.eq("user_id",l.value));const{data:D,error:M}=await x;if(M)throw M;const Z=D??[];w.value=a?Z:[...w.value,...Z],z.value=Z.length===Y,L.value+=1}catch(x){console.error("Error loading attempts:",x),u.value=x,z.value=!1}finally{O.value=!1,a&&(S.value=!1)}},ae=()=>{_&&_.disconnect();const a={rootMargin:"0px 0px 300px 0px",threshold:0};_=new IntersectionObserver(e=>{e[0].isIntersecting&&!O.value&&z.value&&!S.value&&N()},a),T.value&&_.observe(T.value)};ze(async()=>{S.value=!0,await R(),g.value&&(await te(g.value),d.value&&!I.value.some(a=>a.id===d.value)&&(console.warn("Initial quizId from URL is not valid for the selected course. Resetting quiz filter."),d.value=null,U())),l.value&&await pe(l.value),await N(!0),se(()=>{ae()})}),je(()=>{_&&(_.disconnect(),_=null)});const xe=a=>{if(!a)return"N/A";try{return new Date(a).toLocaleString("ar-EG",{dateStyle:"medium",timeStyle:"short"})}catch(e){return console.error("Error formatting date:",e),a}},be=a=>{switch(a){case"pending_manual":return"يحتاج تصحيح يدوي";case"graded":return"تم تصحيحه";case"auto_graded":return"تم تصحيحه آلياً";case"pending":return"قيد المراجعة (آلي)";default:return"غير معروف"}},he=a=>{const e="px-2.5 py-0.5 rounded-full text-xs font-medium inline-block";switch(a){case"pending_manual":return`${e} bg-yellow-100 text-yellow-800 dark:bg-yellow-900/70 dark:text-yellow-200`;case"graded":return`${e} bg-green-100 text-green-800 dark:bg-green-900/70 dark:text-green-200`;case"auto_graded":return`${e} bg-blue-100 text-blue-800 dark:bg-blue-900/70 dark:text-blue-200`;case"pending":return`${e} bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300`;default:return`${e} bg-gray-200 text-gray-500 dark:bg-gray-600 dark:text-gray-400`}},A=()=>{U(),N(!0)},ke=async()=>{d.value=null,await te(g.value),A()},_e=a=>{l.value=a.id,y.value=a.full_name,m.value=a.full_name,q.value=!1,k.value=[],A()},H=()=>{l.value=null,y.value=null,m.value="",k.value=[],q.value=!1,A()},we=()=>{setTimeout(()=>{(!l.value||m.value!==y.value)&&(q.value=!1),m.value.trim()===""&&l.value&&H()},200)},ne=()=>{v.value=G,g.value=null,d.value=null,I.value=[],H(),U(),N(!0)},X=Fe(()=>v.value!==G||g.value!==null||d.value!==null||l.value!==null),U=()=>{h.replace({query:{status:v.value===G?void 0:v.value||void 0,courseId:g.value||void 0,quizId:d.value||void 0,studentId:l.value||void 0}}).catch(a=>{a.name!=="NavigationDuplicated"&&console.error("Router navigation error:",a)})};return Ae({title:"تصحيح الاختبارات - لوحة التحكم"}),(a,e)=>{const p=Se;return o(),i("div",dt,[e[18]||(e[18]=r("h1",{class:"text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-6"},"تصحيح الاختبارات",-1)),r("div",ct,[e[13]||(e[13]=r("h2",{class:"text-lg font-medium text-gray-700 dark:text-gray-300 mb-3"},"تصفية المحاولات",-1)),r("div",gt,[r("div",null,[e[8]||(e[8]=r("label",{for:"statusFilter",class:"block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"},"حالة التصحيح:",-1)),P(r("select",{id:"statusFilter","onUpdate:modelValue":e[0]||(e[0]=n=>v.value=n),onChange:A,class:"input-field"},e[7]||(e[7]=[r("option",{value:null},"الكل",-1),r("option",{value:"pending_manual"},"يحتاج تصحيح يدوي",-1),r("option",{value:"graded"},"تم تصحيحه",-1),r("option",{value:"auto_graded"},"تم تصحيحه آلياً",-1),r("option",{value:"pending"},"قيد المراجعة (آلي)",-1)]),544),[[J,v.value]])]),r("div",null,[e[10]||(e[10]=r("label",{for:"courseFilter",class:"block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"},"الدورة:",-1)),P(r("select",{id:"courseFilter","onUpdate:modelValue":e[1]||(e[1]=n=>g.value=n),onChange:ke,class:"input-field"},[e[9]||(e[9]=r("option",{value:null},"كل الدورات",-1)),(o(!0),i(V,null,W(E.value,n=>(o(),i("option",{key:n.id,value:n.id},b(n.title),9,vt))),128)),$.value?(o(),i("option",ft,"جارٍ تحميل الدورات...")):!$.value&&E.value.length===0?(o(),i("option",yt,"لا توجد دورات متاحة")):j("",!0)],544),[[J,g.value]])]),r("div",null,[e[11]||(e[11]=r("label",{for:"quizFilter",class:"block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"},"الاختبار:",-1)),P(r("select",{id:"quizFilter","onUpdate:modelValue":e[2]||(e[2]=n=>d.value=n),onChange:A,class:"input-field",disabled:!g.value||F.value||I.value.length===0},[r("option",pt,"كل الاختبارات "+b(g.value?"في الدورة المحددة":""),1),(o(!0),i(V,null,W(I.value,n=>(o(),i("option",{key:n.id,value:n.id},b(n.title),9,xt))),128)),F.value?(o(),i("option",bt,"جارٍ تحميل الاختبارات...")):g.value&&!F.value&&I.value.length===0?(o(),i("option",ht,"لا توجد اختبارات في هذه الدورة")):g.value?j("",!0):(o(),i("option",kt,"اختر دورة أولاً"))],40,mt),[[J,d.value]])]),r("div",_t,[e[12]||(e[12]=r("label",{for:"studentSearch",class:"block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"},"الطالب:",-1)),P(r("input",{type:"text",id:"studentSearch","onUpdate:modelValue":e[3]||(e[3]=n=>m.value=n),onInput:e[4]||(e[4]=(...n)=>oe(re)&&oe(re)(...n)),onFocus:e[5]||(e[5]=n=>q.value=!0),onBlur:we,placeholder:"ابحث بالاسم أو المعرف...",class:"input-field",autocomplete:"off","aria-autocomplete":"list","aria-expanded":q.value&&(C.value||k.value.length>0),"aria-controls":"student-results-list"},null,40,wt),[[Oe,m.value]]),q.value&&(C.value||k.value.length>0)?(o(),i("div",St,[C.value?(o(),i("div",Tt,"جارٍ البحث...")):(o(),i("ul",It,[(o(!0),i(V,null,W(k.value,n=>(o(),i("li",{key:n.id,onMousedown:x=>_e(n),role:"option","aria-selected":n.id===l.value,class:"px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-primary-50 dark:hover:bg-primary-800/50 cursor-pointer"},b(n.full_name)+" (ID: "+b(n.id.substring(0,8))+"...) ",41,Ct))),128)),k.value.length===0&&!C.value&&m.value.length>1?(o(),i("li",qt," لا توجد نتائج مطابقة. ")):j("",!0)]))])):j("",!0),l.value&&y.value?(o(),i("div",Et,[le(" الطالب المحدد: "+b(y.value)+" ",1),r("button",{onClick:H,class:"text-red-500 hover:text-red-700 ms-1 text-xxs font-medium focus:outline-none","aria-label":"إلغاء اختيار الطالب"},"(إلغاء)")])):j("",!0)])]),r("div",zt,[X.value?(o(),i("button",{key:0,onClick:ne,class:"button-secondary text-sm"}," إعادة تعيين كل الفلاتر ")):j("",!0)])]),S.value&&w.value.length===0?(o(),i("div",jt,[ie(de,{class:"w-10 h-10 text-primary"}),e[14]||(e[14]=r("p",{class:"mt-3 text-gray-500 dark:text-gray-400"},"جارٍ تحميل المحاولات...",-1))])):u.value?(o(),i("div",Ft,[e[15]||(e[15]=r("p",null,"حدث خطأ أثناء تحميل المحاولات:",-1)),r("pre",Ot,b(u.value.message),1),r("button",{onClick:e[6]||(e[6]=()=>N(!0)),class:"button-secondary mt-4"},"إعادة المحاولة")])):w.value.length===0&&!S.value?(o(),i("div",$t,[e[16]||(e[16]=r("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-12 h-12 mx-auto text-gray-400 dark:text-gray-500"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"})],-1)),r("p",Lt,b(X.value?"لا توجد محاولات تطابق معايير التصفية الحالية.":"لا توجد محاولات لعرضها."),1),X.value?(o(),i("button",{key:0,onClick:ne,class:"button-secondary text-sm mt-4"}," إلغاء الفلاتر وعرض الكل ")):j("",!0)])):(o(),i("div",Nt,[r("table",At,[e[17]||(e[17]=r("thead",{class:"bg-gray-50 dark:bg-gray-700/50"},[r("tr",null,[r("th",{scope:"col",class:"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"المعرف"),r("th",{scope:"col",class:"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"الاختبار"),r("th",{scope:"col",class:"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"الطالب"),r("th",{scope:"col",class:"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"الحالة"),r("th",{scope:"col",class:"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"تاريخ الإرسال"),r("th",{scope:"col",class:"px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"},"إجراء")])],-1)),r("tbody",Mt,[(o(!0),i(V,null,W(w.value,n=>{var x,D,M;return o(),i("tr",{key:n.id,class:"hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors duration-150 ease-in-out"},[r("td",Bt,"#"+b(n.id),1),r("td",Rt,b(((x=n.quizzes)==null?void 0:x.title)??"اختبار غير متاح"),1),r("td",Ut,b(((D=n.profiles)==null?void 0:D.full_name)??`مستخدم (${n.user_id.substring(0,8)}...)`),1),r("td",Dt,[r("span",{class:ue(he(n.grading_status))},b(be(n.grading_status)),3)]),r("td",Pt,b(xe(n.submitted_at)),1),r("td",Vt,[ie(p,{to:`/admin/grading/${n.id}`,class:ue(["font-medium transition-colors duration-150 ease-in-out px-3 py-1 rounded",n.grading_status==="pending_manual"?"text-primary-700 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300 hover:bg-primary-50 dark:hover:bg-primary-900/30":"text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700"]),"aria-label":`تصحيح أو عرض محاولة الطالب ${((M=n.profiles)==null?void 0:M.full_name)??n.user_id}`},{default:Le(()=>[le(b(n.grading_status==="pending_manual"?"بدء التصحيح":"عرض المحاولة"),1)]),_:2},1032,["to","class","aria-label"])])])}),128))])])])),r("div",{ref_key:"scrollTrigger",ref:T,class:"h-20 flex justify-center items-center mt-6"},[O.value?(o(),$e(de,{key:0,class:"w-6 h-6 text-primary"})):!z.value&&w.value.length>0&&!S.value?(o(),i("span",Wt,"وصلت إلى نهاية القائمة.")):j("",!0)],512)])}}}),Jt=Ne(Gt,[["__scopeId","data-v-361518fc"]]);export{Jt as default};
