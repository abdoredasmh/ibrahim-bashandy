import{_ as ee}from"./CEyFpblA.js";import{g as W,a2 as H,l as Q,k as J,aa as te,ab as K,e as se,u as ae,N as le,r as v,ac as re,c as a,a as e,i as I,x as O,y as oe,a6 as j,n as V,t as C,b as T,F as ne,j as ie,o as l,w as de,_ as ue}from"./CaF1xe-H.js";import{L as G}from"./CpjGp_h0.js";import{_ as ce}from"./Cjm1-dYk.js";import{n as Z,t as pe,i as ve,a as ge,b as me}from"./C6ZBagnb.js";const fe=ve?window:void 0;function $(g){var n;const y=K(g);return(n=y==null?void 0:y.$el)!=null?n:y}function xe(){const g=H(!1),n=te();return n&&J(()=>{g.value=!0},n),g}function he(g){const n=xe();return W(()=>(n.value,!!g()))}function ye(g,n,y={}){const{root:o,rootMargin:_="0px",threshold:b=0,window:u=fe,immediate:w=!0}=y,k=he(()=>u&&"IntersectionObserver"in u),f=W(()=>{const h=K(g);return ge(h).map($).filter(me)});let i=Z;const d=H(w),m=k.value?Q(()=>[f.value,$(o),d.value],([h,B])=>{if(i(),!d.value||!h.length)return;const L=new IntersectionObserver(n,{root:$(B),rootMargin:_,threshold:b});h.forEach(S=>S&&L.observe(S)),i=()=>{L.disconnect(),i=Z}},{immediate:w,flush:"post"}):Z,x=()=>{i(),m(),d.value=!1};return pe(x),{isSupported:k,isActive:d,pause(){i(),d.value=!1},resume(){d.value=!0},stop:x}}const _e={class:"container mx-auto px-4 py-6"},be={class:"mb-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border dark:border-gray-700 flex flex-wrap items-center gap-4 sticky top-0 z-10"},we={class:"flex-grow min-w-[250px] relative"},ke=["disabled"],Se=["disabled"],Me=["disabled"],Ce=["disabled"],Ee={key:0,class:"my-4 p-3 bg-red-100 ..."},Ie={class:"overflow-x-auto bg-white dark:bg-gray-800 shadow rounded-lg"},Le={class:"min-w-full divide-y divide-gray-200 dark:divide-gray-700"},Ne={class:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"},Ue={key:0},Te={colspan:"5",class:"text-center py-10"},Be={key:1},De={class:"px-6 py-4 whitespace-nowrap"},Ae={class:"flex items-center"},Oe={class:"flex-shrink-0 h-10 w-10"},Ve={class:"mr-4"},Ze={class:"text-sm font-medium text-gray-900 dark:text-gray-100"},$e={class:"text-sm text-gray-500 dark:text-gray-400"},ze={class:"sm:hidden mt-1 flex items-center gap-2 text-xs"},qe={key:0,class:"px-1.5 py-0.5 rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300"},Fe={key:1,class:"px-1.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300"},Pe={class:"px-6 py-4 whitespace-nowrap hidden sm:table-cell"},Re={class:"px-6 py-4 whitespace-nowrap hidden md:table-cell"},je={key:0,class:"px-2 ... bg-red-100 ..."},Ge={key:1,class:"px-2 ... bg-yellow-100 ..."},We={key:2,class:"px-2 ... bg-green-100 ..."},He={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 hidden lg:table-cell"},Qe={class:"px-6 py-4 whitespace-nowrap text-left text-sm font-medium rtl:text-right"},Je={key:0,class:"text-center"},Ke={key:1,class:"text-sm text-gray-500"},Xe=30,Ye=400,et=se({__name:"index",setup(g){const n=ae(),{$toast:y}=le(),o=v(!0),_=v(!1),b=v(null),u=v([]),w=v(1),k=v(Xe),f=v(!0),i=v(""),d=v("all"),m=v("all");let x=null;const h=v(null),B=()=>{x&&clearTimeout(x),x=setTimeout(()=>{D()},Ye)},L=()=>{i.value=""},S=async(c=1,t=!1)=>{t?_.value=!0:(o.value=!0,u.value=[],w.value=1,f.value=!0),b.value=null;const N=(c-1)*k.value,s=N+k.value-1;try{let r=n.from("profiles").select("*").order("created_at",{ascending:!1});d.value!=="all"&&(r=r.eq("role",d.value));const q=i.value.trim();q&&(r=r.ilike("full_name",`%${q}%`)),m.value!=="all"&&(m.value==="banned"?r=r.eq("is_banned",!0):m.value==="suspended"?r=r.gt("comment_suspended_until",new Date().toISOString()):m.value==="active"&&(r=r.eq("is_banned",!1).or(`comment_suspended_until.is.null,comment_suspended_until.lte.${new Date().toISOString()}`)));const{data:M,error:F}=await r.range(N,s);if(F)throw F;const P=(M==null?void 0:M.map(p=>p.id))??[];let R=new Map;if(P.length>0)try{const{data:p,error:E}=await n.auth.admin.listUsers({page:1,perPage:1e3});if(E)throw E;p!=null&&p.users&&p.users.filter(U=>P.includes(U.id)).forEach(U=>R.set(U.id,{email:U.email}))}catch(p){console.warn("Could not fetch auth user emails:",p.message)}const A=(M==null?void 0:M.map(p=>{var E;return{...p,auth_email:((E=R.get(p.id))==null?void 0:E.email)??null}}))??[];t?u.value.push(...A):u.value=A,f.value=A.length===k.value,f.value&&(w.value=c+1)}catch(r){console.error("Error fetching users:",r),b.value=r,t||(u.value=[]),f.value=!1}finally{o.value=!1,_.value=!1}},D=()=>{S(1,!1)},X=()=>{!o.value&&!_.value&&f.value&&S(w.value,!0)};ye(h,([{isIntersecting:c}])=>{c&&X()},{threshold:.1});const Y=c=>{if(!c)return"غير محدد";try{const t=new Date(c);return isNaN(t.getTime())?"تاريخ غير صالح":t.toLocaleString("ar-EG",{dateStyle:"medium",timeStyle:"short"})}catch{return"خطأ تنسيق"}},z=c=>{if(!c)return!1;try{return new Date(c)>new Date}catch{return!1}};return Q([d,m,i],()=>{D()}),J(()=>{S(1)}),re(()=>{x&&clearTimeout(x)}),(c,t)=>{const N=ee;return l(),a("div",_e,[t[12]||(t[12]=e("h1",{class:"text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-6"},"إدارة المستخدمين",-1)),e("div",be,[e("div",we,[t[4]||(t[4]=e("label",{for:"user-search",class:"sr-only"},"بحث",-1)),O(e("input",{id:"user-search",type:"text","onUpdate:modelValue":t[0]||(t[0]=s=>i.value=s),onInput:B,placeholder:"ابحث بالاسم أو البريد الإلكتروني...",class:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 pl-8"},null,544),[[oe,i.value]]),t[5]||(t[5]=e("div",{class:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",fill:"currentColor",class:"w-4 h-4 text-gray-400"},[e("path",{"fill-rule":"evenodd",d:"M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z","clip-rule":"evenodd"})])],-1)),i.value?(l(),a("button",{key:0,onClick:L,disabled:o.value,class:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 disabled:opacity-50 z-10"},t[3]||(t[3]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",fill:"currentColor",class:"w-4 h-4"},[e("path",{"fill-rule":"evenodd",d:"M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14Zm2.78-4.22a.75.75 0 0 1-1.06 1.06L8 9.06l-1.72 1.72a.75.75 0 1 1-1.06-1.06L6.94 8 5.22 6.28a.75.75 0 0 1 1.06-1.06L8 6.94l1.72-1.72a.75.75 0 1 1 1.06 1.06L9.06 8l1.72 1.78Z","clip-rule":"evenodd"})],-1)]),8,ke)):I("",!0)]),e("div",null,[O(e("select",{id:"role-filter","onUpdate:modelValue":t[1]||(t[1]=s=>d.value=s),disabled:o.value,class:"rounded-md ..."},t[6]||(t[6]=[e("option",{value:"all"},"كل الأدوار",-1),e("option",{value:"user"},"مستخدم",-1),e("option",{value:"admin"},"مشرف",-1)]),8,Se),[[j,d.value]])]),e("div",null,[O(e("select",{id:"status-filter","onUpdate:modelValue":t[2]||(t[2]=s=>m.value=s),disabled:o.value,class:"rounded-md ..."},t[7]||(t[7]=[e("option",{value:"all"},"كل الحالات",-1),e("option",{value:"active"},"نشط",-1),e("option",{value:"banned"},"محظور",-1),e("option",{value:"suspended"},"تعليق موقوف",-1)]),8,Me),[[j,m.value]])]),e("button",{onClick:D,disabled:o.value,title:"تحديث القائمة",class:"p-2 ..."},[(l(),a("svg",{class:V(["w-4 h-4",o.value?"animate-spin":""])},"...",2))],8,Ce)]),b.value?(l(),a("div",Ee," خطأ! "+C(b.value.message),1)):I("",!0),e("div",Ie,[e("table",Le,[t[10]||(t[10]=e("thead",{class:"bg-gray-50 dark:bg-gray-700"},[e("tr",null,[e("th",{scope:"col",class:"px-6 py-3 text-right ..."},"المستخدم"),e("th",{scope:"col",class:"px-6 py-3 text-right ... hidden sm:table-cell"},"الدور"),e("th",{scope:"col",class:"px-6 py-3 text-right ... hidden md:table-cell"},"الحالة"),e("th",{scope:"col",class:"px-6 py-3 text-right ... hidden lg:table-cell"},"تاريخ الانضمام"),e("th",{scope:"col",class:"relative px-6 py-3"},[e("span",{class:"sr-only"},"عرض التفاصيل")])])],-1)),e("tbody",Ne,[o.value&&u.value.length===0?(l(),a("tr",Ue,[e("td",Te,[T(G)])])):!o.value&&u.value.length===0?(l(),a("tr",Be,t[8]||(t[8]=[e("td",{colspan:"5",class:"text-center py-10 text-gray-500"},"لا يوجد مستخدمون يطابقون بحثك أو الفلاتر.",-1)]))):I("",!0),(l(!0),a(ne,null,ie(u.value,s=>(l(),a("tr",{key:s.id,class:"hover:bg-gray-50 dark:hover:bg-gray-700/50"},[e("td",De,[e("div",Ae,[e("div",Oe,[T(ce,{src:s.avatar_url||void 0,alt:s.full_name||"مستخدم",size:"md"},null,8,["src","alt"])]),e("div",Ve,[e("div",Ze,C(s.full_name||"لم يحدد اسم"),1),e("div",$e,C(s.auth_email||"لا يوجد بريد"),1),e("div",ze,[e("span",{class:V(["px-1.5 py-0.5 rounded-full",s.role==="admin"?"bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300":"bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300"])},C(s.role),3),s.is_banned?(l(),a("span",qe,"محظور")):z(s.comment_suspended_until)?(l(),a("span",Fe,"موقوف")):I("",!0)])])])]),e("td",Pe,[e("span",{class:V(["px-2 inline-flex text-xs leading-5 font-semibold rounded-full",s.role==="admin"?"bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300":"bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300"])},C(s.role==="admin"?"مشرف":"مستخدم"),3)]),e("td",Re,[s.is_banned?(l(),a("span",je,"محظور")):z(s.comment_suspended_until)?(l(),a("span",Ge,"تعليق موقوف")):(l(),a("span",We,"نشط"))]),e("td",He,C(Y(s.created_at)),1),e("td",Qe,[T(N,{to:`/admin/users/${s.id}`,class:"text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 group flex items-center gap-1"},{default:de(()=>t[9]||(t[9]=[e("span",null,"التفاصيل",-1),e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",fill:"currentColor",class:"w-4 h-4 transition-transform group-hover:translate-x-[-2px] rtl:group-hover:translate-x-[2px]"},[e("path",{"fill-rule":"evenodd",d:"M9.78 4.22a.75.75 0 0 1 0 1.06L7.06 8l2.72 2.72a.75.75 0 1 1-1.06 1.06L5.47 8.53a.75.75 0 0 1 0-1.06l3.25-3.25a.75.75 0 0 1 1.06 0Z","clip-rule":"evenodd"})],-1)])),_:2},1032,["to"])])]))),128))])])]),e("div",{ref_key:"loadMoreTrigger",ref:h,class:"h-20 flex items-center justify-center"},[_.value?(l(),a("div",Je,[T(G),t[11]||(t[11]=e("p",{class:"text-sm text-gray-500 mt-1"},"تحميل المزيد...",-1))])):!o.value&&u.value.length>0&&!f.value?(l(),a("div",Ke," لا يوجد المزيد من المستخدمين. ")):I("",!0)],512)])}}}),nt=ue(et,[["__scopeId","data-v-df848447"]]);export{nt as default};
